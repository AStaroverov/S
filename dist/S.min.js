!function(){"use strict";function n(n,t){try{n.trait&&(n.fn=n.trait(n.fn)),t&&(n.fn=t(n.fn)),n.value=n.fn(),z.count>0&&r(null)}finally{v=!1,m=null,g=!1,w=!1}}function t(n,t){return function(e){return n(t(e))}}function e(n){function t(){return p===r?!1:(l&&l(),o(u,this),!0)}function e(){r=p+1,v?z.add(u):i(u)}var r=0,u=new R(null),l=n(e);return function c(n){return m&&(m.trait=c,m.hold=t),n}}function i(n){try{r(n)}finally{v=!1,m=null,g=!1,w=!1}}function r(n){var t,e=0;for(v=!0,B.reset(),D.reset(),n&&(z.reset(),p++,a(n),B.run(u),D.run(d));0!==z.count;)if(t=z,z=A,A=t,z.reset(),p++,t.run(a),B.run(u),D.run(d),e++>1e5)throw new Error("Runaway frames detected")}function u(n){if(n.state===S){var t=m,e=g;m=n,g=!1,n.state=E,h(n,!1),n.value=n.fn(),n.state=x,m=t,g=e}}function o(n,t){n.emitter||(n.emitter=new q),c(n.emitter,t)}function l(n,t){n.emitter||(n.emitter=new q),c(n.emitter,t)}function c(n,t){n.index[t.id]>=0||(n.nodes[n.index[t.id]=n.count++]=t,t.sources[t.count++]=n)}function a(n){n.value=n.pending,n.pending=y,n.emitter&&f(n.emitter)}function f(n){for(var t=n.nodes,e=n.index,i=0,r=0;r<n.count;r++){var u=t[r];u&&(t[r]=null,e[u.id]=-1,u.age<p&&(u.age=p,u.hold&&u.hold()?t[e[u.id]=i++]=u:(u.state=S,B.add(u),u.children&&s(u.children),u.emitter&&f(u.emitter))))}n.count=i}function s(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=p,e.state=x,e.children&&s(e.children)}}function d(n){n.fn=null,n.trait=null,n.hold=null,n.emitter=null,h(n,!0),n.sources=null}function h(n,t){var e=n.id,i=n.sources,r=n.cleanups,u=n.children;if(r){for(var o=0;o<r.length;o++)r[o](t);n.cleanups=null}if(u){for(var o=0;o<u.length;o++)d(u[o]);n.children=null}for(var o=0;o<n.count;o++){var l=i[o];if(l){var c=l.index[e];-1!==c&&(l.nodes[c]=null,l.index[e]=-1,c===l.count-1&&l.count--),i[o]=null}}n.count=0}var p=1,v=!1,m=null,g=!1,w=!1,y={},x=0,S=1,E=2,b=function(t){var e=m,i=g,r=this instanceof j?this:null,o=new k(t,e&&e.trait);return m=o,g=!1,v?(r&&r.mod&&(o.fn=r.mod(o.fn)),o.trait&&(o.fn=o.trait(o.fn)),o.value=o.fn()):(v=!0,z.reset(),n(o,r&&r.mod)),!e||r&&r.orphan||(e.children||(e.children=[])).push(o),m=e,g=i,function(){if(w)m?D.add(o):d(o);else if(m){if(o.age===p){if(o.state===E)throw new Error("circular dependency");u(o)}g||l(o,m)}return o.value}};b.on=function F(n,t,e){function F(){return n(),i?i=!1:m&&!g?(g=!0,e=t(e),g=!1):e=t(e),e}var i=!0;return this instanceof j?this.S(F):b(F)},b.data=function(n){var t=new R(n);return function(n){if(arguments.length>0){if(v)if(t.pending!==y){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,z.add(t);else t.emitter?(t.pending=n,i(t)):t.value=n;return n}return m&&!g&&o(t,m),t.value}},b.sum=function(n){var t=new R(n);return function(e){return arguments.length>0?(v?t.pending!==y?t.pending=e(t.pending):(t.pending=e(t.value),z.add(t)):t.emitter?(t.pending=e(t.value),i(t)):t.value=e(t.value),n):(m&&!g&&o(t,m),t.value)}},b.event=function(n){var t;if(v)t=n();else{v=!0,z.reset();try{t=n(),i(null)}finally{v=!1}}return t},b.sample=function(n){var t;return m&&!g?(g=!0,t=n(),g=!1):t=n(),t};var j=function(){function n(n,e,i){this.orphan=!1,this.mod=n&&n.mod?i?t(n.mod,i):n.mod:i,this.orphan=n&&n.orphan||e}return n.prototype.async=function(t){return new n(this,!1,e(t))},n}();j.prototype.S=b,j.prototype.on=b.on,b.orphan=function(){return new j(null,!0,null)},b.async=function(n){return new j(null,!1,e(n))},b.dispose=function(n){if(w)n();else{w=!0;try{n()}finally{w=!1}}},b.cleanup=function(n){if(!m)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(m.cleanups||(m.cleanups=[])).push(n)};var C=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=this.count,i=0;e>i;i++)n(t[i]),t[i]=null;this.count=0},n}(),R=function(){function n(n){this.value=n,this.pending=y,this.emitter=null}return n}(),k=function(){function n(t,e){this.fn=t,this.trait=e,this.id=n.count++,this.value=void 0,this.age=p,this.state=x,this.hold=null,this.count=0,this.sources=[],this.emitter=null,this.children=null,this.cleanups=null}return n.count=0,n}(),q=function(){function n(){this.count=0,this.nodes=[],this.index=[]}return n}(),z=new C,A=new C,B=new C,D=new C;"object"==typeof module&&"object"==typeof module.exports?module.exports=b:"function"==typeof define?define([],function(){return b}):(eval||function(){})("this").S=b}();