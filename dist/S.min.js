!function(){"use strict";function n(n){return function(){for(var t=0;t<n.length;t++)n[t]()}}function t(n,t){return function(e){return n(t(e))}}function e(t,e){return Array.isArray(t)&&(t=n(t)),function(n){var u=!!e;return function(e){return t(),u?u=!1:(A=!0,e=n(e),A=!1),e}}}function u(n){function t(){return b===u?!1:(o&&o(),i(r,this),!0)}function e(){u=b+1,j?C.add(r):l(r)}var u=0,r=new m(null),o=n(e);return function f(n){return x&&(x.trait=f,x.hold=t),n}}function r(n,t){var e=t.id,u=n.nodes[e];u!==t&&(u!==B&&(n.ids[n.count++]=e),n.nodes[e]=t,t.sources[t.count++]=n)}function i(n,t){n.log||(n.log=new E),r(n.log,t)}function o(n,t){n.log||(n.log=new E),r(n.log,t)}function l(n){try{c(n)}finally{j=!1,x=null,A=!1,z=!1}}function f(n,t){try{n.trait&&(n.fn=n.trait(n.fn)),t&&(n.fn=t(n.fn)),n.value=n.fn(n.value),C.count>0&&c(null)}finally{j=!1,x=null,A=!1,z=!1}}function c(n){var t,e=0;for(j=!0,k.reset(),q.reset(),n&&(C.reset(),b++,a(n),k.run(h),q.run(v));0!==C.count;)if(t=C,C=R,R=t,C.reset(),b++,t.run(a),k.run(h),q.run(v),e++>1e5)throw new Error("Runaway frames detected")}function a(n){n.value=n.pending,n.pending=F,n.log&&s(n.log)}function s(n){for(var t=n.nodes,e=n.ids,u=0,r=0;r<n.count;r++){var i=e[r],o=t[i];o===B?(t[i]=D,u++):(o.age<b&&(o.age=b,o.hold&&o.hold()?o.state=G:(o.state=H,k.add(o),o.children&&d(o.children),o.log&&s(o.log))),u&&(e[r-u]=i))}u&&(n.count-=u)}function d(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=b,e.state=G,e.children&&d(e.children)}}function h(n){if(n.state===H){var t=x,e=A;x=n,A=!1,n.state=I,p(n,!1),n.value=n.fn(n.value),n.state=G,x=t,A=e}}function p(n,t){var e=n.sources,u=n.cleanups,r=n.children;if(u){for(var i=0;i<u.length;i++)u[i](t);n.cleanups=null}if(r){for(var i=0;i<r.length;i++)v(r[i]);n.children=null}for(var i=0;i<n.count;i++)e[i].nodes[n.id]=B,e[i]=null;n.count=0}function v(n){n.fn=null,n.trait=null,n.hold=null,n.log=null,p(n,!0),n.sources=null}var g=function(n,t){var e=x,u=A,r=this instanceof w?this:null,i=new y(n,e&&e.trait,t);return x=i,A=!1,j?(r&&r.mod&&(i.fn=r.mod(i.fn)),i.trait&&(i.fn=i.trait(i.fn)),i.value=i.fn(i.value)):(j=!0,C.reset(),f(i,r&&r.mod)),!e||r&&r.orphan||(e.children||(e.children=[])).push(i),x=e,A=u,function(){if(z)x?q.add(i):v(i);else if(x){if(i.age===b){if(i.state===I)throw new Error("circular dependency");h(i)}A||o(i,x)}return i.value}};g.data=function(n){var t=new m(n);return function(n){if(arguments.length>0){if(j)if(t.pending!==F){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,C.add(t);else t.log?(t.pending=n,l(t)):t.value=n;return n}return x&&!A&&i(t,x),t.value}},g.sum=function(n){var t=new m(n);return function(e){return arguments.length>0?(j?t.pending!==F?t.pending=e(t.pending):(t.pending=e(t.value),C.add(t)):t.log?(t.pending=e(t.value),l(t)):t.value=e(t.value),n):(x&&!A&&i(t,x),t.value)}},g.freeze=function(n){var t;if(j)t=n();else{j=!0,C.reset();try{t=n(),l(null)}finally{j=!1}}return t},g.sample=function(n){var t;return x&&!A?(A=!0,t=n(),A=!1):t=n(),t};var w=function(){function n(n,e,u){this.orphan=!1,this.mod=n&&n.mod?u?t(n.mod,u):n.mod:u,this.orphan=n&&n.orphan||e}return n.prototype.defer=function(t){return new n(this,!1,u(t))},n.prototype.on=function(t,u){return new n(this,!1,e(t,u))},n}();w.prototype.S=g,g.orphan=function(){return new w(null,!0,null)},g.on=function(n,t){return new w(null,!1,e(n,t))},g.defer=function(n){return new w(null,!1,u(n))},g.dispose=function(n){if(z)n();else{z=!0;try{n()}finally{z=!1}}},g.cleanup=function(n){if(!x)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(x.cleanups||(x.cleanups=[])).push(n)};var m=function(){function n(n){this.value=n,this.pending=F,this.log=null}return n}(),y=function(){function n(t,e,u){void 0===u&&(u=void 0),this.fn=t,this.trait=e,this.value=u,this.id=n.count++,this.age=b,this.state=G,this.hold=null,this.count=0,this.sources=[],this.log=null,this.children=null,this.cleanups=null}return n.count=0,n}(),E=function(){function n(){this.count=0,this.nodes=[],this.ids=[]}return n}(),S=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=this.count,u=0;e>u;u++)n(t[u]),t[u]=null;this.count=0},n}(),b=1,j=!1,x=null,A=!1,z=!1,C=new S,R=new S,k=new S,q=new S,B=new y(null,null),D=new y(null,null),F={},G=0,H=1,I=2;"object"==typeof module&&"object"==typeof module.exports?module.exports=g:"function"==typeof define?define([],function(){return g}):(eval||function(){})("this").S=g}();