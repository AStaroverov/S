!function(){"use strict";function n(n){return function(){for(var t=0;t<n.length;t++)n[t]()}}function t(n,t){return function(e){return n(t(e))}}function e(n){function t(){return E===u?!1:(l&&l(),i(o,this),!0)}function e(){u=E+1,b?C.add(o):r(o)}var u=0,o=new w(null),l=n(e);return function c(n){return j&&(j.trait=c,j.hold=t),n}}function u(n,t){var e=t.id,u=n.nodes[e];u!==t&&(u!==z&&(n.ids[n.count++]=e),n.nodes[e]=t,t.sources[t.count++]=n)}function i(n,t){n.log||(n.log=new m),u(n.log,t)}function o(n,t){n.log||(n.log=new m),u(n.log,t)}function r(n){try{c(n)}finally{b=!1,j=null,x=!1,A=!1}}function l(n,t){try{n.trait&&(n.fn=n.trait(n.fn)),t&&(n.fn=t(n.fn)),n.value=n.fn(),C.count>0&&c(null)}finally{b=!1,j=null,x=!1,A=!1}}function c(n){var t,e=0;for(b=!0,k.reset(),q.reset(),n&&(C.reset(),E++,a(n),k.run(d),q.run(p));0!==C.count;)if(t=C,C=R,R=t,C.reset(),E++,t.run(a),k.run(d),q.run(p),e++>1e5)throw new Error("Runaway frames detected")}function a(n){n.value=n.pending,n.pending=D,n.log&&f(n.log)}function f(n){for(var t=n.nodes,e=n.ids,u=0,i=0;i<n.count;i++){var o=e[i],r=t[o];r===z?(t[o]=B,u++):(r.age<E&&(r.age=E,r.hold&&r.hold()?r.state=F:(r.state=G,k.add(r),r.children&&s(r.children),r.log&&f(r.log))),u&&(e[i-u]=o))}u&&(n.count-=u)}function s(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=E,e.state=F,e.children&&s(e.children)}}function d(n){if(n.state===G){var t=j,e=x;j=n,x=!1,n.state=H,h(n,!1),n.value=n.fn(),n.state=F,j=t,x=e}}function h(n,t){var e=n.sources,u=n.cleanups,i=n.children;if(u){for(var o=0;o<u.length;o++)u[o](t);n.cleanups=null}if(i){for(var o=0;o<i.length;o++)p(i[o]);n.children=null}for(var o=0;o<n.count;o++)e[o].nodes[n.id]=z,e[o]=null;n.count=0}function p(n){n.fn=null,n.trait=null,n.hold=null,n.log=null,h(n,!0),n.sources=null}var g=function(n){var t=j,e=x,u=this instanceof v?this:null,i=new y(n,t&&t.trait);return j=i,x=!1,b?(u&&u.mod&&(i.fn=u.mod(i.fn)),i.trait&&(i.fn=i.trait(i.fn)),i.value=i.fn()):(b=!0,C.reset(),l(i,u&&u.mod)),!t||u&&u.orphan||(t.children||(t.children=[])).push(i),j=t,x=e,function(){if(A)j?q.add(i):p(i);else if(j){if(i.age===E){if(i.state===H)throw new Error("circular dependency");d(i)}x||o(i,j)}return i.value}};g.on=function I(t,e,u,i){function I(){return t(),i?i=!1:(x=!0,u=e(u),x=!1),u}return Array.isArray(t)&&(t=n(t)),i=!!i,this instanceof v?this.S(I):g(I)},g.data=function(n){var t=new w(n);return function(n){if(arguments.length>0){if(b)if(t.pending!==D){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,C.add(t);else t.log?(t.pending=n,r(t)):t.value=n;return n}return j&&!x&&i(t,j),t.value}},g.sum=function(n){var t=new w(n);return function(e){return arguments.length>0?(b?t.pending!==D?t.pending=e(t.pending):(t.pending=e(t.value),C.add(t)):t.log?(t.pending=e(t.value),r(t)):t.value=e(t.value),n):(j&&!x&&i(t,j),t.value)}},g.event=function(n){var t;if(b)t=n();else{b=!0,C.reset();try{t=n(),r(null)}finally{b=!1}}return t},g.sample=function(n){var t;return j&&!x?(x=!0,t=n(),x=!1):t=n(),t};var v=function(){function n(n,e,u){this.orphan=!1,this.mod=n&&n.mod?u?t(n.mod,u):n.mod:u,this.orphan=n&&n.orphan||e}return n.prototype.async=function(t){return new n(this,!1,e(t))},n}();v.prototype.S=g,v.prototype.on=g.on,g.orphan=function(){return new v(null,!0,null)},g.async=function(n){return new v(null,!1,e(n))},g.dispose=function(n){if(A)n();else{A=!0;try{n()}finally{A=!1}}},g.cleanup=function(n){if(!j)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(j.cleanups||(j.cleanups=[])).push(n)};var w=function(){function n(n){this.value=n,this.pending=D,this.log=null}return n}(),y=function(){function n(t,e){this.fn=t,this.trait=e,this.id=n.count++,this.value=void 0,this.age=E,this.state=F,this.hold=null,this.count=0,this.sources=[],this.log=null,this.children=null,this.cleanups=null}return n.count=0,n}(),m=function(){function n(){this.count=0,this.nodes=[],this.ids=[]}return n}(),S=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=this.count,u=0;e>u;u++)n(t[u]),t[u]=null;this.count=0},n}(),E=1,b=!1,j=null,x=!1,A=!1,C=new S,R=new S,k=new S,q=new S,z=new y(null,null),B=new y(null,null),D={},F=0,G=1,H=2;"object"==typeof module&&"object"==typeof module.exports?module.exports=g:"function"==typeof define?define([],function(){return g}):(eval||function(){})("this").S=g}();