var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};!function(){"use strict";function e(e,t,n){var r;f++,h=1;try{n&&(n(),e["static"]=!0),r=t(),h>1&&i(null)}finally{d=null,h=0}return r}function t(e){function t(){o!==f&&(s=!1,o=f+1,h?g[h++]=r:n(r))}var i,r=new _(null),s=!1,o=0;return r.emitter=new E(null),function(n){return o===f?!0:("function"==typeof i?i():s||(s=!0,i=e(t)),u(r.emitter,n),!1)}}function n(e){try{i(e)}finally{h=0,d=null,p=!1}}function i(e){var t,n,i,o=0;if(h||(h=1),e&&(f++,r(e.emitter),s(e.emitter),n=-1,i=m.length,i)){for(;++n<i;)m[n].dispose();m=[]}for(;1!==h;){for(f++,t=g,g=A,A=t,i=h,h=1,n=0;++n<i;)e=t[n],e.value=e.pending,e.pending=void 0,e.emitter&&r(e.emitter);for(n=0;++n<i;)e=t[n],e.emitter&&s(e.emitter),t[n]=null;if(n=-1,i=m.length){for(;++n<i;)m[n].dispose();m=[]}if(o++>1e5)throw new Error("Runaway frames detected")}}function r(e){var t,n,i,s=e.edges,o=-1,c=s.length;for(e.emitting=!0;++o<c;)if(t=s[o],t&&(!t.boundary||t.to.node.gate(t.to.node))){if(n=t.to,i=n.node.emitter,0!==n.marks&&n.age<f&&(n.marks=0,i&&(i.emitting=!1)),i&&i.emitting)throw new Error("circular dependency");t.marked=!0,n.marks++,n.age=f,i&&1===n.marks&&r(i)}e.emitting=!1}function s(e){for(var t,n,i=-1,r=e.edges.length;++i<r;)t=e.edges[i],t&&t.marked&&(n=t.to,t.marked=!1,n.marks--,0===n.marks&&o(n.node));r>10&&r/e.active>4&&e.compact()}function o(e){var t,n,i,r,s=e.emitter,c=e.receiver;if(e.cleanups){for(t=-1,n=e.cleanups.length;++t<n;)e.cleanups[t](!1);e.cleanups=null}if(e.children){for(t=-1,n=e.children.length;++t<n;)e.children[t].dispose();e.children=null}if(d=e,e.fn&&(e.value=e.fn()),s){for(t=-1,n=s.edges.length;++t<n;)i=s.edges[t],i&&i.marked&&(r=i.to,i.marked=!1,r.marks--,0===r.marks&&o(r.node));n>10&&n/s.active>4&&s.compact()}if(c&&!e["static"]){for(t=-1,n=c.edges.length;++t<n;)i=c.edges[t],i.active&&i.age<f&&l(i);n>10&&n/c.active>4&&c.compact()}}function c(e){function t(e){for(var n,i=-1,r=e.edges.length;++i<r;)n=e.edges[i],n&&n.marked&&(n.from.node&&n.from.node.receiver.marks?t(n.from.node.receiver):s(n.from))}var n=d;t(e),d=n}function u(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new S(t),n?a(n,e):new j(e,t.receiver,t.gate&&(null===e.node||t.gate!==e.node.gate))}function a(e,t){e.active||(e.active=!0,e.slotAge===t.edgesAge?t.edges[e.slot]=e:(e.slotAge=t.edgesAge,e.slot=t.edges.length,t.edges.push(e)),e.to.active++,t.active++,e.from=t),e.age=f}function l(e){if(e.active){var t=e.from,n=e.to;e.active=!1,t.edges[e.slot]=null,t.active--,n.active--,e.from=null}}var f=1,h=0,g=[],d=null,p=!1,m=[],v=function(t){var n=this instanceof w?this.options:null,i=d,r=n&&n.gate||i&&i.gate||null,s=new b(t,r);return!i||n&&n.toplevel||(i.children||(i.children=[])).push(s),d=s,h?(n&&n["static"]&&(n["static"](),s["static"]=!0),s.value=t()):s.value=e(s,t,n&&n["static"]),d=i,function(){return p?h?m.push(s):s.dispose():d&&s.fn&&(s.receiver&&0!==s.receiver.marks&&s.receiver.age===f&&c(s.receiver),d["static"]||(s.emitter||(s.emitter=new E(s)),u(s.emitter,d))),s.value}};v.data=function(e){var t=new _(e);return function(e){if(arguments.length>0){if(h)if(t.age===f){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=f,t.pending=e,g[h++]=t;else t.age=f,t.value=e,t.emitter&&n(t);return e}return d&&!d["static"]&&(t.emitter||(t.emitter=new E(null)),u(t.emitter,d)),t.value}};var y=function(){function e(){this.toplevel=!1,this.gate=null,this["static"]=null}return e}(),w=function(){function e(e){this.options=e}return e.prototype.S=function(e){return v.call(this,e)},e}(),k=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.prototype.async=function(e){return this.options.gate=t(e),new w(this.options)},n}(w),x=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.on=function(){function e(){for(var e=0;e<n.length;e++)n[e]()}function t(){}var n;return 0===arguments.length?this.options["static"]=t:1===arguments.length?this.options["static"]=arguments[0]:(n=Array.prototype.slice.call(arguments),this.options["static"]=e),new k(this.options)},t}(k);v.toplevel=function(){var e=new y;return e.toplevel=!0,new x(e)},v.on=function(){return x.prototype.on.apply(new x(new y),arguments)},v.async=function(e){return new k(new y).async(e)},v.event=function(e){var t;if(h)t=e();else{h=1;try{t=e(),n(null)}finally{h=0}}return t},v.dispose=function(e){if(p)e();else{p=!0;try{e()}finally{p=!1}}},v.cleanup=function(e){if(!d)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(d.cleanups||(d.cleanups=[])).push(e)};var A=[],_=function(){function e(e){this.value=e,this.age=0,this.emitter=null}return e}(),b=function(){function e(e,t){this.fn=e,this.gate=t,this["static"]=!1,this.emitter=null,this.receiver=null,this.children=null,this.cleanups=null}return e.prototype.dispose=function(){if(this.fn){var e,t,n;if(d===this&&(d=null),this.fn=null,this.gate=null,this.cleanups){for(e=-1,t=this.cleanups.length;++e<t;)this.cleanups[e](!0);this.cleanups=null}if(this.receiver)for(e=-1,t=this.receiver.edges.length;++e<t;)l(this.receiver.edges[e]);if(this.emitter)for(e=-1,t=this.emitter.edges.length;++e<t;)n=this.emitter.edges[e],n&&l(n);if(this.children)for(e=-1,t=this.children.length;++e<t;)this.children[e].dispose()}},e}(),E=function(){function e(t){this.node=t,this.id=e.count++,this.emitting=!1,this.edges=[],this.index=[],this.active=0,this.edgesAge=0}return e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=++this.edgesAge;++t<n;)e=this.edges[t],e&&(e.slot=i.length,e.slotAge=r,i.push(e));this.edges=i},e.count=0,e}(),S=function(){function e(e){this.node=e,this.id=E.count++,this.marks=0,this.age=f,this.edges=[],this.index=[],this.active=0}return e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=[];++t<n;)e=this.edges[t],e.active&&(i.push(e),r[e.from.id]=e);this.edges=i,this.index=r},e.count=0,e}(),j=function(){function e(e,t,n){this.from=e,this.to=t,this.boundary=n,this.age=f,this.active=!0,this.marked=!1,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=v:"function"==typeof define?define([],function(){return v}):(eval||function(){})("this").S=v}();