!function(){"use strict";function t(t){return function(){for(var n=0;n<t.length;n++)t[n]()}}function n(t,n){var e=t.freecount?t.freeslots[--t.freecount]:t.count++,o=n.count++;t.nodes[e]=n,t.nodeslots[e]=o,n.sources[o]=t,n.sourceslots[o]=e}function e(t,e){t.log||(t.log=w()),n(t.log,e)}function o(t,e){t.log||(t.log=w()),n(t.log,e)}function c(t,n){if(n.preclocks){if(n.preclocks.ages[t.id]===n.age)return}else n.preclocks=new j;n.preclocks.ages[t.id]=n.age,n.preclocks.clocks[n.preclocks.count++]=t}function r(t,n,e){var o=n.preclocks||(n.preclocks=new x),c=e.preclocks||(e.preclocks=new j);if(c.ages[t.id]!==e.age){c.ages[t.id]=e.age,c.uclocks[c.ucount]=n,c.uclockids[c.ucount++]=t.id;var r=o.clockcounts[t.id];r?o.clockcounts[t.id]++:(void 0===r&&(o.ids[o.count++]=t.id),o.clockcounts[t.id]=1,o.clocks[t.id]=t)}}function s(){B.subclocks.reset(),B.updates.reset(),B.subtime++;try{l(B)}finally{D=G=F=null}}function u(t){D=B,B.changes.reset(),B.subclocks.reset(),B.updates.reset();try{t.value=t.fn(t.value),(B.changes.count>0||B.subclocks.count>0||B.updates.count>0)&&(B.subtime++,l(B))}finally{D=G=F=null}}function l(t){var n=D,e=0;for(D=t,t.disposes.reset();0!==t.changes.count||0!==t.subclocks.count||0!==t.updates.count||0!==t.disposes.count;)if(e>0&&t.subtime++,t.changes.run(i),t.subclocks.run(h),t.updates.run(d),t.disposes.run(g),e++>1e5)throw new Error("Runaway clock detected");D=n}function i(t){t.value=t.pending,t.pending=z,t.log&&a(t.log)}function a(t){for(var n,e,o=t.nodes,c=t.nodeslots,r=0,s=0;s<t.count;s++){var u=o[s];if(u){var l=u.clock.time();u.age<l&&(p(u.clock),u.age=l,u.state=R,u.clock.updates.add(u),u.owned&&f(u.owned),u.log&&a(u.log)),r&&(n=s-r,e=c[s],o[s]=null,o[n]=u,c[n]=e,u.sourceslots[e]=n)}else r++}t.count-=r,t.freecount=0}function f(t){for(var n=0;n<t.length;n++){var e=t[n];e.age=e.clock.time(),e.state=C,e.owned&&f(e.owned)}}function p(t){var n=0;(t.parent&&t.age<(n=t.parent.time())||t.state===C)&&(t.parent&&(t.age=n,p(t.parent),t.parent.subclocks.add(t)),t.changes.reset(),t.subclocks.reset(),t.updates.reset(),t.state=R)}function h(t){var n=t.parent.time();if(t.age<n||t.state===R){if(t.age<n&&(t.state=C),t.preclocks)for(var e=0;e<t.preclocks.ids.length;e++){var o=t.preclocks.clocks[t.preclocks.ids[e]];o&&h(o)}t.age=n}if(t.state===q)throw new Error("clock circular reference");t.state===R&&(t.state=q,l(t),t.state=C)}function d(t){if(t.state===R){var n=G,e=F,o=D;G=F=t,D=t.clock,t.state=q,k(t,!1),t.value=t.fn(t.value),t.state=C,G=n,F=e,D=o}}function k(t,n){var e,o,c,r=t.sources,s=t.sourceslots,u=t.cleanups,l=t.owned,i=t.preclocks;if(u){for(e=0;e<u.length;e++)u[e](n);t.cleanups=null}if(l){for(e=0;e<l.length;e++)g(l[e]);t.owned=null}for(e=0;e<t.count;e++)o=r[e],c=s[e],o.nodes[c]=null,o.freeslots[o.freecount++]=c,r[e]=null;if(t.count=0,i){for(e=0;e<i.count;e++)i.clocks[e]=null;for(i.count=0,e=0;e<i.ucount;e++){var a=i.uclocks[e].preclocks,f=i.uclockids[e];0===--a.clockcounts[f]&&(a.clocks[f]=null)}i.ucount=0}}function g(t){var n=t.log;if(t.clock=null,t.fn=null,t.preclocks=null,n){t.log=null;for(var e=0;e<n.count;e++)n.nodes[e]=null;I.push(n)}k(t,!0),H.push(t)}function v(t,n,e){var o;return 0===H.length?o=new E(t,n,e):(o=H.pop(),o.age=t.time(),o.state=C,o.clock=t,o.fn=n,o.value=e),o}function w(){var t;return 0===I.length?t=new S:(t=I.pop(),t.count=0,t.freecount=0),t}var m=function(t,n){var e=G,s=D||B,l=F;if(!e)throw new Error("all computations must be created under a parent computation or root");var i=v(s,t,n);return G=F=i,D?i.value=i.fn(i.value):u(i),e!==J&&(e.owned||(e.owned=[])).push(i),G=e,F=l,function(){if(i.fn!==t)return n;if(F){for(var e=D,s=i.clock;e.depth>s.depth+1;)e=e.parent;if(e===s||e.parent===s){if(i.preclocks)for(var u=0;u<i.preclocks.count;u++){var l=i.preclocks.clocks[u];h(l)}if(i.age===i.clock.time()){if(i.state===q)throw new Error("circular dependency");d(i)}if(i.preclocks)for(var u=0;u<i.preclocks.count;u++){var l=i.preclocks.clocks[u];e===s?c(l,F):r(l,e,F)}}else{for(e.depth>s.depth&&(e=e.parent);s.depth>e.depth+1;)s=s.parent;if(s.parent===e)c(s,F);else{for(s.depth>e.depth&&(s=s.parent);e.parent!==s.parent;)e=e.parent,s=s.parent;r(s,e,F)}h(s)}o(i,F)}return n=i.value}};m.root=function K(t){var n=G,K=0===t.length?J:v(D||B,null,null),e=void 0;G=K;try{e=0===t.length?t():t(function(){D?(p(K.clock),K.clock.disposes.add(K)):g(K)})}finally{G=n}return e},m.on=function L(n,e,o,c){function L(t){var o=F;return n(),c?c=!1:(F=null,t=e(t),F=o),t}return Array.isArray(n)&&(n=t(n)),c=!!c,m(L,o)},m.data=function(t){var n=new b(D||B,t);return function(t){var o=D,u=n.clock;if(D){for(;o.depth>u.depth;)o=o.parent;for(;u.depth>o.depth&&u.parent!==o;)u=u.parent;if(u.parent!==o)for(;o.parent!==u.parent;)o=o.parent,u=u.parent;o!==u&&h(u)}var l=o===u?u:u.parent;if(arguments.length>0){if(D)if(n.pending!==z){if(t!==n.pending)throw new Error("conflicting changes: "+t+" !== "+n.pending)}else p(l),n.pending=t,l.changes.add(n);else n.log?(n.pending=t,B.changes.add(n),s()):n.value=t;return t}return F&&(e(n,F),u.parent===o?c(u,F):u!==o&&r(u,o,F)),n.value}},m.value=function(t,n){var e=m.data(t),o=D||B,c=0;return function r(s){if(0===arguments.length)return e();var u=n?n(t,s):t===s;if(!u){var l=o.time();if(c===l)throw new Error("conflicting values: "+r+" is not the same as "+t);c=l,t=s,e(s)}return s}},m.freeze=function(t){var n=void 0;if(D)n=t();else{D=B,D.changes.reset();try{n=t(),s()}finally{D=null}}return n},m.sample=function(t){var n,e=F;return e?(F=null,n=t(),F=e):n=t(),n},m.cleanup=function(t){if(!G)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(G.cleanups||(G.cleanups=[])).push(t)},m.subclock=function M(t){function M(t){var e=null,o=D;D=n,n.state=R;try{e=t(),n.subtime++,l(n)}finally{D=o}return e}var n=new y(D||B);return t?M(t):M};var y=function(){function t(n){this.parent=n,this.id=t.count++,this.state=C,this.subtime=0,this.preclocks=null,this.changes=new A,this.subclocks=new A,this.updates=new A,this.disposes=new A,n?(this.age=n.time(),this.depth=n.depth+1):(this.age=0,this.depth=0)}return t.prototype.time=function(){for(var t=this.subtime,n=this;n=n.parent;)t+=n.subtime;return t},t}();y.count=0;var b=function(){function t(t,n){this.clock=t,this.value=n,this.pending=z,this.log=null}return t}(),E=function(){function t(t,n,e){this.clock=t,this.fn=n,this.value=e,this.state=C,this.count=0,this.sources=[],this.sourceslots=[],this.log=null,this.preclocks=null,this.owned=null,this.cleanups=null,this.age=this.clock.time()}return t}(),S=function(){function t(){this.count=0,this.nodes=[],this.nodeslots=[],this.freecount=0,this.freeslots=[]}return t}(),j=function(){function t(){this.count=0,this.clocks=[],this.ages=[],this.ucount=0,this.uclocks=[],this.uclockids=[]}return t}(),x=function(){function t(){this.count=0,this.clockcounts=[],this.clocks=[],this.ids=[]}return t}(),A=function(){function t(){this.items=[],this.count=0}return t.prototype.reset=function(){this.count=0},t.prototype.add=function(t){this.items[this.count++]=t},t.prototype.run=function(t){for(var n=this.items,e=0;e<this.count;e++)t(n[e]),n[e]=null;this.count=0},t}(),z={},C=0,R=1,q=2,B=new y(null),D=null,F=null,G=null,H=[],I=[],J=v(B,null,null);"object"==typeof module&&"object"==typeof module.exports?module.exports=m:"function"==typeof define?define([],function(){return m}):(eval||function(){})("this").S=m}();