!function(){"use strict";function e(e,t){var n=-1,i=e.length;try{for(;++n<i;)e[n]()}finally{m=t}}function t(e,t,n){var r;f++,g=!0;try{r=e(n),0!==d&&i(null)}finally{m=t,g=!1,d=0}return r}function n(e){try{i(e)}finally{g=!1,d=0,m=null}}function i(e){var t,n,i,s=0;for(g=!0,e&&(f++,r(e.emitter),o(e.emitter));0!==d;){for(f++,t=h,h=y,y=t,i=d,d=0,n=-1;++n<i;)e=t[n],e.value=e.pending,e.pending=void 0,e.emitter&&r(e.emitter);for(n=-1;++n<i;)e=t[n],e.emitter&&o(e.emitter),t[n]=null;if(s++>1e5)throw new Error("Runaway frames detected")}}function r(e){var t,n,i,o=e.edges,s=-1,u=o.length;for(e.emitting=!0;++s<u;)if(t=o[s],t&&(!t.boundary||t.to.node.gate(t.to.node))){if(n=t.to,i=n.node.emitter,n.age<f&&(n.marks=0,i&&(i.emitting=!1)),i&&i.emitting)throw new Error("circular dependency");t.marked=!0,n.marks++,n.age=f,1===n.marks&&i&&r(i)}e.emitting=!1}function o(e){for(var t,n,i=-1,r=e.edges.length;++i<r;)t=e.edges[i],t&&t.marked&&(n=t.to,t.marked=!1,n.marks--,0===n.marks&&s(n.node));r>10&&r/e.active>4&&e.compact()}function s(e){var t,n,i,r,o=e.emitter,u=e.receiver;for(t=-1,n=e.cleanups.length;++t<n;)e.cleanups[t]();if(e.cleanups=[],m=e,e.value=e.fn(e.dispose),o){for(t=-1,n=o.edges.length;++t<n;)i=o.edges[t],i&&i.marked&&(r=i.to,i.marked=!1,r.marks--,0===r.marks&&s(r.node));n>10&&n/o.active>4&&o.compact()}if(null!==u&&e.listening){for(t=-1,n=u.edges.length;++t<n;)i=u.edges[t],i.active&&i.age<f&&c(i);n>10&&n/u.active>4&&u.compact()}}function u(e){for(var t,n=-1,i=e.edges.length,r=m;++n<i;)t=e.edges[n],t&&t.marked&&(t.from.node&&t.from.node.receiver.marks?u(t.from.node.receiver):(o(t.from),m=r))}function a(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new A(t),n?l(n,e):new x(e,t.receiver,t.gate&&(null===e.node||t.gate!==e.node.gate))}function l(e,t){e.active||(e.active=!0,e.slotAge===t.edgesAge?t.edges[e.slot]=e:(e.slotAge=t.edgesAge,e.slot=t.edges.length,t.edges.push(e)),e.to.active++,t.active++,e.from=t),e.age=f}function c(e){if(e.active){var t=e.from,n=e.to;e.active=!1,t.edges[e.slot]=null,t.active--,n.active--,e.from=null}}var f=1,g=!1,h=[],d=0,m=null,v=function(n){function i(){if(f){var e,t,n,i=f.receiver,r=f.emitter,o=f.cleanups,s=f.finalizers;if(m===f&&(m=null),f=null,i)for(e=-1,t=i.edges.length;++e<t;)c(i.edges[e]);if(r)for(e=-1,t=r.edges.length;++e<t;)n=r.edges[e],n&&c(n);for(e=-1,t=o.length;++e<t;)o[e]();for(e=-1,t=s.length;++e<t;)s[e]()}}var r=this instanceof p?this:null,o=m,s=g,l=r&&r._gate||o&&o.gate||null,f=new k(n,l,i);return m=f,r&&r._sources&&(e(r._sources,o),f.listening=!1),o&&(o.pinning||r&&r._pin?o.finalizers.push(i):o.cleanups.push(i)),m=f,s?(f.value=n(i),m=o):f.value=t(n,o,i),function(){return f&&(m&&m.listening&&(f.emitter||(f.emitter=new _(f)),a(f.emitter,m)),f.receiver&&0!==f.receiver.marks&&u(f.receiver),f)?f.value:void 0}};v.data=function(e){var t=new w(e);return function(e){if(arguments.length>0){if(g)if(t.age===f){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=f,t.pending=e,h[d++]=t;else t.value=e,t.emitter&&n(t);return e}return m&&m.listening&&(t.emitter||(t.emitter=new _(null)),a(t.emitter,m)),t.value}};var p=function(){function e(){this._sources=null,this._pin=!1,this._gate=null}return e.prototype.pin=function(){return this._pin=!0,this},e.prototype.gate=function(e){return this._gate=e,this},e.prototype.S=function(e){return v(e)},e}();p.prototype.S=v,v.on=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=new p;return n._sources=e,n},v.gate=function(e){return(new p).gate(e)},v.collector=function b(){function e(){r=!0,n(t),r=!1}var b,t=new w(null),i=new _(null),r=!1;return t.emitter=i,b=function(e){var t=e;return r||a(i,t),r},b.go=e,b},v.throttle=function(e){var t=v.collector(),n=0;return function(i){var r=Date.now();return t(i),r-n>e?(n=r,t.go()):setTimeout(function(){n=Date.now(),t.go()},e-(r-n)),!1}},v.debounce=function(e){var t=v.collector(),n=0,i=0;return function(r){var o=Date.now();return t(r),o>n&&(n=o,i&&clearTimeout(i),i=setTimeout(t.go,e)),!1}},v.peek=function(e){if(!m||!m.listening)return e();m.listening=!1;try{return e()}finally{m.listening=!0}},v.cleanup=function(e){if(!m)throw new Error("S.cleanup() must be called from within an S.computation.  Cannot call it at toplevel.");m.cleanups.push(e)},v.freeze=function(e){var t;if(g)t=e();else{f++,g=!0;try{t=e()}finally{g=!1}d>0&&n(null)}return t},v.pin=function(e){if(0===arguments.length)return(new p).pin();if(!m||m.pinning)return e();m.pinning=!0;try{return e()}finally{m.pinning=!1}};var y=[],w=function(){function e(e){this.age=0,this.emitter=null,this.value=e}return e}(),k=function(){function e(e,t,n){this.emitter=null,this.receiver=null,this.listening=!0,this.pinning=!1,this.cleanups=[],this.finalizers=[],this.fn=e,this.gate=t,this.dispose=n}return e}(),_=function(){function e(t){this.id=e.count++,this.emitting=!1,this.edges=[],this.index=[],this.active=0,this.edgesAge=0,this.node=t}return e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=++this.edgesAge;++t<n;)e=this.edges[t],e&&(e.slot=i.length,e.slotAge=r,i.push(e));this.edges=i},e.count=0,e}(),A=function(){function e(e){this.id=_.count++,this.marks=0,this.age=f,this.edges=[],this.index=[],this.active=0,this.node=e}return e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=[];++t<n;)e=this.edges[t],e.active&&(i.push(e),r[e.from.id]=e);this.edges=i,this.index=r},e.count=0,e}(),x=function(){function e(e,t,n){this.age=f,this.active=!0,this.marked=!1,this.from=e,this.to=t,this.boundary=n,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=v:"function"==typeof define?define([],function(){return v}):(eval||function(){})("this").S=v}();