!function(){"use strict";function e(e,t){var n=-1,i=e.length;try{for(;++n<i;)e[n]()}finally{r=t}}function t(e,t){var n;try{n=e(),0!==s.len&&s.run(null)}finally{r=t,s.frozen=!1,s.len=0}return n}function n(){return this()}var i=1,r=null,s=null,o=function(o){function u(){if(v){var e,t,n=v,i=n.receiver,s=n.cleanups;if(v=null,r===n&&(r=null),i)for(e=-1,t=i.edges.length;++e<t;)i.edges[e].deactivate();for(n.cleanups=[],e=-1,t=s.length;++e<t;)s[e]();for(e=-1,t=n.finalizers.length;++e<t;)n.finalizers[e]();n.value=null,n.fn=null,n.finalizers=null,n.receiver=null,n.emitter=null}}var h,f=this instanceof a?this:null,g=r,d=s.frozen,p=f&&f._gate||g&&g.gate||null,v=new l(o,p);return r=v,f&&f._sources&&(e(f._sources,g),v.listening=!1),g&&(g.pinning||f&&f._pin?g.finalizers.push(u):g.cleanups.push(u)),r=v,d?(v.value=o(),r=g):(i++,s.frozen=!0,v.value=t(o,g)),h=function(){return v&&(r&&r.listening&&(v.emitter||(v.emitter=new c(v)),v.emitter.addEdge(r)),v.receiver&&0!==v.receiver.marks&&v.receiver.backtrack(),v)?v.value:void 0},h.dispose=u,h.toJSON=n,h};o.data=function d(e){var d,t=new h(e);return t.value=e,d=function(e){return arguments.length>0?s.change(t,e):r&&r.listening&&(t.emitter||(t.emitter=new c(null)),t.emitter.addEdge(r)),t.value},d.toJSON=n,d};var a=function(){function e(){this._sources=null,this._pin=!1,this._gate=null}return e.prototype.pin=function(){return this._pin=!0,this},e.prototype.gate=function(e){return this._gate=e,this},e.prototype.S=function(e){return o(e)},e}();a.prototype.S=o,o.on=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=new a;return n._sources=e,n},o.gate=function(e){return(new a).gate(e)},o.collector=function p(){function e(){i=!0,s.enter(t),i=!1}var p,t=new h(null),n=t.emitter=new c(null),i=!1;return p=function(e){var t=e;return i||n.addEdge(t),i},p.go=e,p},o.throttle=function(e){var t=o.collector(),n=0;return function(i){var r=Date.now();return t(i),r-n>e?(n=r,t.go()):setTimeout(function(){n=Date.now(),t.go()},e-(r-n)),!1}},o.debounce=function(e){var t=o.collector(),n=0,i=0;return function(r){var s=Date.now();return t(r),s>n&&(n=s,i&&clearTimeout(i),i=setTimeout(t.go,e)),!1}},o.peek=function(e){if(!r||!r.listening)return e();r.listening=!1;try{return e()}finally{r.listening=!0}},o.cleanup=function(e){if(!r)throw new Error("S.cleanup() must be called from within an S.computation.  Cannot call it at toplevel.");r.cleanups.push(e)},o.freeze=function(e){var t;if(s.frozen)t=e();else{i++,s.frozen=!0;try{t=e()}finally{s.frozen=!1}s.len>0&&s.enter(null)}return t},o.pin=function(e){if(0===arguments.length)return(new a).pin();if(!r||r.pinning)return e();r.pinning=!0;try{return e()}finally{r.pinning=!1}};var u=function(){function e(){this.len=0,this.frozen=!1,this.changes=[],this.changes2=[]}return e.prototype.change=function(e,t){if(this.frozen)if(e.age===i){if(t!==e.pending)throw new Error("conflicting changes: "+t+" !== "+e.pending)}else e.age=i,e.pending=t,this.changes[this.len]=e,this.len++;else e.value=t,e.emitter&&this.enter(e)},e.prototype.enter=function(e){try{this.run(e)}finally{this.frozen=!1,this.len=0,r=null}},e.prototype.run=function(e){var t,n,r,s=0;for(this.frozen=!0,e&&(i++,e.emitter.mark(),e.emitter.propagate());0!==this.len;){for(i++,t=this.changes,this.changes=this.changes2,this.changes2=t,r=this.len,this.len=0,n=-1;++n<r;)e=t[n],e.value=e.pending,e.pending=void 0,e.emitter&&e.emitter.mark();for(n=-1;++n<r;)e=t[n],e.emitter&&e.emitter.propagate(),t[n]=null;if(s++>1e5)throw new Error("Runaway frames detected")}},e}(),h=function(){function e(e){this.age=0,this.value=void 0,this.pending=void 0,this.emitter=null,this.value=e}return e}(),l=function(){function e(e,t){this.value=void 0,this.emitter=null,this.receiver=null,this.listening=!0,this.pinning=!1,this.cleanups=[],this.finalizers=[],this.fn=e,this.gate=t}return e.prototype.update=function(){var e,t,n,s=this.cleanups;for(this.cleanups=[],e=-1,t=s.length;++e<t;)s[e]();if(r=this,this.fn&&(this.value=this.fn()),this.emitter&&this.emitter.propagate(),this.receiver&&this.listening){for(e=-1,t=this.receiver.edges.length;++e<t;)n=this.receiver.edges[e],n.active&&n.age<i&&n.deactivate();t>10&&t/this.receiver.active>4&&this.receiver.compact()}},e}(),c=function(){function e(t){this.id=e.count++,this.emitting=!1,this.edges=[],this.index=[],this.active=0,this.edgesAge=0,this.node=t}return e.prototype.addEdge=function(e){var t=null;e.receiver?t=e.receiver.index[this.id]:e.receiver=new f(e),t?t.activate(this):new g(this,e.receiver,e.gate&&(null===this.node||e.gate!==this.node.gate))},e.prototype.mark=function(){var e,t,n,r=this.edges,s=-1,o=r.length;for(this.emitting=!0;++s<o;)if(e=r[s],e&&(!e.boundary||e.to.node.gate(e.to.node))){if(t=e.to,n=t.node.emitter,t.age<i&&(t.marks=0,n&&(n.emitting=!1)),n&&n.emitting)throw new Error("circular dependency");e.marked=!0,t.marks++,t.age=i,1===t.marks&&n&&n.mark()}this.emitting=!1},e.prototype.propagate=function(){for(var e,t,n=-1,i=this.edges.length;++n<i;)e=this.edges[n],e&&e.marked&&(t=e.to,e.marked=!1,t.marks--,0===t.marks&&t.node.update());i>10&&i/this.active>4&&this.compact()},e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=++this.edgesAge;++t<n;)e=this.edges[t],e&&(e.slot=i.length,e.slotAge=r,i.push(e));this.edges=i},e.count=0,e}(),f=function(){function e(e){this.id=c.count++,this.marks=0,this.age=i,this.edges=[],this.index=[],this.active=0,this.node=e}return e.prototype.backtrack=function(){for(var e,t=-1,n=this.edges.length,i=r;++t<n;)e=this.edges[t],e&&e.marked&&(e.from.node&&e.from.node.receiver.marks?e.from.node.receiver.backtrack():(e.from.propagate(),r=i))},e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=[];++t<n;)e=this.edges[t],e.active&&(i.push(e),r[e.from.id]=e);this.edges=i,this.index=r},e.count=0,e}(),g=function(){function e(e,t,n){this.age=i,this.active=!0,this.marked=!1,this.from=e,this.to=t,this.boundary=n,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e.prototype.activate=function(e){this.active||(this.active=!0,this.slotAge===e.edgesAge?e.edges[this.slot]=this:(this.slotAge=e.edgesAge,this.slot=e.edges.length,e.edges.push(this)),this.to.active++,e.active++,this.from=e),this.age=i},e.prototype.deactivate=function(){if(this.active){var e=this.from,t=this.to;this.active=!1,e.edges[this.slot]=null,e.active--,t.active--,this.from=null}},e}();s=new u,"object"==typeof module&&"object"==typeof module.exports?module.exports=o:"function"==typeof define?define([],function(){return o}):(eval||function(){})("this").S=o}();