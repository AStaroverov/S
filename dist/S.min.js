!function(){"use strict";function n(n,t){return function(e){return n(t(e))}}function t(n){function t(){return S===i?!1:(l&&l(),u(r,this),!0)}function e(){i=S+1,E?C.add(r):o(r)}var i=0,r=new v(null),l=n(e);return function c(n){return b&&(b.trait=c,b.hold=t),n}}function e(n,t){var e=t.id,u=n.nodes[e];u!==t&&(u!==z&&(n.ids[n.count++]=e),n.nodes[e]=t,t.sources[t.count++]=n)}function u(n,t){n.log||(n.log=new m),e(n.log,t)}function i(n,t){n.log||(n.log=new m),e(n.log,t)}function o(n){try{l(n)}finally{E=!1,b=null,j=!1,x=!1}}function r(n,t){try{n.trait&&(n.fn=n.trait(n.fn)),t&&(n.fn=t(n.fn)),n.value=n.fn(),C.count>0&&l(null)}finally{E=!1,b=null,j=!1,x=!1}}function l(n){var t,e=0;for(E=!0,k.reset(),q.reset(),n&&(C.reset(),S++,c(n),k.run(s),q.run(h));0!==C.count;)if(t=C,C=R,R=t,C.reset(),S++,t.run(c),k.run(s),q.run(h),e++>1e5)throw new Error("Runaway frames detected")}function c(n){n.value=n.pending,n.pending=B,n.log&&a(n.log)}function a(n){for(var t=n.nodes,e=n.ids,u=0,i=0;i<n.count;i++){var o=e[i],r=t[o];r===z?(t[o]=A,u++):(r.age<S&&(r.age=S,r.hold&&r.hold()?r.state=D:(r.state=F,k.add(r),r.children&&f(r.children),r.log&&a(r.log))),u&&(e[i-u]=o))}u&&(n.count-=u)}function f(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=S,e.state=D,e.children&&f(e.children)}}function s(n){if(n.state===F){var t=b,e=j;b=n,j=!1,n.state=G,d(n,!1),n.value=n.fn(),n.state=D,b=t,j=e}}function d(n,t){var e=n.sources,u=n.cleanups,i=n.children;if(u){for(var o=0;o<u.length;o++)u[o](t);n.cleanups=null}if(i){for(var o=0;o<i.length;o++)h(i[o]);n.children=null}for(var o=0;o<n.count;o++)e[o].nodes[n.id]=z,e[o]=null;n.count=0}function h(n){n.fn=null,n.trait=null,n.hold=null,n.log=null,d(n,!0),n.sources=null}var p=function(n){var t=b,e=j,u=this instanceof g?this:null,o=new w(n,t&&t.trait);return b=o,j=!1,E?(u&&u.mod&&(o.fn=u.mod(o.fn)),o.trait&&(o.fn=o.trait(o.fn)),o.value=o.fn()):(E=!0,C.reset(),r(o,u&&u.mod)),!t||u&&u.orphan||(t.children||(t.children=[])).push(o),b=t,j=e,function(){if(x)b?q.add(o):h(o);else if(b){if(o.age===S){if(o.state===G)throw new Error("circular dependency");s(o)}j||i(o,b)}return o.value}};p.on=function H(n,t,e){function H(){return n(),u?u=!1:b&&!j?(j=!0,e=t(e),j=!1):e=t(e),e}var u=!0;return this instanceof g?this.S(H):p(H)},p.data=function(n){var t=new v(n);return function(n){if(arguments.length>0){if(E)if(t.pending!==B){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,C.add(t);else t.log?(t.pending=n,o(t)):t.value=n;return n}return b&&!j&&u(t,b),t.value}},p.sum=function(n){var t=new v(n);return function(e){return arguments.length>0?(E?t.pending!==B?t.pending=e(t.pending):(t.pending=e(t.value),C.add(t)):t.log?(t.pending=e(t.value),o(t)):t.value=e(t.value),n):(b&&!j&&u(t,b),t.value)}},p.event=function(n){var t;if(E)t=n();else{E=!0,C.reset();try{t=n(),o(null)}finally{E=!1}}return t},p.sample=function(n){var t;return b&&!j?(j=!0,t=n(),j=!1):t=n(),t};var g=function(){function e(t,e,u){this.orphan=!1,this.mod=t&&t.mod?u?n(t.mod,u):t.mod:u,this.orphan=t&&t.orphan||e}return e.prototype.async=function(n){return new e(this,!1,t(n))},e}();g.prototype.S=p,g.prototype.on=p.on,p.orphan=function(){return new g(null,!0,null)},p.async=function(n){return new g(null,!1,t(n))},p.dispose=function(n){if(x)n();else{x=!0;try{n()}finally{x=!1}}},p.cleanup=function(n){if(!b)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(b.cleanups||(b.cleanups=[])).push(n)};var v=function(){function n(n){this.value=n,this.pending=B,this.log=null}return n}(),w=function(){function n(t,e){this.fn=t,this.trait=e,this.id=n.count++,this.value=void 0,this.age=S,this.state=D,this.hold=null,this.count=0,this.sources=[],this.log=null,this.children=null,this.cleanups=null}return n.count=0,n}(),m=function(){function n(){this.count=0,this.nodes=[],this.ids=[]}return n}(),y=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=this.count,u=0;e>u;u++)n(t[u]),t[u]=null;this.count=0},n}(),S=1,E=!1,b=null,j=!1,x=!1,C=new y,R=new y,k=new y,q=new y,z=new w(null,null),A=new w(null,null),B={},D=0,F=1,G=2;"object"==typeof module&&"object"==typeof module.exports?module.exports=p:"function"==typeof define?define([],function(){return p}):(eval||function(){})("this").S=p}();