!function(){"use strict";function n(n){return function(){for(var t=0;t<n.length;t++)n[t]()}}function t(n,t){var e=t.id,o=n.nodes[e];o!==t&&(o!==S&&(n.ids[n.count++]=e),n.nodes[e]=t,t.sources[t.count++]=n)}function e(n,e){n.log||(n.log=new w),t(n.log,e)}function o(n,e){n.log||(n.log=new w),t(n.log,e)}function u(n,t){try{r(n,t)}finally{k=E=b=null}}function i(n){try{n.value=n.fn(n.value),n.clock.changes.count>0&&r(n.clock,null)}finally{k=E=b=null}}function r(n,t){var e=0;for(k=n,n.updates.reset(),n.disposes.reset(),t&&(n.changes.reset(),n.time++,l(t),n.updates.run(a),n.disposes.run(d));0!==n.changes.count;)if(n.time++,n.changes.run(l),n.updates.run(a),n.disposes.run(d),e++>1e5)throw new Error("Runaway frames detected")}function l(n){n.value=n.pending,n.pending=x,n.log&&c(n.log)}function c(n){for(var t=n.nodes,e=n.ids,o=0,u=0;u<n.count;u++){var i=e[u],r=t[i];r===S?(t[i]=j,o++):(r.age<r.clock.time&&(r.age=r.clock.time,r.state=z,r.clock.updates.add(r),r.owned&&s(r.owned),r.log&&c(r.log)),o&&(e[u-o]=i))}o&&(n.count-=o)}function s(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=e.clock.time,e.state=A,e.owned&&s(e.owned)}}function a(n){if(n.state===z){var t=E,e=b;E=b=n,n.state=C,f(n,!1),n.value=n.fn(n.value),n.state=A,E=t,b=e}}function f(n,t){var e=n.sources,o=n.cleanups,u=n.owned;if(o){for(var i=0;i<o.length;i++)o[i](t);n.cleanups=null}if(u){for(var i=0;i<u.length;i++)d(u[i]);n.owned=null}for(var i=0;i<n.count;i++)e[i].nodes[n.id]=S,e[i]=null;n.count=0}function d(n){n.fn=null,n.log=null,f(n,!0)}var h=function(n,t){var e=E,u=k||y,r=b;if(!e)throw new Error("all computations must be created under a parent computation or root");var l=new v(u,n,t);return E=b=l,k?l.value=l.fn(l.value):(k=u,u.changes.reset(),i(l)),(e.owned||(e.owned=[])).push(l),E=e,b=r,function(){if(E){if(l.age===l.clock.time){if(l.state===C)throw new Error("circular dependency");a(l)}b&&o(l,b)}return l.value}};h.root=function R(n){function t(){k?k.disposes.add(R):d(R)}var e=E,R=new v(k||y,null,null);E=R;try{return n(t)}finally{E=e}},h.on=function q(t,e,o,u){function q(n){var o=b;return t(),u?u=!1:(b=null,n=e(n),b=o),n}return Array.isArray(t)&&(t=n(t)),u=!!u,h(q,o)},h.data=function(n){var t=new g(E?E.clock:y,n);return function(n){if(arguments.length>0){if(k)if(t.pending!==x){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,k.changes.add(t);else t.log?(t.pending=n,u(y,t)):t.value=n;return n}return b&&e(t,b),t.value}},h.value=function(n,t){var e=h.data(n),o=k||y,u=0;return function i(r){if(0===arguments.length)return e();var l=t?t(n,r):n===r;if(!l){if(u===o.time)throw new Error("conflicting values: "+i+" is not the same as "+n);u=o.time,n=r,e(r)}return r}},h.freeze=function(n){var t;if(k)t=n();else{k=y,k.changes.reset();try{t=n(),u(y,null)}finally{k=null}}return t},h.sample=function(n){var t,e=b;return e?(b=null,t=n(),b=e):t=n(),t},h.cleanup=function(n){if(!E)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(E.cleanups||(E.cleanups=[])).push(n)};var p=function(){function n(){this.time=0,this.changes=new m,this.updates=new m,this.disposes=new m}return n}(),g=function(){function n(n,t){this.clock=n,this.value=t,this.pending=x,this.log=null}return n}(),v=function(){function n(t,e,o){this.clock=t,this.fn=e,this.value=o,this.id=n.count++,this.state=A,this.count=0,this.sources=[],this.log=null,this.owned=null,this.cleanups=null,this.age=this.clock.time}return n}();v.count=0;var w=function(){function n(){this.count=0,this.nodes=[],this.ids=[]}return n}(),m=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=this.count,o=0;o<e;o++)n(t[o]),t[o]=null;this.count=0},n}(),y=new p,k=null,E=null,b=null,S=new v(y,null,null),j=new v(y,null,null),x={},A=0,z=1,C=2;"object"==typeof module&&"object"==typeof module.exports?module.exports=h:"function"==typeof define?define([],function(){return h}):(eval||function(){})("this").S=h}();