!function(){"use strict";function e(e){var t;c++,f=1;try{t=e.fn(),f>1&&i(null)}finally{g=null,p=!1,f=0}return t}function t(e){function t(){n(!0)}var n=k.data(!1),i=e(t);return function r(e){var t=!0;return g&&(g.trait=r),function(){return t?(t=!1,e()):k.sample(n)?(n(!1),e()):(n(),i&&i(),k.hold())}}}function n(e){try{i(e)}finally{f=0,g=null,p=!1,v=!1}}function i(e){var t,n,i,o=0;if(f||(f=1),e&&(c++,u(r,e.emitter),h(s,e.emitter),m.length)){for(n=0;n<m.length;n++)m[n].dispose();m=[]}for(;1!==f;){for(c++,t=d,d=x,x=t,i=f,f=1,n=1;i>n;n++)e=t[n],e.value=e.pending,e.pending=void 0,u(r,e.emitter);for(n=1;i>n;n++)e=t[n],h(s,e.emitter),t[n]=null;if(m.length){for(n=0;n<m.length;n++)m[n].dispose();m=[]}if(o++>1e5)throw new Error("Runaway frames detected")}}function r(e){var t=e.children;if(e.age===c){if(e.emitter&&e.emitter.emitting)throw new Error("circular dependency");e.marks++}else{if(e.age=c,e.marks=1,e.updates=0,t)for(var n=0;n<t.length;n++)r(t[n]);u(r,e.emitter)}}function s(e){if(e.updates++,e.marks==e.updates){var t=e.receiver;g=e,e.cleanup(!1);var n=e.fn();if(n!==y){if(e.value=n,h(s,e.emitter),t){for(var i=0;i<t.edges.length;i++){var r=t.edges[i];r.from&&r.age<c&&r.deactivate()}t.fragmented()&&t.compact()}}else h(o,e.emitter)}}function o(e){if(e.marks--,e.marks===e.updates)if(e.marks>0)s(e);else if(h(o,e.emitter),e.children)for(var t=0;t<e.children.length;t++)o(e.children[t])}function a(e){function t(e){for(var n=e.receiver.edges,i=0;i<n.length;i++){var r=n[i];if(r.marked){var o=r.from.node;o?o.marks===o.updates?s(o):t(o):h(s,r.from)}}}var n=g,i=p;p=!1,t(e),g=n,p=i}function u(e,t){if(t){var n=t.edges;t.emitting=!0;for(var i=0;i<n.length;i++){var r=n[i];r&&(r.marked=!0,e(r.to.node))}t.emitting=!1}}function h(e,t){if(t){var n=t.edges;t.emitting=!0;for(var i=0;i<n.length;i++){var r=n[i];r&&r.marked&&(r.marked=!1,e(r.to.node))}t.emitting=!1}}function l(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new j(t),n?n.activate(e):new C(e,t.receiver)}var c=1,f=0,d=[],g=null,p=!1,v=!1,m=[],y={},w=!1,k=function(t){var n=g,i=p,r=new S;g=r,p=!1,w=!1,n&&n.trait&&(t=n.trait(t)),r.fn=this instanceof A?this.mod(t):t,n&&!w&&(n.children||(n.children=[])).push(r);var s=f?r.fn():e(r);return s!==y&&(r.value=s),g=n,p=i,function(){return v?f?m.push(r):r.dispose():g&&r.fn&&(r.age===c&&r.marks!==r.updates&&a(r),p||(r.emitter||(r.emitter=new b(r)),l(r.emitter,g))),r.value}};k.on=function R(e,t,n){function R(){return e(),i?i=!1:g&&!p?(p=!0,n=t(n),p=!1):n=t(n),n}var i=!0;return k(R)},k.data=function(e){var t=new E(e);return function(e){if(arguments.length>0){if(f)if(t.age===c){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=c,t.pending=e,d[f++]=t;else t.age=c,t.value=e,t.emitter&&n(t);return e}return g&&!p&&(t.emitter||(t.emitter=new b(null)),l(t.emitter,g)),t.value}},k.sum=function(e){var t=new E(e);return function(i){return arguments.length>0?(f?t.age===c?t.pending=i(t.pending):(t.age=c,t.pending=i(t.value),d[f++]=t):(t.age=c,t.value=i(t.value),t.emitter&&n(t)),e):(g&&!p&&(t.emitter||(t.emitter=new b(null)),l(t.emitter,g)),t.value)}},k.event=function(e){var t;if(f)t=e();else{f=1;try{t=e(),n(null)}finally{f=0}}return t},k.sample=function(e){var t;return g&&!p?(p=!0,t=e(),p=!1):t=e(),t},k.hold=function(){return y};var A=function(){function e(e,t){this.mod=e?compose(e.mod,t):t}return e.prototype.async=function(n){return new e(this,t(n))},e}();A.prototype.S=k,A.prototype.on=k.on,k.orphan=function(){return new A(null,function(e){return w=!0,e})},k.async=function(e){return new A(null,t(e))},k.dispose=function(e){if(v)e();else{v=!0;try{e()}finally{v=!1}}},k.cleanup=function(e){if(!g)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(g.cleanups||(g.cleanups=[])).push(e)};var x=[],E=function(){function e(e){this.value=e,this.age=0,this.emitter=null}return e}(),S=function(){function e(){this.age=c,this.marks=0,this.updates=0,this.emitter=null,this.receiver=null,this.children=null,this.cleanups=null}return e.prototype.dispose=function(){this.fn&&(this.fn=null,this.trait=null,this.age===c&&this.marks!==this.updates&&h(o,this.emitter),this.cleanup(!0),this.receiver&&this.receiver.detach(),this.emitter&&this.emitter.detach())},e.prototype.cleanup=function(e){if(this.children){for(var t=0;t<this.children.length;t++)this.children[t].dispose();this.children=null}if(this.cleanups){for(t=0;t<this.cleanups.length;t++)this.cleanups[t](e);this.cleanups=null}},e}(),b=function(){function e(t){this.node=t,this.id=e.count++,this.emitting=!1,this.edges=[],this.active=0,this.edgesAge=0}return e.prototype.detach=function(){for(var e=0;e<this.edges.length;e++){var t=this.edges[e];t&&t.deactivate()}},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e=[],t=++this.edgesAge,n=0;n<this.edges.length;n++){var i=this.edges[n];i&&(i.slot=e.length,i.slotAge=t,e.push(i))}this.edges=e},e.count=0,e}(),j=function(){function e(e){this.node=e,this.id=b.count++,this.edges=[],this.index=[],this.active=0}return e.prototype.detach=function(){for(var e=0;e<this.edges.length;e++)this.edges[e].deactivate()},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e=[],t=[],n=0;n<this.edges.length;n++){var i=this.edges[n];i.from&&(e.push(i),t[i.from.id]=i)}this.edges=e,this.index=t},e.count=0,e}(),C=function(){function e(e,t){this.from=e,this.to=t,this.age=c,this.marked=!1,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e.prototype.activate=function(e){this.from||(this.from=e,this.slotAge===e.edgesAge?e.edges[this.slot]=this:(this.slotAge=e.edgesAge,this.slot=e.edges.length,e.edges.push(this)),this.to.active++,e.active++),this.age=c},e.prototype.deactivate=function(){if(this.from){var e=this.from,t=this.to;this.from=null,e.edges[this.slot]=null,e.active--,t.active--}},e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=k:"function"==typeof define?define([],function(){return k}):(eval||function(){})("this").S=k}();