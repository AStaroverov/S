!function(){"use strict";function t(){return this()}function n(t,n){var e=i,o=null;e&&e.listening&&(e.receiver?o=e.receiver.inboundIndex[t.id]:e.receiver=new h(e),o?o.activate(t):new f(t,e.receiver,e.gate&&e.gate!==n))}function e(t){t.marks=0,t.updating=!1,t.cur=0;for(var n,i=-1,o=t.outbound?t.outbound.length:0;++i<o;)n=t.outbound[i],n&&(n.marked||n.to.updating)&&(n.marked=!1,e(n.to))}var i=null,o=null,r=function(e){function r(){if(v){var t,n,e=v,o=e.receiver;if(v=null,i===e&&(i=null),o)for(t=-1,n=o.inbound.length;++t<n;)o.inbound[t].deactivate();for(e.cleanup(),t=-1,n=e.finalizers.length;++t<n;)e.finalizers[t]();e.value=null,e.fn=null,e.finalizers=null,e.receiver=null,e.emitter=null}}var s,c,h,f=this instanceof u?this:new u,d=i,p=o.collecting,g=f._gate||d&&d.gate||null,v=new l(e,g);if(i=v,f._sources){for(s=-1,c=f._sources.length;++s<c;)try{f._sources[s]()}catch(m){throw i=d,m}v.listening=!1}d&&(d.pinning||f._pin?d.finalizers.push(r):d.cleanups.push(r)),p||(o.collecting=!0);try{(!f._init||f._init(v))&&(v.value=e())}finally{i=d,p||(o.collecting=!1)}return p||0===o.len||o.run(null,null),h=function(){return v&&(i&&(v.emitter||(v.emitter=new a(v)),n(v.emitter,v.gate)),v.receiver&&0!==v.receiver.marks&&v.receiver.backtrack(),v)?v.value:void 0},h.dispose=r,h.toJSON=t,h};r.data=function d(e){var d,r=new c(e);return r.value=e,d=function(t){return arguments.length>0?o.collecting?o.add(r,t):o.run(r,t):i&&(r.emitter||(r.emitter=new a(null)),n(r.emitter,null)),r.value},d.toJSON=t,d};var u=function(){function t(){this._sources=null,this._pin=!1,this._init=null,this._gate=null}return t.prototype.pin=function(){return this._pin=!0,this},t.prototype.gate=function(t){return this._gate=t,this},t.prototype.S=function(t){return r(t)},t}();u.prototype.S=r,r.on=function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var e=new u;return e._sources=t,e},r.when=function(){for(var t=[],n=0;n<arguments.length;n++)t[n-0]=arguments[n];var e=new u,i=t.length;return e._sources=t,e._gate=e._init=function(){for(var n=-1;++n<i;)if(void 0===t[n]())return!1;return!0},e},r.gate=function(t){return(new u).gate(t)},r.collector=function p(){function t(){var t,u,s;for(n=!0,t=-1;++t<o.length;)u=o[t],u.emitter&&u.emitter.mark();s=i,i=null,t=-1;try{for(;++t<o.length;)o[t].update()}catch(c){for(t--;++t<o.length;)e(o[t]);throw c}finally{i=s,n=!1}o=[],r=[]}var p,n=!1,o=[],r=[];return p=function(t){var e=t;return n||r[e.receiver.id]||(o.push(e),r[e.receiver.id]=e),n},p.go=t,p},r.throttle=function(t){var n=r.collector(),e=0;return function(i){var o=Date.now();return n(i),o-e>t?(e=o,n.go()):setTimeout(function(){e=Date.now(),n.go()},t-(o-e)),!1}},r.debounce=function(t){var n=r.collector(),e=0,i=0;return function(o){var r=Date.now();return n(o),r>e&&(e=r,i&&clearTimeout(i),i=setTimeout(n.go,t)),!1}},r.peek=function(t){if(!i||!i.listening)return t();i.listening=!1;try{return t()}finally{i.listening=!0}},r.cleanup=function(t){if(!i)throw new Error("S.cleanup() must be called from within an S.computation.  Cannot call it at toplevel.");i.cleanups.push(t)},r.freeze=function(t){var n;if(!o.collecting){o.collecting=!0;try{n=t()}finally{o.collecting=!1}return o.run(null,null),n}t()},r.pin=function(t){if(0===arguments.length)return(new u).pin();if(!i||i.pinning)return t();i.pinning=!0;try{return t()}finally{i.pinning=!1}};var s=function(){function t(){this.len=0,this.collecting=!1,this.nodes=[],this.nodes2=[]}return t.prototype.add=function(t,n){if(t.pending){if(n!==t.pendingValue)throw new Error("conflicting mutations: "+n+" !== "+t.pendingValue)}else t.pending=!0,t.pendingValue=n,this.nodes[this.len]=t,this.len++},t.prototype.run=function(t,n){var o,r,u,s=0,c=!1;if(t){if(t.value=n,!t.emitter)return;t.emitter.mark(),this.collecting=!0;try{t.emitter.propagate(),c=!0}finally{c||e(t),this.collecting=!1,i=null}}for(;0!==(o=this.nodes,u=this.len);){for(r=-1;++r<u;)t=o[r],t.value=t.pendingValue,t.pending=!1,t.emitter&&t.emitter.mark();this.nodes=this.nodes2,this.nodes2=o,this.len=0,this.collecting=!0,r=-1;try{for(;++r<u;)t=o[r],t.emitter&&t.emitter.propagate(),o[r]=null}finally{for(r--;++r<u;)e(o[r]),o[r]=null;this.collecting=!1,i=null}if(++s>1e5){for(r=-1;++r<this.len;)this.nodes[r]=null;throw this.len=0,new Error("Runaway frames detected")}}},t}();o=new s;var c=function(){function t(t){this.value=void 0,this.pending=!1,this.pendingValue=void 0,this.emitter=null,this.value=t}return t}(),l=function(){function t(t,n){this.value=void 0,this.gen=1,this.emitter=null,this.receiver=null,this.listening=!0,this.pinning=!1,this.cleanups=[],this.finalizers=[],this.fn=t,this.gate=n}return t.prototype.update=function(){var t,n,e;if(this.cleanup(),i=this,this.gen++,this.fn&&(this.value=this.fn()),this.receiver&&this.listening){for(t=-1,n=this.receiver.inbound.length;++t<n;)e=this.receiver.inbound[t],e.active&&e.gen<this.gen&&e.deactivate();n>10&&n/this.receiver.inboundActive>4&&this.receiver.compact()}this.emitter&&this.emitter.propagate()},t.prototype.cleanup=function(){var t=-1,n=this.cleanups,e=n.length;for(this.cleanups=[];++t<e;)n[t]()},t}(),a=function(){function t(n){this.id=t.count++,this.emitting=!1,this.outbound=[],this.outboundIndex=[],this.outboundActive=0,this.outboundCompaction=0,this.node=n}return t.prototype.mark=function(){this.emitting=!0;for(var t,n,e=this.outbound,i=-1,o=e.length;++i<o;)if(t=e[i],t&&(!t.boundary||t.to.node.gate(t.to.node))){if(n=t.to,n.node.emitter&&n.node.emitter.emitting)throw new Error("circular dependency");t.marked=!0,n.marks++,1===n.marks&&n.node.emitter&&n.node.emitter.mark()}this.emitting=!1},t.prototype.propagate=function(){for(var t,n,e=-1,i=this.outbound.length;++e<i;)t=this.outbound[e],t&&t.marked&&(n=t.to,t.marked=!1,n.marks--,0===n.marks&&n.node.update());i>10&&i/this.outboundActive>4&&this.compact()},t.prototype.compact=function(){for(var t,n=-1,e=this.outbound.length,i=[],o=++this.outboundCompaction;++n<e;)t=this.outbound[n],t&&(t.outboundOffset=i.length,t.outboundCompaction=o,i.push(t));this.outbound=i},t.count=0,t}(),h=function(){function t(t){this.id=a.count++,this.marks=0,this.inbound=[],this.inboundIndex=[],this.inboundActive=0,this.node=t}return t.prototype.backtrack=function(){for(var t,n=-1,e=this.inbound.length,o=i;++n<e;)t=this.inbound[n],t&&t.marked&&(t.from.node&&t.from.node.receiver.marks?t.from.node.receiver.backtrack():(t.from.propagate(),i=o))},t.prototype.compact=function(){for(var t,n=-1,e=this.inbound.length,i=[],o=[];++n<e;)t=this.inbound[n],t.active&&(i.push(t),o[t.from.id]=t);this.inbound=i,this.inboundIndex=o},t.count=0,t}(),f=function(){function t(t,n,e){this.active=!0,this.marked=!1,this.from=t,this.to=n,this.boundary=e,this.gen=n.node.gen,this.outboundOffset=t.outbound.length,this.outboundCompaction=t.outboundCompaction,t.outbound.push(this),n.inbound.push(this),n.inboundIndex[t.id]=this,t.outboundActive++,n.inboundActive++}return t.prototype.activate=function(t){this.active||(this.active=!0,this.outboundCompaction===t.outboundCompaction?t.outbound[this.outboundOffset]=this:(this.outboundCompaction=t.outboundCompaction,this.outboundOffset=t.outbound.length,t.outbound.push(this)),this.to.inboundActive++,t.outboundActive++,this.from=t),this.gen=this.to.node.gen},t.prototype.deactivate=function(){if(this.active){var t=this.from,n=this.to;this.active=!1,t.outbound[this.outboundOffset]=null,t.outboundActive--,n.inboundActive--,this.from=null}},t}();"object"==typeof module&&"object"==typeof module.exports?module.exports=r:"function"==typeof define?define([],function(){return r}):(eval||function(){})("this").S=r}();