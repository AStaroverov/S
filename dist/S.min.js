!function(){"use strict";function n(n){return function(){for(var t=0;t<n.length;t++)n[t]()}}function t(n,t){var e=t.id,o=n.nodes[e];o!==t&&(o!==F&&(n.ids[n.count++]=e),n.nodes[e]=t,t.sources[t.count++]=n)}function e(n,e){n.log||(n.log=new b),t(n.log,e)}function o(n,e){n.log||(n.log=new b),t(n.log,e)}function c(n,t){if(t.preclocks){if(t.preclocks.ages[n.id]===t.age)return}else t.preclocks=new E;t.preclocks.ages[n.id]=t.age,t.preclocks.clocks[t.preclocks.count++]=n}function r(n,t,e){var o=t.preclocks||(t.preclocks=new S),c=e.preclocks||(e.preclocks=new E);if(c.ages[n.id]!==e.age){c.ages[n.id]=e.age,c.uclocks[c.ucount]=t,c.uclockids[c.ucount++]=n.id;var r=o.clockcounts[n.id];r?o.clockcounts[n.id]++:(void 0===r&&(o.ids[o.count++]=n.id),o.clockcounts[n.id]=1,o.clocks[n.id]=n)}}function u(){R.subtime++;try{s(R)}finally{q=D=B=null}}function i(n){q=R,R.changes.reset();try{n.value=n.fn(n.value),(R.changes.count>0||R.subclocks.count>0||R.updates.count>0)&&(R.subtime++,s(R))}finally{q=D=B=null}}function s(n){var t=0;for(n.disposes.reset();n.changes.count>0||n.subclocks.count>0||n.updates.count>0;)if(t>0&&n.subtime++,n.changes.run(l),n.subclocks.run(d),n.updates.run(h),n.disposes.run(v),t++>1e5)throw new Error("Runaway clock detected")}function l(n){n.value=n.pending,n.pending=x,n.log&&a(n.log)}function a(n){for(var t=n.nodes,e=n.ids,o=0,c=0;c<n.count;c++){var r=e[c],u=t[r];if(u===F)t[r]=G,o++;else{var i=u.clock.time();u.age<i&&(u.age=i,u.state=z,u.clock.updates.add(u),p(u.clock),u.owned&&f(u.owned),u.log&&a(u.log)),o&&(e[c-o]=r)}}o&&(n.count-=o)}function f(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=e.clock.time(),e.state=A,e.owned&&f(e.owned)}}function p(n){var t=0;(n.parent&&n.age<(t=n.parent.time())||n.state===A)&&(n.state=z,n.parent&&(n.age=t,n.parent.subclocks.add(n),p(n.parent)))}function d(n){var t=n.parent.time();if(n.age<t||n.state===z){if(n.age<t&&(n.state=A),n.preclocks)for(var e=0;e<n.preclocks.ids.length;e++){var o=n.preclocks.clocks[n.preclocks.ids[e]];o&&d(o)}n.age=t}if(n.state===C)throw new Error("clock circular reference");n.state===z&&(n.state=C,s(n),n.state=A)}function h(n){if(n.state===z){var t=D,e=B,o=q;D=B=n,q=n.clock,n.state=C,k(n,!1),n.value=n.fn(n.value),n.state=A,D=t,B=e,q=o}}function k(n,t){var e=n.sources,o=n.cleanups,c=n.owned,r=n.preclocks;if(o){for(var u=0;u<o.length;u++)o[u](t);n.cleanups=null}if(c){for(var u=0;u<c.length;u++)v(c[u]);n.owned=null}for(var u=0;u<n.count;u++)e[u].nodes[n.id]=F,e[u]=null;if(n.count=0,r){for(u=0;u<r.count;u++)r.clocks[u]=null;for(r.count=0,u=0;u<r.ucount;u++){var i=r.uclocks[u].preclocks,s=r.uclockids[u];0===--i.clockcounts[s]&&(i.clocks[s]=null)}r.ucount=0}}function v(n){n.fn=null,n.log=null,n.preclocks=null,k(n,!0)}var g=function(n,t){var e=D,u=q||R,s=B;if(!e)throw new Error("all computations must be created under a parent computation or root");var l=new y(u,n,t);return D=B=l,q?l.value=l.fn(l.value):i(l),e!==H&&(e.owned||(e.owned=[])).push(l),D=e,B=s,function(){if(B){for(var n=q,t=l.clock;n.depth>t.depth+1;)n=n.parent;if(n===t||n.parent===t){if(l.preclocks)for(var e=0;e<l.preclocks.count;e++){var u=l.preclocks.clocks[e];d(u)}if(l.age===l.clock.time()){if(l.state===C)throw new Error("circular dependency");h(l)}if(l.preclocks)for(var e=0;e<l.preclocks.count;e++){var u=l.preclocks.clocks[e];n===t?c(u,B):r(u,n,B)}}else{for(n.depth>t.depth&&(n=n.parent);t.depth>n.depth+1;)t=t.parent;if(t.parent===n)c(t,B);else{for(t.depth>n.depth&&(t=t.parent);n.parent!==t.parent;)n=n.parent,t=t.parent;r(t,n,B)}d(t)}o(l,B)}return l.value}};g.root=function I(n){var t=D,I=0===n.length?H:new y(q||R,null,null),e=void 0;D=I;try{e=0===n.length?n():n(function(){q?q.disposes.add(I):v(I)})}finally{D=t}return e},g.on=function J(t,e,o,c){function J(n){var o=B;return t(),c?c=!1:(B=null,n=e(n),B=o),n}return Array.isArray(t)&&(t=n(t)),c=!!c,g(J,o)},g.data=function(n){var t=new m(q||R,n);return function(n){var o=q,i=t.clock;if(q){for(;o.depth>i.depth;)o=o.parent;for(;i.depth>o.depth&&i.parent!==o;)i=i.parent;if(i.parent!==o)for(;o.parent!==i.parent;)o=o.parent,i=i.parent;o!==i&&d(i)}var s=o===i?i:i.parent;if(arguments.length>0){if(q)if(t.pending!==x){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,s.changes.add(t),p(s);else t.log?(t.pending=n,R.changes.add(t),u()):t.value=n;return n}return B&&(e(t,B),i.parent===o?c(i,B):i!==o&&r(i,o,B)),t.value}},g.value=function(n,t){var e=g.data(n),o=q||R,c=0;return function r(u){if(0===arguments.length)return e();var i=t?t(n,u):n===u;if(!i){var s=o.time();if(c===s)throw new Error("conflicting values: "+r+" is not the same as "+n);c=s,n=u,e(u)}return u}},g.freeze=function(n){var t=void 0;if(q)t=n();else{q=R,q.changes.reset();try{t=n(),u()}finally{q=null}}return t},g.sample=function(n){var t,e=B;return e?(B=null,t=n(),B=e):t=n(),t},g.cleanup=function(n){if(!D)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(D.cleanups||(D.cleanups=[])).push(n)},g.subclock=function K(n){function K(n){var e=null,o=q;q=t,t.state=z;try{e=n(),t.subtime++,s(t)}finally{q=o}return e}var t=new w(q||R);return n?K(n):K};var w=function(){function n(t){this.parent=t,this.id=n.count++,this.state=A,this.subtime=0,this.preclocks=null,this.changes=new j,this.subclocks=new j,this.updates=new j,this.disposes=new j,t?(this.age=t.time(),this.depth=t.depth+1):(this.age=0,this.depth=0)}return n.prototype.time=function(){for(var n=this.subtime,t=this;t=t.parent;)n+=t.subtime;return n},n}();w.count=0;var m=function(){function n(n,t){this.clock=n,this.value=t,this.pending=x,this.log=null}return n}(),y=function(){function n(t,e,o){this.clock=t,this.fn=e,this.value=o,this.id=n.count++,this.state=A,this.count=0,this.sources=[],this.log=null,this.preclocks=null,this.owned=null,this.cleanups=null,this.age=this.clock.time()}return n}();y.count=0;var b=function(){function n(){this.count=0,this.nodes=[],this.ids=[]}return n}(),E=function(){function n(){this.count=0,this.clocks=[],this.ages=[],this.ucount=0,this.uclocks=[],this.uclockids=[]}return n}(),S=function(){function n(){this.count=0,this.clockcounts=[],this.clocks=[],this.ids=[]}return n}(),j=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=0;e<this.count;e++)n(t[e]),t[e]=null;this.count=0},n}(),x={},A=0,z=1,C=2,R=new w(null),q=null,B=null,D=null,F=new y(R,null,null),G=new y(R,null,null),H=new y(R,null,null);"object"==typeof module&&"object"==typeof module.exports?module.exports=g:"function"==typeof define?define([],function(){return g}):(eval||function(){})("this").S=g}();