!function(){"use strict";function n(n){return function(){for(var t=0;t<n.length;t++)n[t]()}}function t(n,t){var e=t.id,r=n.nodes[e];r!==t&&(r!==F&&(n.ids[n.count++]=e),n.nodes[e]=t,t.sources[t.count++]=n)}function e(n,e){n.log||(n.log=new E),t(n.log,e)}function r(n,e){n.log||(n.log=new E),t(n.log,e)}function o(n,t){if(t.preprocs){if(t.preprocs.ages[n.id]===t.age)return}else t.preprocs=new S;t.preprocs.ages[n.id]=t.age,t.preprocs.procs[t.preprocs.count++]=n}function s(n,t,e){var r=t.preprocs||(t.preprocs=new j),o=e.preprocs||(e.preprocs=new S);if(o.ages[n.id]!==e.age){o.ages[n.id]=e.age,o.uprocs[o.ucount]=t,o.uprocids[o.ucount++]=n.id;var s=r.proccounts[n.id];s?r.proccounts[n.id]++:(void 0===s&&(r.ids[r.count++]=n.id),r.proccounts[n.id]=1,r.procs[n.id]=n)}}function i(){try{c(k)}finally{q=D=B=null}}function u(n){q=k,k.changes.reset();try{n.value=n.fn(n.value),k.changes.count>0&&c(k)}finally{q=D=B=null}}function c(n){var t=0;for(n.disposes.reset();n.changes.count||n.subprocs.count||n.updates.count;)if(n.proctime++,n.changes.run(a),n.subprocs.run(d),n.updates.run(h),n.disposes.run(g),t++>1e5)throw new Error("Runaway frames detected")}function a(n){n.value=n.pending,n.pending=A,n.log&&p(n.log)}function p(n){for(var t=n.nodes,e=n.ids,r=0,o=0;o<n.count;o++){var s=e[o],i=t[s];if(i===F)t[s]=G,r++;else{var u=i.process.time();i.age<u&&(i.age=u,i.state=C,i.process.updates.add(i),f(i.process),i.owned&&l(i.owned),i.log&&p(i.log)),r&&(e[o-r]=s)}}r&&(n.count-=r)}function l(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=e.process.time(),e.state=z,e.owned&&l(e.owned)}}function f(n){var t=0;(n.parent&&n.age<(t=n.parent.time())||n.state===z)&&(n.state=C,n.parent&&(n.age=t,n.parent.subprocs.add(n),f(n.parent)))}function d(n){var t=n.parent.time();if(n.age<t||n.state===C){if(n.age<t&&(n.state=z),n.preprocs)for(var e=0;e<n.preprocs.ids.length;e++){var r=n.preprocs.procs[n.preprocs.ids[e]];r&&d(r)}n.age=t}if(n.state===R)throw new Error("process circular reference");n.state===C&&(n.state=R,c(n),n.state=z)}function h(n){if(n.state===C){var t=D,e=B,r=q;D=B=n,q=n.process,n.state=R,v(n,!1),n.value=n.fn(n.value),n.state=z,D=t,B=e,q=r}}function v(n,t){var e=n.sources,r=n.cleanups,o=n.owned,s=n.preprocs;if(r){for(var i=0;i<r.length;i++)r[i](t);n.cleanups=null}if(o){for(var i=0;i<o.length;i++)g(o[i]);n.owned=null}for(var i=0;i<n.count;i++)e[i].nodes[n.id]=F,e[i]=null;if(n.count=0,s){for(i=0;i<s.count;i++)s.procs[i]=null;for(s.count=0,i=0;i<s.ucount;i++){var u=s.uprocs[i].preprocs,c=s.uprocids[i];0===--u.proccounts[c]&&(u.procs[c]=null)}s.ucount=0}}function g(n){n.fn=null,n.log=null,n.preprocs=null,v(n,!0)}var w=function(n,t){var e=D,i=q||k,c=B;if(!e)throw new Error("all computations must be created under a parent computation or root");var a=new b(i,n,t);return D=B=a,q?a.value=a.fn(a.value):u(a),e!==H&&(e.owned||(e.owned=[])).push(a),D=e,B=c,function(){if(B){for(var n=q,t=a.process;n.depth>t.depth+1;)n=n.parent;if(n===t||n.parent===t){if(a.preprocs)for(var e=0;e<a.preprocs.count;e++){var i=a.preprocs.procs[e];d(i)}if(a.age===a.process.time()){if(a.state===R)throw new Error("circular dependency");h(a)}if(a.preprocs)for(var e=0;e<a.preprocs.count;e++){var i=a.preprocs.procs[e];n===t?o(i,B):s(i,n,B)}}else{for(n.depth>t.depth&&(n=n.parent);t.depth>n.depth+1;)t=t.parent;if(t.parent===n)o(t,B);else{for(t.depth>n.depth&&(t=t.parent);n.parent!==t.parent;)n=n.parent,t=t.parent;s(t,n,B)}d(t)}r(a,B)}return a.value}};w.root=function I(n){var t=D,I=0===n.length?H:new b(q||k,null,null),e=void 0;D=I;try{e=0===n.length?n():n(function(){q?q.disposes.add(I):g(I)})}finally{D=t}return e},w.on=function J(t,e,r,o){function J(n){var r=B;return t(),o?o=!1:(B=null,n=e(n),B=r),n}return Array.isArray(t)&&(t=n(t)),o=!!o,w(J,r)},w.data=function(n){var t=new y(q||k,n);return function(n){var r=q,u=t.process;if(q){for(;r.depth>u.depth;)r=r.parent;for(;u.depth>r.depth&&u.parent!==r;)u=u.parent;if(u.parent!==r)for(;r.parent!==u.parent;)r=r.parent,u=u.parent;r!==u&&d(u)}var c=r===u?u:u.parent;if(arguments.length>0){if(q)if(t.pending!==A){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,c.changes.add(t),f(c);else t.log?(t.pending=n,k.changes.add(t),i()):t.value=n;return n}return B&&(e(t,B),u.parent===r?o(u,B):u!==r&&s(u,r,B)),t.value}},w.value=function(n,t){var e=w.data(n),r=q||k,o=0;return function s(i){if(0===arguments.length)return e();var u=t?t(n,i):n===i;if(!u){var c=r.time();if(o===c)throw new Error("conflicting values: "+s+" is not the same as "+n);o=c,n=i,e(i)}return i}},w.freeze=function(n){var t=void 0;if(q)t=n();else{q=k,q.changes.reset();try{t=n(),i()}finally{q=null}}return t},w.sample=function(n){var t,e=B;return e?(B=null,t=n(),B=e):t=n(),t},w.cleanup=function(n){if(!D)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(D.cleanups||(D.cleanups=[])).push(n)},w.process=function(){var n=new m(q||k);return function(t){var e=null,r=q;q=n,n.state=C;try{e=t(),c(n)}finally{q=r}return e}};var m=function(){function n(t){this.parent=t,this.id=n.count++,this.state=z,this.proctime=0,this.preprocs=null,this.changes=new x,this.subprocs=new x,this.updates=new x,this.disposes=new x,t?(this.age=t.time(),this.depth=t.depth+1):(this.age=0,this.depth=0)}return n.prototype.time=function(){for(var n=this.proctime,t=this;t=t.parent;)n+=t.proctime;return n},n}();m.count=0;var y=function(){function n(n,t){this.process=n,this.value=t,this.pending=A,this.log=null}return n}(),b=function(){function n(t,e,r){this.process=t,this.fn=e,this.value=r,this.id=n.count++,this.state=z,this.count=0,this.sources=[],this.log=null,this.preprocs=null,this.owned=null,this.cleanups=null,this.age=this.process.time()}return n}();b.count=0;var E=function(){function n(){this.count=0,this.nodes=[],this.ids=[]}return n}(),S=function(){function n(){this.count=0,this.procs=[],this.ages=[],this.ucount=0,this.uprocs=[],this.uprocids=[]}return n}(),j=function(){function n(){this.count=0,this.proccounts=[],this.procs=[],this.ids=[]}return n}(),x=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=0;e<this.count;e++)n(t[e]),t[e]=null;this.count=0},n}(),A={},z=0,C=1,R=2,k=new m(null),q=null,B=null,D=null,F=new b(k,null,null),G=new b(k,null,null),H=new b(k,null,null);"object"==typeof module&&"object"==typeof module.exports?module.exports=w:"function"==typeof define?define([],function(){return w}):(eval||function(){})("this").S=w}();