var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};!function(){"use strict";function e(e,t){var n;d++,g=1;try{n=t(),g>1&&o(null)}finally{v=null,m=!1,g=0}return n}function t(e,t){return function(){return t=e(t)}}function n(e,t,n){return function(){return t=e(t,n)}}function i(e){function t(){s!==d&&(o=!1,s=d+1,g?p[g++]=i:r(i))}var n,i=new S(null),o=!1,s=0;return i.emitter=new j(null),function(r){return s===d?!0:("function"==typeof n?n():o||(o=!0,n=e(t)),f(i.emitter,r),!1)}}function r(e){try{o(e)}finally{g=0,v=null,m=!1,y=!1}}function o(e){var t,n,i,r=0;if(g||(g=1),e&&(d++,s(e.emitter),a(e.emitter),n=-1,i=w.length,i)){for(;++n<i;)w[n].dispose();w=[]}for(;1!==g;){for(d++,t=p,p=_,_=t,i=g,g=1,n=0;++n<i;)e=t[n],e.value=e.pending,e.pending=void 0,e.emitter&&s(e.emitter);for(n=0;++n<i;)e=t[n],e.emitter&&a(e.emitter),t[n]=null;if(n=-1,i=w.length){for(;++n<i;)w[n].dispose();w=[]}if(r++>1e5)throw new Error("Runaway frames detected")}}function s(e){var t,n,i,r,o=e.edges,a=-1,c=o.length;for(e.emitting=!0;++a<c;)if(t=o[a],t&&(!t.boundary||t.to.node.gate(t.to.node))){if(n=t.to,i=n.node,r=i.emitter,0!==n.marks&&n.age<d&&(n.marks=0,r&&(r.emitting=!1)),r&&r.emitting)throw new Error("circular dependency");t.marked=!0,n.marks++,n.age=d,1===n.marks&&(i.children&&u(i.children),r&&s(r))}e.emitting=!1}function u(e){for(var t,n=-1,i=e.length;++n<i;)t=e[n],t.fn=null,t.children&&u(t.children)}function a(e){for(var t,n,i=-1,r=e.edges.length;++i<r;)t=e.edges[i],t&&t.marked&&(n=t.to,t.marked=!1,n.marks--,0===n.marks&&c(n.node));e.fragmented()&&e.compact()}function c(e){var t,n,i,r,o=e.emitter,s=e.receiver,u=null===e.fn;if(v=e,l(e),e.cleanup(u),u||(e.value=e.fn()),o){for(t=-1,n=o.edges.length;++t<n;)i=o.edges[t],i&&i.marked&&(r=i.to,i.marked=!1,r.marks--,0===r.marks&&c(r.node));u?o.detach():o.fragmented()&&o.compact()}if(s)if(u)s.detach();else{for(t=-1,n=s.edges.length;++t<n;)i=s.edges[t],i.active&&i.age<d&&i.deactivate();s.fragmented()&&s.compact()}}function l(e){if(e.children){for(var t,n=-1,i=e.children.length;++n<i;)t=e.children[n],(!t.receiver||t.receiver.age<d)&&(l(t),t.dispose());e.children=null}}function h(e){function t(e){for(var n,i=-1,r=e.edges.length;++i<r;)n=e.edges[i],n&&n.marked&&(n.from.node&&n.from.node.receiver.marks?t(n.from.node.receiver):a(n.from))}var n=v,i=m;m=!1,t(e),v=n,m=i}function f(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new O(t),n?n.activate(e):new C(e,t.receiver,t.gate&&(null===e.node||t.gate!==e.node.gate))}var d=1,g=0,p=[],v=null,m=!1,y=!1,w=[],k=function(r,o,s){var u=this instanceof A?this.options:null,a=v,c=m,l=u&&u.async&&i(u.async)||a&&a.gate||null,p=new E(r,l);return r=1===arguments.length?r:2===arguments.length?t(r,o):n(r,o,s),!a||u&&u.toplevel||(a.children||(a.children=[])).push(p),v=p,m=!1,g?p.value=r():p.value=e(p,r),v=a,m=c,function(){return y?g?w.push(p):p.dispose():v&&p.fn&&(p.receiver&&0!==p.receiver.marks&&p.receiver.age===d&&h(p.receiver),m||(p.emitter||(p.emitter=new j(p)),f(p.emitter,v))),p.value}};k.on=function P(e,i,r,o){function P(){var e=r;return c(),a?a=!1:(m=!0,e=i(),m=!1),e}function s(){for(var t=0;t<e.length;t++)e[t]()}var u=this instanceof A?this:null,a=!0,c="function"==typeof e?e:s;return i=1===arguments.length?i:2===arguments.length?t(i,r):n(i,r,o),u?u.S(P):k(P)},k.data=function(e){var t=new S(e);return function(e){if(arguments.length>0){if(g)if(t.age===d){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=d,t.pending=e,p[g++]=t;else t.age=d,t.value=e,t.emitter&&r(t);return e}return v&&!m&&(t.emitter||(t.emitter=new j(null)),f(t.emitter,v)),t.value}},k.sum=function(e){var t=new S(e);return function(n){return arguments.length>0?(g?t.age===d?t.pending=n(t.pending):(t.age=d,t.pending=n(t.value),p[g++]=t):(t.age=d,t.value=n(t.value),t.emitter&&r(t)),e):(v&&!m&&(t.emitter||(t.emitter=new j(null)),f(t.emitter,v)),t.value)}};var x=function(){function e(){this.toplevel=!1,this.async=null}return e}(),A=function(){function e(e){this.options=e}return e}();A.prototype.S=k,A.prototype.on=k.on;var b=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.async=function(e){return this.options.async=e,new A(this.options)},t}(A);k.toplevel=function(){var e=new x;return e.toplevel=!0,new b(e)},k.async=function(e){return new b(new x).async(e)},k.event=function(e){var t;if(g)t=e();else{g=1;try{t=e(),r(null)}finally{g=0}}return t},k.sample=function(e){var t;return v&&!m?(m=!0,t=e(),m=!1):t=e(),t},k.dispose=function(e){if(y)e();else{y=!0;try{e()}finally{y=!1}}},k.cleanup=function(e){if(!v)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(v.cleanups||(v.cleanups=[])).push(e)};var _=[],S=function(){function e(e){this.value=e,this.age=0,this.emitter=null}return e}(),E=function(){function e(e,t){this.fn=e,this.gate=t,this.emitter=null,this.receiver=null,this.children=null,this.cleanups=null}return e.prototype.dispose=function(){if(this.fn){if(this.fn=null,this.gate=null,this.children)for(var e=-1,t=this.children.length;++e<t;)this.children[e].dispose();this.cleanup(!0),this.receiver&&this.receiver.detach(),this.emitter&&this.emitter.detach()}},e.prototype.cleanup=function(e){if(this.cleanups){for(var t=-1,n=this.cleanups.length;++t<n;)this.cleanups[t](e);this.cleanups=null}},e}(),j=function(){function e(t){this.node=t,this.id=e.count++,this.emitting=!1,this.edges=[],this.active=0,this.edgesAge=0}return e.prototype.detach=function(){for(var e,t=-1,n=this.edges.length;++t<n;)e=this.edges[t],e&&e.deactivate()},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=++this.edgesAge;++t<n;)e=this.edges[t],e&&(e.slot=i.length,e.slotAge=r,i.push(e));this.edges=i},e.count=0,e}(),O=function(){function e(e){this.node=e,this.id=j.count++,this.marks=0,this.age=d,this.edges=[],this.index=[],this.active=0}return e.prototype.detach=function(){for(var e=-1,t=this.edges.length;++e<t;)this.edges[e].deactivate()},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=[];++t<n;)e=this.edges[t],e.active&&(i.push(e),r[e.from.id]=e);this.edges=i,this.index=r},e.count=0,e}(),C=function(){function e(e,t,n){this.from=e,this.to=t,this.boundary=n,this.age=d,this.active=!0,this.marked=!1,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e.prototype.activate=function(e){this.active||(this.active=!0,this.slotAge===e.edgesAge?e.edges[this.slot]=this:(this.slotAge=e.edgesAge,this.slot=e.edges.length,e.edges.push(this)),this.to.active++,e.active++,this.from=e),this.age=d},e.prototype.deactivate=function(){if(this.active){var e=this.from,t=this.to;this.active=!1,e.edges[this.slot]=null,e.active--,t.active--,this.from=null}},e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=k:"function"==typeof define?define([],function(){return k}):(eval||function(){})("this").S=k}();