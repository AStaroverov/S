!function(){"use strict";function n(n,t){try{n.trait&&(n.fn=n.trait(n.fn)),t&&(n.fn=t(n.fn)),n.value=n.fn(),z.count>0&&i(null)}finally{g=!1,v=null,w=!1,m=!1}}function t(n,t){return function(e){return n(t(e))}}function e(n){function t(){return p===i?!1:(l&&l(),r(o,this),!0)}function e(){i=p+1,g?z.add(o):u(o)}var i=0,o=new R(null),l=n(e);return function c(n){return v&&(v.trait=c,v.hold=t),n}}function u(n){try{i(n)}finally{g=!1,v=null,w=!1,m=!1}}function i(n){var t,e=0;for(g=!0,B.reset(),D.reset(),n&&(z.reset(),p++,a(n),B.run(o),D.run(d));0!==z.count;)if(t=z,z=A,A=t,z.reset(),p++,t.run(a),B.run(o),D.run(d),e++>1e5)throw new Error("Runaway frames detected")}function o(n){if(n.state===E){var t=v,e=w;v=n,w=!1,n.state=b,h(n,!1),n.value=n.fn(),n.state=S,v=t,w=e}}function r(n,t){n.log||(n.log=new q),c(n.log,t)}function l(n,t){n.log||(n.log=new q),c(n.log,t)}function c(n,t){var e=t.id,u=n.nodes[e];u!==t&&(u!==F&&(n.ids[n.count++]=e),n.nodes[e]=t,t.sources[t.count++]=n)}function a(n){n.value=n.pending,n.pending=y,n.log&&f(n.log)}function f(n){for(var t=n.nodes,e=n.ids,u=0,i=0;i<n.count;i++){var o=e[i],r=t[o];r===F?(t[o]=G,u++):(r.age<p&&(r.age=p,r.hold&&r.hold()?r.state=S:(r.state=E,B.add(r),r.children&&s(r.children),r.log&&f(r.log))),u&&(e[i-u]=o))}u&&(n.count-=u)}function s(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=p,e.state=S,e.children&&s(e.children)}}function d(n){n.fn=null,n.trait=null,n.hold=null,n.log=null,h(n,!0),n.sources=null}function h(n,t){var e=n.sources,u=n.cleanups,i=n.children;if(u){for(var o=0;o<u.length;o++)u[o](t);n.cleanups=null}if(i){for(var o=0;o<i.length;o++)d(i[o]);n.children=null}for(var o=0;o<n.count;o++)e[o].nodes[n.id]=F,e[o]=null;n.count=0}var p=1,g=!1,v=null,w=!1,m=!1,y={},S=0,E=1,b=2,j=function(t){var e=v,u=w,i=this instanceof x?this:null,r=new k(t,e&&e.trait);return v=r,w=!1,g?(i&&i.mod&&(r.fn=i.mod(r.fn)),r.trait&&(r.fn=r.trait(r.fn)),r.value=r.fn()):(g=!0,z.reset(),n(r,i&&i.mod)),!e||i&&i.orphan||(e.children||(e.children=[])).push(r),v=e,w=u,function(){if(m)v?D.add(r):d(r);else if(v){if(r.age===p){if(r.state===b)throw new Error("circular dependency");o(r)}w||l(r,v)}return r.value}};j.on=function H(n,t,e){function H(){return n(),u?u=!1:v&&!w?(w=!0,e=t(e),w=!1):e=t(e),e}var u=!0;return this instanceof x?this.S(H):j(H)},j.data=function(n){var t=new R(n);return function(n){if(arguments.length>0){if(g)if(t.pending!==y){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,z.add(t);else t.log?(t.pending=n,u(t)):t.value=n;return n}return v&&!w&&r(t,v),t.value}},j.sum=function(n){var t=new R(n);return function(e){return arguments.length>0?(g?t.pending!==y?t.pending=e(t.pending):(t.pending=e(t.value),z.add(t)):t.log?(t.pending=e(t.value),u(t)):t.value=e(t.value),n):(v&&!w&&r(t,v),t.value)}},j.event=function(n){var t;if(g)t=n();else{g=!0,z.reset();try{t=n(),u(null)}finally{g=!1}}return t},j.sample=function(n){var t;return v&&!w?(w=!0,t=n(),w=!1):t=n(),t};var x=function(){function n(n,e,u){this.orphan=!1,this.mod=n&&n.mod?u?t(n.mod,u):n.mod:u,this.orphan=n&&n.orphan||e}return n.prototype.async=function(t){return new n(this,!1,e(t))},n}();x.prototype.S=j,x.prototype.on=j.on,j.orphan=function(){return new x(null,!0,null)},j.async=function(n){return new x(null,!1,e(n))},j.dispose=function(n){if(m)n();else{m=!0;try{n()}finally{m=!1}}},j.cleanup=function(n){if(!v)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(v.cleanups||(v.cleanups=[])).push(n)};var C=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=this.count,u=0;e>u;u++)n(t[u]),t[u]=null;this.count=0},n}(),R=function(){function n(n){this.value=n,this.pending=y,this.log=null}return n}(),k=function(){function n(t,e){this.fn=t,this.trait=e,this.id=n.count++,this.value=void 0,this.age=p,this.state=S,this.hold=null,this.count=0,this.sources=[],this.log=null,this.children=null,this.cleanups=null}return n.count=0,n}(),q=function(){function n(){this.count=0,this.nodes=[],this.ids=[]}return n}(),z=new C,A=new C,B=new C,D=new C,F=new k(null,null),G=new k(null,null);"object"==typeof module&&"object"==typeof module.exports?module.exports=j:"function"==typeof define?define([],function(){return j}):(eval||function(){})("this").S=j}();