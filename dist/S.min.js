!function(){"use strict";function e(e,t){var n=-1,i=e.length;try{for(;++n<i;)e[n]()}finally{v=t}}function t(e,t){var n;g++,h=!0;try{n=e(),0!==m&&r(null)}finally{v=t,h=!1,m=0}return n}function n(){return this()}function i(e){try{r(e)}finally{h=!1,m=0,v=null}}function r(e){var t,n,i,r=0;for(h=!0,e&&(g++,o(e.emitter),s(e.emitter));0!==m;){for(g++,t=d,d=w,w=t,i=m,m=0,n=-1;++n<i;)e=t[n],e.value=e.pending,e.pending=void 0,e.emitter&&o(e.emitter);for(n=-1;++n<i;)e=t[n],e.emitter&&s(e.emitter),t[n]=null;if(r++>1e5)throw new Error("Runaway frames detected")}}function o(e){var t,n,i,r=e.edges,s=-1,u=r.length;for(e.emitting=!0;++s<u;)if(t=r[s],t&&(!t.boundary||t.to.node.gate(t.to.node))){if(n=t.to,i=n.node.emitter,n.age<g&&(n.marks=0,i&&(i.emitting=!1)),i&&i.emitting)throw new Error("circular dependency");t.marked=!0,n.marks++,n.age=g,1===n.marks&&i&&o(i)}e.emitting=!1}function s(e){for(var t,n,i=-1,r=e.edges.length;++i<r;)t=e.edges[i],t&&t.marked&&(n=t.to,t.marked=!1,n.marks--,0===n.marks&&u(n.node));r>10&&r/e.active>4&&e.compact()}function u(e){var t,n,i,r,o=e.emitter,s=e.receiver;for(t=-1,n=e.cleanups.length;++t<n;)e.cleanups[t]();if(e.cleanups=[],v=e,e.value=e.fn(),o){for(t=-1,n=o.edges.length;++t<n;)i=o.edges[t],i&&i.marked&&(r=i.to,i.marked=!1,r.marks--,0===r.marks&&u(r.node));n>10&&n/o.active>4&&o.compact()}if(null!==s&&e.listening){for(t=-1,n=s.edges.length;++t<n;)i=s.edges[t],i.active&&i.age<g&&f(i);n>10&&n/s.active>4&&s.compact()}}function a(e){for(var t,n=-1,i=e.edges.length,r=v;++n<i;)t=e.edges[n],t&&t.marked&&(t.from.node&&t.from.node.receiver.marks?a(t.from.node.receiver):(s(t.from),v=r))}function l(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new x(t),n?c(n,e):new S(e,t.receiver,t.gate&&(null===e.node||t.gate!==e.node.gate))}function c(e,t){e.active||(e.active=!0,e.slotAge===t.edgesAge?t.edges[e.slot]=e:(e.slotAge=t.edgesAge,e.slot=t.edges.length,t.edges.push(e)),e.to.active++,t.active++,e.from=t),e.age=g}function f(e){if(e.active){var t=e.from,n=e.to;e.active=!1,t.edges[e.slot]=null,t.active--,n.active--,e.from=null}}var g=1,h=!1,d=[],m=0,v=null,p=function(i){function r(){if(d){var e,t,n,i=d.receiver,r=d.emitter,o=d.cleanups,s=d.finalizers;if(v===d&&(v=null),d=null,i)for(e=-1,t=i.edges.length;++e<t;)f(i.edges[e]);if(r)for(e=-1,t=r.edges.length;++e<t;)n=r.edges[e],n&&f(n);for(e=-1,t=o.length;++e<t;)o[e]();for(e=-1,t=s.length;++e<t;)s[e]()}}var o,s=this instanceof y?this:null,u=v,c=h,g=s&&s._gate||u&&u.gate||null,d=new _(i,g);return v=d,s&&s._sources&&(e(s._sources,u),d.listening=!1),u&&(u.pinning||s&&s._pin?u.finalizers.push(r):u.cleanups.push(r)),v=d,c?(d.value=i(),v=u):d.value=t(i,u),o=function(){return d&&(v&&v.listening&&(d.emitter||(d.emitter=new A(d)),l(d.emitter,v)),d.receiver&&0!==d.receiver.marks&&a(d.receiver),d)?d.value:void 0},o.dispose=r,o.toJSON=n,o};p.data=function b(e){var b,t=new k(e);return b=function(e){if(arguments.length>0){if(h)if(t.age===g){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=g,t.pending=e,d[m++]=t;else t.value=e,t.emitter&&i(t);return e}return v&&v.listening&&(t.emitter||(t.emitter=new A(null)),l(t.emitter,v)),t.value},b.toJSON=n,b};var y=function(){function e(){this._sources=null,this._pin=!1,this._gate=null}return e.prototype.pin=function(){return this._pin=!0,this},e.prototype.gate=function(e){return this._gate=e,this},e.prototype.S=function(e){return p(e)},e}();y.prototype.S=p,p.on=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=new y;return n._sources=e,n},p.gate=function(e){return(new y).gate(e)},p.collector=function z(){function e(){r=!0,i(t),r=!1}var z,t=new k(null),n=new A(null),r=!1;return t.emitter=n,z=function(e){var t=e;return r||l(n,t),r},z.go=e,z},p.throttle=function(e){var t=p.collector(),n=0;return function(i){var r=Date.now();return t(i),r-n>e?(n=r,t.go()):setTimeout(function(){n=Date.now(),t.go()},e-(r-n)),!1}},p.debounce=function(e){var t=p.collector(),n=0,i=0;return function(r){var o=Date.now();return t(r),o>n&&(n=o,i&&clearTimeout(i),i=setTimeout(t.go,e)),!1}},p.peek=function(e){if(!v||!v.listening)return e();v.listening=!1;try{return e()}finally{v.listening=!0}},p.cleanup=function(e){if(!v)throw new Error("S.cleanup() must be called from within an S.computation.  Cannot call it at toplevel.");v.cleanups.push(e)},p.freeze=function(e){var t;if(h)t=e();else{g++,h=!0;try{t=e()}finally{h=!1}m>0&&i(null)}return t},p.pin=function(e){if(0===arguments.length)return(new y).pin();if(!v||v.pinning)return e();v.pinning=!0;try{return e()}finally{v.pinning=!1}};var w=[],k=function(){function e(e){this.age=0,this.emitter=null,this.value=e}return e}(),_=function(){function e(e,t){this.emitter=null,this.receiver=null,this.listening=!0,this.pinning=!1,this.cleanups=[],this.finalizers=[],this.fn=e,this.gate=t}return e}(),A=function(){function e(t){this.id=e.count++,this.emitting=!1,this.edges=[],this.index=[],this.active=0,this.edgesAge=0,this.node=t}return e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=++this.edgesAge;++t<n;)e=this.edges[t],e&&(e.slot=i.length,e.slotAge=r,i.push(e));this.edges=i},e.count=0,e}(),x=function(){function e(e){this.id=A.count++,this.marks=0,this.age=g,this.edges=[],this.index=[],this.active=0,this.node=e}return e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=[];++t<n;)e=this.edges[t],e.active&&(i.push(e),r[e.from.id]=e);this.edges=i,this.index=r},e.count=0,e}(),S=function(){function e(e,t,n){this.age=g,this.active=!0,this.marked=!1,this.from=e,this.to=t,this.boundary=n,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=p:"function"==typeof define?define([],function(){return p}):(eval||function(){})("this").S=p}();