!function(){"use strict";function n(n){function t(){e=E+1,S?j.add(r):o(r)}var e=0,r=new g(null),l=n(t);return function(){return E!==e&&(l&&l(),u(r,this),!0)}}function t(n){return function(){for(var t=0;t<n.length;t++)n[t]()}}function e(n,t){var e=t.id,u=n.nodes[e];u!==t&&(u!==C&&(n.ids[n.count++]=e),n.nodes[e]=t,t.sources[t.count++]=n)}function u(n,t){n.log||(n.log=new y),e(n.log,t)}function r(n,t){n.log||(n.log=new y),e(n.log,t)}function o(n){try{i(n)}finally{S=!1,_=b=null}}function l(n){try{n.value=n.fn(n.value),j.count>0&&i(null)}finally{S=!1,_=b=null}}function i(n){var t,e=0;for(S=!0,A.reset(),z.reset(),n&&(j.reset(),E++,c(n),A.run(s),z.run(h));0!==j.count;)if(t=j,j=x,x=t,j.reset(),E++,t.run(c),A.run(s),z.run(h),e++>1e5)throw new Error("Runaway frames detected")}function c(n){n.value=n.pending,n.pending=k,n.log&&f(n.log)}function f(n){for(var t=n.nodes,e=n.ids,u=0,r=0;r<n.count;r++){var o=e[r],l=t[o];l===C?(t[o]=R,u++):(l.age<E&&(l.age=E,l.hold&&l.hold()?l.state=q:(l.state=B,A.add(l),l.children&&a(l.children),l.log&&f(l.log))),u&&(e[r-u]=o))}u&&(n.count-=u)}function a(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=E,e.state=q,e.children&&a(e.children)}}function s(n){if(n.state===B){var t=_,e=b;_=b=n,n.state=D,d(n,!1),n.value=n.fn(n.value),n.state=q,_=t,b=e}}function d(n,t){var e=n.sources,u=n.cleanups,r=n.children;if(u){for(var o=0;o<u.length;o++)u[o](t);n.cleanups=null}if(r){for(var o=0;o<r.length;o++)h(r[o]);n.children=null}for(var o=0;o<n.count;o++)e[o].nodes[n.id]=C,e[o]=null;n.count=0}function h(n){n.fn=null,n.hold=null,n.log=null,d(n,!0),n.sources=null}var v=function(t,e){var u=_,o=b,i=this instanceof p?this:null,c=i&&i._defer?n(i._defer):u?u.hold:null,f=new w(t,e,c);if(_=b=f,S?f.value=f.fn(f.value):(S=!0,j.reset(),l(f)),!u)throw new Error("all computations must be created under a parent or root");return(u.children||(u.children=[])).push(f),_=u,b=o,function(){if(_){if(f.age===E){if(f.state===D)throw new Error("circular dependency");s(f)}b&&r(f,b)}return f.value}};v.root=function F(n){function t(){S?z.add(F):h(F)}var e=_,F=new w(null,null,null);_=F;try{return n(t)}finally{_=e}},v.on=function G(n,e,u,r){function G(t){var u=b;return n(),r?r=!1:(b=null,t=e(t),b=u),t}return Array.isArray(n)&&(n=t(n)),r=!!r,this instanceof p?this.S(G,u):v(G,u)};var p=function(){function n(n,t){this._defer=t,this._defer=t||n&&n._defer}return n.prototype.defer=function(t){return new n(this,t)},n}();p.prototype.S=v,p.prototype.on=v.on,v.defer=function(n){return new p(null,n)},v.data=function(n){var t=new g(n);return function(n){if(arguments.length>0){if(S)if(t.pending!==k){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else t.pending=n,j.add(t);else t.log?(t.pending=n,o(t)):t.value=n;return n}return b&&u(t,b),t.value}},v.value=function(n,t){var e=v.data(n),u=0;return function r(o){if(0===arguments.length)return e();var l=t?t(n,o):n===o;if(!l){if(u===E)throw new Error("conflicting values: "+r+" is not the same as "+n);u=E,n=o,e(o)}return o}},v.sum=function(n){var t=new g(n);return function(e){return arguments.length>0?(S?t.pending!==k?t.pending=e(t.pending):(t.pending=e(t.value),j.add(t)):t.log?(t.pending=e(t.value),o(t)):t.value=e(t.value),n):(b&&u(t,b),t.value)}},v.freeze=function(n){var t;if(S)t=n();else{S=!0,j.reset();try{t=n(),o(null)}finally{S=!1}}return t},v.sample=function(n){var t,e=b;return e?(b=null,t=n(),b=e):t=n(),t},v.cleanup=function(n){if(!_)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(_.cleanups||(_.cleanups=[])).push(n)};var g=function(){function n(n){this.value=n,this.pending=k,this.log=null}return n}(),w=function(){function n(t,e,u){this.fn=t,this.value=e,this.hold=u,this.id=n.count++,this.age=E,this.state=q,this.count=0,this.sources=[],this.log=null,this.children=null,this.cleanups=null}return n.count=0,n}(),y=function(){function n(){this.count=0,this.nodes=[],this.ids=[]}return n}(),m=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=this.count,u=0;u<e;u++)n(t[u]),t[u]=null;this.count=0},n}(),E=1,S=!1,_=null,b=null,j=new m,x=new m,A=new m,z=new m,C=new w(null,null,null),R=new w(null,null,null),k={},q=0,B=1,D=2;"object"==typeof module&&"object"==typeof module.exports?module.exports=v:"function"==typeof define?define([],function(){return v}):(eval||function(){})("this").S=v}();