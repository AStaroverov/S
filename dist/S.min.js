!function(){"use strict";function e(e,t){var n;h++,f=1;try{n=t(),f>1&&i(null)}finally{g=null,f=0}return n}function t(e){function t(){o!==h&&(s=!1,o=h+1,f?d[f++]=r:n(r))}var i,r=new k(null),s=!1,o=0;return r.emitter=new x(null),function(n){return o===h?!0:("function"==typeof i?i():s||(s=!0,i=e(t)),u(r.emitter,n),!1)}}function n(e){try{i(e)}finally{f=0,g=null,v=!1,m=!1}}function i(e){var t,n,i,s=0;if(f||(f=1),e&&(h++,r(e.emitter),o(e.emitter),n=-1,i=p.length,i)){for(;++n<i;)p[n].dispose();p=[]}for(;1!==f;){for(h++,t=d,d=w,w=t,i=f,f=1,n=0;++n<i;)e=t[n],e.value=e.pending,e.pending=void 0,e.emitter&&r(e.emitter);for(n=0;++n<i;)e=t[n],e.emitter&&o(e.emitter),t[n]=null;if(n=-1,i=p.length){for(;++n<i;)p[n].dispose();p=[]}if(s++>1e5)throw new Error("Runaway frames detected")}}function r(e){var t,n,i,o,a=e.edges,c=-1,l=a.length;for(e.emitting=!0;++c<l;)if(t=a[c],t&&(!t.boundary||t.to.node.gate(t.to.node))){if(n=t.to,i=n.node,o=i.emitter,0!==n.marks&&n.age<h&&(n.marks=0,o&&(o.emitting=!1)),o&&o.emitting)throw new Error("circular dependency");t.marked=!0,n.marks++,n.age=h,1===n.marks&&(i.children&&s(i.children),o&&r(o))}e.emitting=!1}function s(e){for(var t,n=-1,i=e.length;++n<i;)t=e[n],t.fn=null,t.children&&s(t.children)}function o(e){for(var t,n,i=-1,r=e.edges.length;++i<r;)t=e.edges[i],t&&t.marked&&(n=t.to,t.marked=!1,n.marks--,0===n.marks&&a(n.node));e.fragmented()&&e.compact()}function a(e){var t,n,i,r,s=e.emitter,o=e.receiver,l=null===e.fn;if(g=e,c(e),e.cleanup(l),l||(e.value=e.fn()),s){for(t=-1,n=s.edges.length;++t<n;)i=s.edges[t],i&&i.marked&&(r=i.to,i.marked=!1,r.marks--,0===r.marks&&a(r.node));l?s.detach():s.fragmented()&&s.compact()}if(o)if(l)o.detach();else{for(t=-1,n=o.edges.length;++t<n;)i=o.edges[t],i.active&&i.age<h&&i.deactivate();o.fragmented()&&o.compact()}}function c(e){if(e.children){for(var t,n=-1,i=e.children.length;++n<i;)t=e.children[n],(!t.receiver||t.receiver.age<h)&&(c(t),t.dispose());e.children=null}}function l(e){function t(e){for(var n,i=-1,r=e.edges.length;++i<r;)n=e.edges[i],n&&n.marked&&(n.from.node&&n.from.node.receiver.marks?t(n.from.node.receiver):o(n.from))}var n=g,i=v;t(e),g=n,v=i}function u(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new b(t),n?n.activate(e):new E(e,t.receiver,t.gate&&(null===e.node||t.gate!==e.node.gate))}var h=1,f=0,d=[],g=null,v=!1,m=!1,p=[],y=function(n,i){var r=g,s=i&&i.async&&t(i.async)||r&&r.gate||null,o=new A(n,s);return!r||i&&i.toplevel||(r.children||(r.children=[])).push(o),g=o,f?o.value=n():o.value=e(o,n),g=r,function(){return m?f?p.push(o):o.dispose():g&&o.fn&&(o.receiver&&0!==o.receiver.marks&&o.receiver.age===h&&l(o.receiver),v||(o.emitter||(o.emitter=new x(o)),u(o.emitter,g))),o.value}};y.data=function(e){var t=new k(e);return function(e){if(arguments.length>0){if(f)if(t.age===h){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=h,t.pending=e,d[f++]=t;else t.age=h,t.value=e,t.emitter&&n(t);return e}return g&&!v&&(t.emitter||(t.emitter=new x(null)),u(t.emitter,g)),t.value}},y.sum=function(e){var t=new k(e);return function(i){return arguments.length>0?(f?t.age===h?t.pending=i(t.pending):(t.age=h,t.pending=i(t.value),d[f++]=t):(t.age=h,t.value=i(t.value),t.emitter&&n(t)),e):(g&&!v&&(t.emitter||(t.emitter=new x(null)),u(t.emitter,g)),t.value)}},y.on=function S(e,t,n,i){function S(){return"function"==typeof e?e():s(),o?o=!1:y.sample(r),n}function r(){n=t(n)}function s(){for(var t=0;t<e.length;t++)e[t]()}var o=!0;return y(S,i)},y.event=function(e){var t;if(f)t=e();else{f=1;try{t=e(),n(null)}finally{f=0}}return t},y.sample=function(e){var t;return g&&!v?(v=!0,t=e(),v=!1):t=e(),t},y.dispose=function(e){if(m)e();else{m=!0;try{e()}finally{m=!1}}},y.cleanup=function(e){if(!g)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(g.cleanups||(g.cleanups=[])).push(e)};var w=[],k=function(){function e(e){this.value=e,this.age=0,this.emitter=null}return e}(),A=function(){function e(e,t){this.fn=e,this.gate=t,this.emitter=null,this.receiver=null,this.children=null,this.cleanups=null}return e.prototype.dispose=function(){if(this.fn){if(this.fn=null,this.gate=null,this.children)for(var e=-1,t=this.children.length;++e<t;)this.children[e].dispose();this.cleanup(!0),this.receiver&&this.receiver.detach(),this.emitter&&this.emitter.detach()}},e.prototype.cleanup=function(e){if(this.cleanups){for(var t=-1,n=this.cleanups.length;++t<n;)this.cleanups[t](e);this.cleanups=null}},e}(),x=function(){function e(t){this.node=t,this.id=e.count++,this.emitting=!1,this.edges=[],this.index=[],this.active=0,this.edgesAge=0}return e.prototype.detach=function(){for(var e,t=-1,n=this.edges.length;++t<n;)e=this.edges[t],e&&e.deactivate()},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=++this.edgesAge;++t<n;)e=this.edges[t],e&&(e.slot=i.length,e.slotAge=r,i.push(e));this.edges=i},e.count=0,e}(),b=function(){function e(e){this.node=e,this.id=x.count++,this.marks=0,this.age=h,this.edges=[],this.index=[],this.active=0}return e.prototype.detach=function(){for(var e=-1,t=this.edges.length;++e<t;)this.edges[e].deactivate()},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=[];++t<n;)e=this.edges[t],e.active&&(i.push(e),r[e.from.id]=e);this.edges=i,this.index=r},e.count=0,e}(),E=function(){function e(e,t,n){this.from=e,this.to=t,this.boundary=n,this.age=h,this.active=!0,this.marked=!1,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e.prototype.activate=function(e){this.active||(this.active=!0,this.slotAge===e.edgesAge?e.edges[this.slot]=this:(this.slotAge=e.edgesAge,this.slot=e.edges.length,e.edges.push(this)),this.to.active++,e.active++,this.from=e),this.age=h},e.prototype.deactivate=function(){if(this.active){var e=this.from,t=this.to;this.active=!1,e.edges[this.slot]=null,e.active--,t.active--,this.from=null}},e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=y:"function"==typeof define?define([],function(){return y}):(eval||function(){})("this").S=y}();