!function(){"use strict";function e(e,t){var n=-1,i=e.length;try{for(;++n<i;)e[n]()}finally{p=t}}function t(e,t,n){var i;g++,d=!0;try{i=e(n),0!==v&&s(null)}finally{p=t,d=!1,v=0}return i}function n(e){w=!0;try{return e(),y}finally{w=!1}}function i(e){function t(){u||(u=!0,r(i),u=!1)}var n,i=new x(null),s=new E(null),o=!1,u=!1;return i.emitter=s,function(i){var r;return u?!0:(o?n&&n():(o=!0,c(s,i),r=e(t),"function"==typeof r&&(n=r)),!1)}}function r(e){try{s(e)}finally{d=!1,v=0,p=null}}function s(e){var t,n,i,r=0;for(d=!0,e&&(g++,o(e.emitter),u(e.emitter));0!==v;){for(g++,t=m,m=A,A=t,i=v,v=0,n=-1;++n<i;)e=t[n],e.value=e.pending,e.pending=void 0,e.emitter&&o(e.emitter);for(n=-1;++n<i;)e=t[n],e.emitter&&u(e.emitter),t[n]=null;if(r++>1e5)throw new Error("Runaway frames detected")}}function o(e){var t,n,i,r=e.edges,s=-1,u=r.length;for(e.emitting=!0;++s<u;)if(t=r[s],t&&(!t.boundary||t.to.node.gate(t.to.node))){if(n=t.to,i=n.node.emitter,n.age<g&&(n.marks=0,i&&(i.emitting=!1)),i&&i.emitting)throw new Error("circular dependency");t.marked=!0,n.marks++,n.age=g,1===n.marks&&i&&o(i)}e.emitting=!1}function u(e){for(var t,n,i=-1,r=e.edges.length;++i<r;)t=e.edges[i],t&&t.marked&&(n=t.to,t.marked=!1,n.marks--,0===n.marks&&l(n.node));r>10&&r/e.active>4&&e.compact()}function l(e){var t,n,i,r,s=e.emitter,o=e.receiver;for(t=-1,n=e.children.length;++t<n;)e.children[t].dispose();if(e.children=[],p=e,e.value=e.fn(e.self),s){for(t=-1,n=s.edges.length;++t<n;)i=s.edges[t],i&&i.marked&&(r=i.to,i.marked=!1,r.marks--,0===r.marks&&l(r.node));n>10&&n/s.active>4&&s.compact()}if(null!==o&&e.listening){for(t=-1,n=o.edges.length;++t<n;)i=o.edges[t],i.active&&i.age<g&&h(i);n>10&&n/o.active>4&&o.compact()}}function a(e){for(var t,n=-1,i=e.edges.length,r=p;++n<i;)t=e.edges[n],t&&t.marked&&(t.from.node&&t.from.node.receiver.marks?a(t.from.node.receiver):(u(t.from),p=r))}function c(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new S(t),n?f(n,e):new j(e,t.receiver,t.gate&&(null===e.node||t.gate!==e.node.gate))}function f(e,t){e.active||(e.active=!0,e.slotAge===t.edgesAge?t.edges[e.slot]=e:(e.slotAge=t.edgesAge,e.slot=t.edges.length,t.edges.push(e)),e.to.active++,t.active++,e.from=t),e.age=g}function h(e){if(e.active){var t=e.from,n=e.to;e.active=!1,t.edges[e.slot]=null,t.active--,n.active--,e.from=null}}var g=1,d=!1,m=[],v=0,p=null,w=!1,y=null,k=function(n){function i(){if(w)return void(y=l);if(l.fn&&(p&&p.listening&&(l.emitter||(l.emitter=new E(l)),c(l.emitter,p)),l.receiver&&0!==l.receiver.marks&&a(l.receiver),l.fn))return l.value}var r=this instanceof _?this:null,s=p,o=d,u=r&&r._gate||s&&s.gate||null,l=new b(n,u,i);return p=l,r&&r._watch&&(e(r._watch,s),l.listening=!1),r&&void 0!==r._pin?null!==r._pin&&r._pin.pins.push(l):s&&s.children.push(l),p=l,o?(l.value=n(i),p=s):l.value=t(n,s,i),i};k.data=function(e){var t=new x(e);return function(e){if(arguments.length>0){if(d)if(t.age===g){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=g,t.pending=e,m[v++]=t;else t.value=e,t.emitter&&r(t);return e}return p&&p.listening&&(t.emitter||(t.emitter=new E(null)),c(t.emitter,p)),t.value}},k.sum=function(e){var t=new x(e);return function(n){return arguments.length>0?(d?t.age===g?t.pending=n(t.pending):(t.age=g,t.pending=n(t.value),m[v++]=t):(t.value=e,t.emitter&&r(t)),e):(p&&p.listening&&(t.emitter||(t.emitter=new E(null)),c(t.emitter,p)),t.value)}};var _=function(){function e(){this._watch=null,this._pin=void 0,this._gate=null,this.S=k}return e.prototype.pin=function(e){return this._pin=e?n(e):null,this},e.prototype.async=function(e){return this._gate=i(e),this},e}();k.watch=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var n=new _;return n._watch=e,n},k.pin=function(e){return(new _).pin(e)},k.async=function(e){return(new _).async(e)},k.peek=function(e){if(!p||!p.listening)return e();p.listening=!1;try{return e()}finally{p.listening=!0}},k.cleanup=function(e){if(!p)throw new Error("S.cleanup() must be called from within an S.computation.  Cannot call it at toplevel.");p.cleanups.push(e)},k.dispose=function(e){var t=n(e);t&&t.dispose()},k.freeze=function(e){var t;if(d)t=e();else{g++,d=!0;try{t=e()}finally{d=!1}v>0&&r(null)}return t};var A=[],x=function(){function e(e){this.value=e,this.age=0,this.emitter=null}return e}(),b=function(){function e(e,t,n){this.fn=e,this.gate=t,this.self=n,this.emitter=null,this.receiver=null,this.listening=!0,this.pinning=!1,this.children=[],this.pins=[],this.cleanups=[]}return e.prototype.dispose=function(){if(this.fn){var e,t,n;if(p===this&&(p=null),this.fn=null,this.receiver)for(e=-1,t=this.receiver.edges.length;++e<t;)h(this.receiver.edges[e]);if(this.emitter)for(e=-1,t=this.emitter.edges.length;++e<t;)n=this.emitter.edges[e],n&&h(n);for(e=-1,t=this.children.length;++e<t;)this.children[e].dispose();for(e=-1,t=this.pins.length;++e<t;)this.pins[e].dispose()}},e}(),E=function(){function e(t){this.node=t,this.id=e.count++,this.emitting=!1,this.edges=[],this.index=[],this.active=0,this.edgesAge=0}return e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=++this.edgesAge;++t<n;)e=this.edges[t],e&&(e.slot=i.length,e.slotAge=r,i.push(e));this.edges=i},e.count=0,e}(),S=function(){function e(e){this.node=e,this.id=E.count++,this.marks=0,this.age=g,this.edges=[],this.index=[],this.active=0}return e.prototype.compact=function(){for(var e,t=-1,n=this.edges.length,i=[],r=[];++t<n;)e=this.edges[t],e.active&&(i.push(e),r[e.from.id]=e);this.edges=i,this.index=r},e.count=0,e}(),j=function(){function e(e,t,n){this.from=e,this.to=t,this.boundary=n,this.age=g,this.active=!0,this.marked=!1,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=k:"function"==typeof define?define([],function(){return k}):(eval||function(){})("this").S=k}();