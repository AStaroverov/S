!function(){"use strict";function n(n,t,e){try{return null===t?n():n(t)}finally{H=e}}function t(n){return function(){for(var t=0;t<n.length;t++)n[t]()}}function e(n,t){var e=0!==n.freecount?n.freeslots[--n.freecount]:n.count++,o=t.count++;n.nodes[e]=t,n.nodeslots[e]=o,t.sources[o]=n,t.sourceslots[o]=e}function o(n,t){null===n.log&&(n.log=new j),e(n.log,t)}function l(n,t){null===n.log&&(n.log=m()),e(n.log,t)}function c(n,t){if(null===t.preclocks)t.preclocks=new x;else if(t.preclocks.ages[n.id]===t.age)return;t.preclocks.ages[n.id]=t.age,t.preclocks.clocks[t.preclocks.count++]=n}function u(n,t,e){var o=null===t.preclocks?t.preclocks=new A:t.preclocks,l=null===e.preclocks?e.preclocks=new x:e.preclocks;if(l.ages[n.id]!==e.age){l.ages[n.id]=e.age,l.uclocks[l.ucount]=t,l.uclockids[l.ucount++]=n.id;var c=o.clockcounts[n.id];void 0===c?(o.ids[o.count++]=n.id,o.clockcounts[n.id]=1,o.clocks[n.id]=n):0===c?(o.clockcounts[n.id]=1,o.clocks[n.id]=n):o.clockcounts[n.id]++}}function r(){D.subclocks.reset(),D.updates.reset(),D.subtime++;try{i(D)}finally{F=H=G=null}}function s(n){F=D,D.changes.reset(),D.subclocks.reset(),D.updates.reset();try{n.value=n.fn(n.value),(D.changes.count>0||D.subclocks.count>0||D.updates.count>0)&&(D.subtime++,i(D))}finally{F=H=G=null}}function i(n){var t=F,e=0;for(F=n,n.disposes.reset();0!==n.changes.count||0!==n.subclocks.count||0!==n.updates.count||0!==n.disposes.count;)if(e>0&&n.subtime++,n.changes.run(a),n.subclocks.run(d),n.updates.run(k),n.disposes.run(v),e++>1e5)throw new Error("Runaway clock detected");F=t}function a(n){n.value=n.pending,n.pending=C,n.log&&f(n.log)}function f(n){for(var t,e,o=n.nodes,l=n.nodeslots,c=0,u=0;u<n.count;u++){var r=o[u];if(r){var s=r.clock.time();r.age<s&&(h(r.clock),r.age=s,r.state=q,r.clock.updates.add(r),r.owned&&p(r.owned),r.log&&f(r.log)),c&&(t=u-c,e=l[u],o[u]=null,o[t]=r,l[t]=e,r.sourceslots[e]=t)}else c++}n.count-=c,n.freecount=0}function p(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=e.clock.time(),e.state=R,null!==e.owned&&p(e.owned)}}function h(n){var t=0;(null!==n.parent&&n.age<(t=n.parent.time())||n.state===R)&&(null!==n.parent&&(n.age=t,h(n.parent),n.parent.subclocks.add(n)),n.changes.reset(),n.subclocks.reset(),n.updates.reset(),n.state=q)}function d(n){var t=n.parent.time();if(n.age<t||n.state===q){if(n.age<t&&(n.state=R),null!==n.preclocks)for(var e=0;e<n.preclocks.ids.length;e++){var o=n.preclocks.clocks[n.preclocks.ids[e]];o&&d(o)}n.age=t}if(n.state===B)throw new Error("clock circular reference");n.state===q&&(n.state=B,i(n),n.state=R)}function k(n){if(n.state===q){var t=H,e=G,o=F;H=G=n,F=n.clock,n.state=B,g(n,!1),n.value=n.fn(n.value),n.state=R,H=t,G=e,F=o}}function g(n,t){var e,o,l,c=n.sources,u=n.sourceslots,r=n.cleanups,s=n.owned,i=n.preclocks;if(null!==r){for(e=0;e<r.length;e++)r[e](t);n.cleanups=null}if(null!==s){for(e=0;e<s.length;e++)v(s[e]);n.owned=null}for(e=0;e<n.count;e++)o=c[e],l=u[e],o.nodes[l]=null,o.freeslots[o.freecount++]=l,c[e]=null;if(n.count=0,null!==i){for(e=0;e<i.count;e++)i.clocks[e]=null;for(i.count=0,e=0;e<i.ucount;e++){var a=i.uclocks[e].preclocks,f=i.uclockids[e];0===--a.clockcounts[f]&&(a.clocks[f]=null)}i.ucount=0}}function v(n){var t=n.log;if(n.clock=null,n.fn=null,n.preclocks=null,null!==t){n.log=null;for(var e=0;e<t.count;e++)t.nodes[e]=null;J.push(t)}g(n,!0),I.push(n)}function w(n,t,e){var o;return 0===I.length?o=new S(n,t,e):(o=I.pop(),o.age=n.time(),o.state=R,o.clock=n,o.fn=t,o.value=e),o}function m(){var n;return 0===J.length?n=new j:(n=J.pop(),n.count=0,n.freecount=0),n}var y=function(n,t){var e=H,o=null===F?D:F,r=G;if(null===e)throw new Error("all computations must be created under a parent computation or root");var i=w(o,n,t);return H=G=i,null===F?s(i):i.value=i.fn(i.value),e!==K&&(null===e.owned?e.owned=[i]:e.owned.push(i)),H=e,G=r,function(){if(i.fn!==n)return t;if(null!==G){for(var e=F,o=i.clock;e.depth>o.depth+1;)e=e.parent;if(e===o||e.parent===o){if(null!==i.preclocks)for(var r=0;r<i.preclocks.count;r++){var s=i.preclocks.clocks[r];d(s)}if(i.age===i.clock.time()){if(i.state===B)throw new Error("circular dependency");k(i)}if(null!==i.preclocks)for(var r=0;r<i.preclocks.count;r++){var s=i.preclocks.clocks[r];e===o?c(s,G):u(s,e,G)}}else{for(e.depth>o.depth&&(e=e.parent);o.depth>e.depth+1;)o=o.parent;if(o.parent===e)c(o,G);else{for(o.depth>e.depth&&(o=o.parent);e.parent!==o.parent;)e=e.parent,o=o.parent;u(o,e,G)}d(o)}l(i,G)}return t=i.value}};y.root=function L(t){var e=H,L=0===t.length?K:w(F||D,null,null),o=void 0,l=0===t.length?null:function(){null!==F?(h(L.clock),L.clock.disposes.add(L)):v(L)};return H=L,null===F?o=n(t,l,e):(o=null===l?t():t(l),H=e),o},y.on=function M(n,e,o,l){function M(t){var o=G;return n(),l?l=!1:(G=null,t=e(t),G=o),t}return Array.isArray(n)&&(n=t(n)),l=!!l,y(M,o)},y.data=function(n){var t=new E(null===F?D:F,n);return function(n){var e=F,l=t.clock;if(null!==F){for(;e.depth>l.depth;)e=e.parent;for(;l.depth>e.depth&&l.parent!==e;)l=l.parent;if(l.parent!==e)for(;e.parent!==l.parent;)e=e.parent,l=l.parent;e!==l&&d(l)}var s=e===l?l:l.parent;if(arguments.length>0){if(null!==F)if(t.pending!==C){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else h(s),t.pending=n,s.changes.add(t);else null!==t.log?(t.pending=n,D.changes.add(t),r()):t.value=n;return n}return null!==G&&(o(t,G),l.parent===e?c(l,G):l!==e&&u(l,e,G)),t.value}},y.value=function(n,t){var e=y.data(n),o=F||D,l=0;return function c(u){if(0===arguments.length)return e();var r=t?t(n,u):n===u;if(!r){var s=o.time();if(l===s)throw new Error("conflicting values: "+c+" is not the same as "+n);l=s,n=u,e(u)}return u}},y.freeze=function(n){var t=void 0;if(null!==F)t=n();else{F=D,F.changes.reset();try{t=n(),r()}finally{F=null}}return t},y.sample=function(n){var t,e=G;return null!==e?(G=null,t=n(),G=e):t=n(),t},y.cleanup=function(n){if(null===H)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");null===H.cleanups?H.cleanups=[n]:H.cleanups.push(n)},y.subclock=function N(n){function N(n){var e=null,o=F;F=t,t.state=q;try{e=n(),t.subtime++,i(t)}finally{F=o}return e}var t=new b(F||D);return void 0===n?N:N(n)};var b=function(){function n(t){this.parent=t,this.id=n.count++,this.state=R,this.subtime=0,this.preclocks=null,this.changes=new z,this.subclocks=new z,this.updates=new z,this.disposes=new z,null!==t?(this.age=t.time(),this.depth=t.depth+1):(this.age=0,this.depth=0)}return n.prototype.time=function(){for(var n=this.subtime,t=this;null!==(t=t.parent);)n+=t.subtime;return n},n}();b.count=0;var E=function(){function n(n,t){this.clock=n,this.value=t,this.pending=C,this.log=null}return n}(),S=function(){function n(n,t,e){this.clock=n,this.fn=t,this.value=e,this.state=R,this.count=0,this.sources=[],this.sourceslots=[],this.log=null,this.preclocks=null,this.owned=null,this.cleanups=null,this.age=this.clock.time()}return n}(),j=function(){function n(){this.count=0,this.nodes=[],this.nodeslots=[],this.freecount=0,this.freeslots=[]}return n}(),x=function(){function n(){this.count=0,this.clocks=[],this.ages=[],this.ucount=0,this.uclocks=[],this.uclockids=[]}return n}(),A=function(){function n(){this.count=0,this.clockcounts=[],this.clocks=[],this.ids=[]}return n}(),z=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=0;e<this.count;e++)n(t[e]),t[e]=null;this.count=0},n}(),C={},R=0,q=1,B=2,D=new b(null),F=null,G=null,H=null,I=[],J=[],K=w(D,null,null);"object"==typeof module&&"object"==typeof module.exports?module.exports=y:"function"==typeof define?define([],function(){return y}):(eval||function(){})("this").S=y}();