!function(){"use strict";function t(t){return function(){for(var n=0;n<t.length;n++)t[n]()}}function n(t,n){var e=t.freecount?t.freeslots[--t.freecount]:t.count++,o=n.count++;t.nodes[e]=n,t.nodeslots[e]=o,n.sources[o]=t,n.sourceslots[o]=e}function e(t,e){t.log||(t.log=new b),n(t.log,e)}function o(t,e){t.log||(t.log=new b),n(t.log,e)}function c(t,n){if(n.preclocks){if(n.preclocks.ages[t.id]===n.age)return}else n.preclocks=new E;n.preclocks.ages[t.id]=n.age,n.preclocks.clocks[n.preclocks.count++]=t}function s(t,n,e){var o=n.preclocks||(n.preclocks=new S),c=e.preclocks||(e.preclocks=new E);if(c.ages[t.id]!==e.age){c.ages[t.id]=e.age,c.uclocks[c.ucount]=n,c.uclockids[c.ucount++]=t.id;var s=o.clockcounts[t.id];s?o.clockcounts[t.id]++:(void 0===s&&(o.ids[o.count++]=t.id),o.clockcounts[t.id]=1,o.clocks[t.id]=t)}}function r(){R.subclocks.reset(),R.updates.reset(),R.subtime++;try{l(R)}finally{q=D=B=null}}function u(t){q=R,R.changes.reset(),R.subclocks.reset(),R.updates.reset();try{t.value=t.fn(t.value),(R.changes.count>0||R.subclocks.count>0||R.updates.count>0)&&(R.subtime++,l(R))}finally{q=D=B=null}}function l(t){var n=q,e=0;for(q=t,t.disposes.reset();0!==t.changes.count||0!==t.subclocks.count||0!==t.updates.count||0!==t.disposes.count;)if(e>0&&t.subtime++,t.changes.run(i),t.subclocks.run(h),t.updates.run(d),t.disposes.run(g),e++>1e5)throw new Error("Runaway clock detected");q=n}function i(t){t.value=t.pending,t.pending=x,t.log&&a(t.log)}function a(t){for(var n,e,o=t.nodes,c=t.nodeslots,s=0,r=0;r<t.count;r++){var u=o[r];if(u){var l=u.clock.time();u.age<l&&(p(u.clock),u.age=l,u.state=z,u.clock.updates.add(u),u.owned&&f(u.owned),u.log&&a(u.log)),s&&(n=r-s,e=c[r],o[r]=null,o[n]=u,c[n]=e,u.sourceslots[e]=n)}else s++}t.count-=s,t.freecount=0}function f(t){for(var n=0;n<t.length;n++){var e=t[n];e.age=e.clock.time(),e.state=A,e.owned&&f(e.owned)}}function p(t){var n=0;(t.parent&&t.age<(n=t.parent.time())||t.state===A)&&(t.parent&&(t.age=n,p(t.parent),t.parent.subclocks.add(t)),t.changes.reset(),t.subclocks.reset(),t.updates.reset(),t.state=z)}function h(t){var n=t.parent.time();if(t.age<n||t.state===z){if(t.age<n&&(t.state=A),t.preclocks)for(var e=0;e<t.preclocks.ids.length;e++){var o=t.preclocks.clocks[t.preclocks.ids[e]];o&&h(o)}t.age=n}if(t.state===C)throw new Error("clock circular reference");t.state===z&&(t.state=C,l(t),t.state=A)}function d(t){if(t.state===z){var n=D,e=B,o=q;D=B=t,q=t.clock,t.state=C,k(t,!1),t.value=t.fn(t.value),t.state=A,D=n,B=e,q=o}}function k(t,n){var e,o,c,s=t.sources,r=t.sourceslots,u=t.cleanups,l=t.owned,i=t.preclocks;if(u){for(e=0;e<u.length;e++)u[e](n);t.cleanups=null}if(l){for(e=0;e<l.length;e++)g(l[e]);t.owned=null}for(e=0;e<t.count;e++)o=s[e],c=r[e],o.nodes[c]=null,o.freeslots[o.freecount++]=c,s[e]=null;if(t.count=0,i){for(e=0;e<i.count;e++)i.clocks[e]=null;for(i.count=0,e=0;e<i.ucount;e++){var a=i.uclocks[e].preclocks,f=i.uclockids[e];0===--a.clockcounts[f]&&(a.clocks[f]=null)}i.ucount=0}}function g(t){t.fn=null,t.log=null,t.preclocks=null,k(t,!0)}var v=function(t,n){var e=D,r=q||R,l=B;if(!e)throw new Error("all computations must be created under a parent computation or root");var i=new y(r,t,n);return D=B=i,q?i.value=i.fn(i.value):u(i),e!==F&&(e.owned||(e.owned=[])).push(i),D=e,B=l,function(){if(B){for(var t=q,n=i.clock;t.depth>n.depth+1;)t=t.parent;if(t===n||t.parent===n){if(i.preclocks)for(var e=0;e<i.preclocks.count;e++){var r=i.preclocks.clocks[e];h(r)}if(i.age===i.clock.time()){if(i.state===C)throw new Error("circular dependency");d(i)}if(i.preclocks)for(var e=0;e<i.preclocks.count;e++){var r=i.preclocks.clocks[e];t===n?c(r,B):s(r,t,B)}}else{for(t.depth>n.depth&&(t=t.parent);n.depth>t.depth+1;)n=n.parent;if(n.parent===t)c(n,B);else{for(n.depth>t.depth&&(n=n.parent);t.parent!==n.parent;)t=t.parent,n=n.parent;s(n,t,B)}h(n)}o(i,B)}return i.value}};v.root=function G(t){var n=D,G=0===t.length?F:new y(q||R,null,null),e=void 0;D=G;try{e=0===t.length?t():t(function(){q?(p(G.clock),G.clock.disposes.add(G)):g(G)})}finally{D=n}return e},v.on=function H(n,e,o,c){function H(t){var o=B;return n(),c?c=!1:(B=null,t=e(t),B=o),t}return Array.isArray(n)&&(n=t(n)),c=!!c,v(H,o)},v.data=function(t){var n=new m(q||R,t);return function(t){var o=q,u=n.clock;if(q){for(;o.depth>u.depth;)o=o.parent;for(;u.depth>o.depth&&u.parent!==o;)u=u.parent;if(u.parent!==o)for(;o.parent!==u.parent;)o=o.parent,u=u.parent;o!==u&&h(u)}var l=o===u?u:u.parent;if(arguments.length>0){if(q)if(n.pending!==x){if(t!==n.pending)throw new Error("conflicting changes: "+t+" !== "+n.pending)}else p(l),n.pending=t,l.changes.add(n);else n.log?(n.pending=t,R.changes.add(n),r()):n.value=t;return t}return B&&(e(n,B),u.parent===o?c(u,B):u!==o&&s(u,o,B)),n.value}},v.value=function(t,n){var e=v.data(t),o=q||R,c=0;return function s(r){if(0===arguments.length)return e();var u=n?n(t,r):t===r;if(!u){var l=o.time();if(c===l)throw new Error("conflicting values: "+s+" is not the same as "+t);c=l,t=r,e(r)}return r}},v.freeze=function(t){var n=void 0;if(q)n=t();else{q=R,q.changes.reset();try{n=t(),r()}finally{q=null}}return n},v.sample=function(t){var n,e=B;return e?(B=null,n=t(),B=e):n=t(),n},v.cleanup=function(t){if(!D)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(D.cleanups||(D.cleanups=[])).push(t)},v.subclock=function I(t){function I(t){var e=null,o=q;q=n,n.state=z;try{e=t(),n.subtime++,l(n)}finally{q=o}return e}var n=new w(q||R);return t?I(t):I};var w=function(){function t(n){this.parent=n,this.id=t.count++,this.state=A,this.subtime=0,this.preclocks=null,this.changes=new j,this.subclocks=new j,this.updates=new j,this.disposes=new j,n?(this.age=n.time(),this.depth=n.depth+1):(this.age=0,this.depth=0)}return t.prototype.time=function(){for(var t=this.subtime,n=this;n=n.parent;)t+=n.subtime;return t},t}();w.count=0;var m=function(){function t(t,n){this.clock=t,this.value=n,this.pending=x,this.log=null}return t}(),y=function(){function t(t,n,e){this.clock=t,this.fn=n,this.value=e,this.state=A,this.count=0,this.sources=[],this.sourceslots=[],this.log=null,this.preclocks=null,this.owned=null,this.cleanups=null,this.age=this.clock.time()}return t}(),b=function(){function t(){this.count=0,this.nodes=[],this.nodeslots=[],this.freecount=0,this.freeslots=[]}return t}(),E=function(){function t(){this.count=0,this.clocks=[],this.ages=[],this.ucount=0,this.uclocks=[],this.uclockids=[]}return t}(),S=function(){function t(){this.count=0,this.clockcounts=[],this.clocks=[],this.ids=[]}return t}(),j=function(){function t(){this.items=[],this.count=0}return t.prototype.reset=function(){this.count=0},t.prototype.add=function(t){this.items[this.count++]=t},t.prototype.run=function(t){for(var n=this.items,e=0;e<this.count;e++)t(n[e]),n[e]=null;this.count=0},t}(),x={},A=0,z=1,C=2,R=new w(null),q=null,B=null,D=null,F=new y(R,null,null);"object"==typeof module&&"object"==typeof module.exports?module.exports=v:"function"==typeof define?define([],function(){return v}):(eval||function(){})("this").S=v}();