!function(){"use strict";function e(e,t){var n;c++,d=1;try{e.trait&&(e.fn=e.trait(e.fn)),t&&(e.fn=t(e.fn)),n=e.fn(),d>1&&r(null)}finally{p=null,m=!1,d=0}return n}function t(e,t){return function(n){return e(t(n))}}function n(e){function t(){n(!0)}var n=k.data(!1),i=e(t);return function r(e){var t=!0;return p&&(p.trait=r),function(){return t?(t=!1,e()):k.sample(n)?(n(!1),e()):(n(),i&&i(),k.hold())}}}function i(e){try{r(e)}finally{d=0,p=null,m=!1,v=!1}}function r(e){var t,n,i,r=0;if(d||(d=1),e&&(c++,l(e.emitter,null),h(o,e.emitter,null),y.length)){for(n=0;n<y.length;n++)y[n].dispose();y=[]}for(;1!==d;){for(c++,t=g,g=x,x=t,i=d,d=1,n=1;i>n;n++)e=t[n],e.value=e.pending,e.pending=void 0,l(e.emitter,null);for(n=1;i>n;n++)e=t[n],h(o,e.emitter,null),t[n]=null;if(y.length){for(n=0;n<y.length;n++)y[n].dispose();y=[]}if(r++>1e5)throw new Error("Runaway frames detected")}}function s(e){e.children;if(e.age===c){if(e.emitter&&e.emitter.emitting)throw new Error("circular dependency");e.marks++}else e.age=c,e.marks=1,e.updates=0,l(e.emitter,e.children)}function o(e){if(e.updates++,e.marks==e.updates){var t=e.receiver,n=e.children;p=e,e.cleanup(!1),e.children=null;var i=e.fn();if(i!==w){if(e.value=i,n)for(var r=0;r<n.length;r++)n[r].dispose();if(h(o,e.emitter,null),t){for(var r=0;r<t.edges.length;r++){var s=t.edges[r];s.from&&s.age<c&&s.deactivate()}t.fragmented()&&t.compact()}}else e.children=n?e.children?n.concat(e.children):n:e.children,h(a,e.emitter,n)}}function a(e){e.marks--,e.marks===e.updates&&(e.marks>0?o(e):h(a,e.emitter,e.children))}function u(e){function t(e){for(var n=e.receiver.edges,i=0;i<n.length;i++){var r=n[i];if(r.marked){var s=r.from.node;if(s){if(s.age!==c)continue;s.marks===s.updates?o(s):t(s)}else h(o,r.from,null)}}e.parent&&e.parent.age===c&&e.parent.marks!==e.parent.updates&&t(e.parent)}var n=p,i=m;m=!1,t(e),p=n,m=i}function l(e,t){if(e){var n=e.edges;e.emitting=!0;for(var i=0;i<n.length;i++){var r=n[i];r&&(r.marked=!0,s(r.to.node))}if(t)for(i=0;i<t.length;i++)s(t[i]);e.emitting=!1}}function h(e,t,n){if(t){var i=t.edges;t.emitting=!0;for(var r=0;r<i.length;r++){var s=i[r];s&&s.marked&&(s.marked=!1,e(s.to.node))}if(n)for(r=0;r<n.length;r++)e(n[r]);t.emitting=!1}}function f(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new j(t),n?n.activate(e):new C(e,t.receiver)}var c=1,d=0,g=[],p=null,m=!1,v=!1,y=[],w={},k=function(t){var n,i=p,r=m,s=this instanceof A?this.mod:null,o=new E(t,i,i&&i.trait);return p=o,m=!1,d?(s&&(o.fn=s(o.fn)),o.trait&&(o.fn=o.trait(o.fn)),n=o.fn()):n=e(o,s),n!==w&&(o.value=n),o.parent&&(o.parent.children||(o.parent.children=[])).push(o),p=i,m=r,function(){return v?d?y.push(o):o.dispose():p&&o.fn&&(o.age===c&&o.marks!==o.updates&&u(o),m||(o.emitter||(o.emitter=new b(o)),f(o.emitter,p))),o.value}};k.on=function R(e,t,n){function R(){return e(),i?i=!1:p&&!m?(m=!0,n=t(n),m=!1):n=t(n),n}var i=!0;return this instanceof A?this.S(R):k(R)},k.data=function(e){var t=new S(e);return function(e){if(arguments.length>0){if(d)if(t.age===c){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=c,t.pending=e,g[d++]=t;else t.age=c,t.value=e,t.emitter&&i(t);return e}return p&&!m&&(t.emitter||(t.emitter=new b(null)),f(t.emitter,p)),t.value}},k.sum=function(e){var t=new S(e);return function(n){return arguments.length>0?(d?t.age===c?t.pending=n(t.pending):(t.age=c,t.pending=n(t.value),g[d++]=t):(t.age=c,t.value=n(t.value),t.emitter&&i(t)),e):(p&&!m&&(t.emitter||(t.emitter=new b(null)),f(t.emitter,p)),t.value)}},k.event=function(e){var t;if(d)t=e();else{d=1;try{t=e(),i(null)}finally{d=0}}return t},k.sample=function(e){var t;return p&&!m?(m=!0,t=e(),m=!1):t=e(),t},k.hold=function(){return w};var A=function(){function e(e,n){this.mod=e&&e.mod?t(e.mod,n):n}return e.prototype.async=function(t){return new e(this,n(t))},e}();A.prototype.S=k,A.prototype.on=k.on,k.orphan=function(){return new A(null,function(e){return p.parent=null,e})},k.async=function(e){return new A(null,n(e))},k.dispose=function(e){if(v)e();else{v=!0;try{e()}finally{v=!1}}},k.cleanup=function(e){if(!p)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(p.cleanups||(p.cleanups=[])).push(e)};var x=[],S=function(){function e(e){this.value=e,this.age=0,this.emitter=null}return e}(),E=function(){function e(e,t,n){this.fn=e,this.parent=t,this.trait=n,this.age=c,this.marks=0,this.updates=0,this.emitter=null,this.receiver=null,this.children=null,this.cleanups=null}return e.prototype.dispose=function(){if(this.fn){if(this.fn=null,this.parent=null,this.trait=null,this.age===c&&this.marks!==this.updates&&h(a,this.emitter,null),this.cleanup(!0),this.children){for(var e=0;e<this.children.length;e++)this.children[e].dispose();this.children=null}this.receiver&&this.receiver.detach(),this.emitter&&this.emitter.detach()}},e.prototype.cleanup=function(e){if(this.cleanups){for(var t=0;t<this.cleanups.length;t++)this.cleanups[t](e);this.cleanups=null}},e}(),b=function(){function e(t){this.node=t,this.id=e.count++,this.emitting=!1,this.edges=[],this.active=0,this.edgesAge=0}return e.prototype.detach=function(){for(var e=0;e<this.edges.length;e++){var t=this.edges[e];t&&t.deactivate()}},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e=[],t=++this.edgesAge,n=0;n<this.edges.length;n++){var i=this.edges[n];i&&(i.slot=e.length,i.slotAge=t,e.push(i))}this.edges=e},e.count=0,e}(),j=function(){function e(e){this.node=e,this.id=b.count++,this.edges=[],this.index=[],this.active=0}return e.prototype.detach=function(){for(var e=0;e<this.edges.length;e++)this.edges[e].deactivate()},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e=[],t=[],n=0;n<this.edges.length;n++){var i=this.edges[n];i.from&&(e.push(i),t[i.from.id]=i)}this.edges=e,this.index=t},e.count=0,e}(),C=function(){function e(e,t){this.from=e,this.to=t,this.age=c,this.marked=!1,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e.prototype.activate=function(e){this.from||(this.from=e,this.slotAge===e.edgesAge?e.edges[this.slot]=this:(this.slotAge=e.edgesAge,this.slot=e.edges.length,e.edges.push(this)),this.to.active++,e.active++),this.age=c},e.prototype.deactivate=function(){if(this.from){var e=this.from,t=this.to;this.from=null,e.edges[this.slot]=null,e.active--,t.active--}},e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=k:"function"==typeof define?define([],function(){return k}):(eval||function(){})("this").S=k}();