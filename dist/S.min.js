!function(){"use strict";function e(e,t){var n;d++,g=1;try{n=t(),g>1&&s(null)}finally{m=null,p=!1,g=0}return n}function t(e,t){return function(n){return e(t(n))}}function n(e){var t=e;return function(e){var n=t;return function(){return n=e(n)}}}function i(e,t){var n=e;return function(e){var i=n;return function(){return i=e(i,t)}}}function r(e){try{s(e)}finally{g=0,m=null,p=!1,y=!1}}function s(e){var t,n,i,r=0;if(g||(g=1),e&&(d++,h(u,e.emitter),c(a,e.emitter),w.length)){for(n=0;n<w.length;n++)w[n].dispose();w=[]}for(;1!==g;){for(d++,t=v,v=E,E=t,i=g,g=1,n=1;i>n;n++)e=t[n],e.value=e.pending,e.pending=void 0,h(u,e.emitter);for(n=1;i>n;n++)e=t[n],c(a,e.emitter),t[n]=null;if(w.length){for(n=0;n<w.length;n++)w[n].dispose();w=[]}if(r++>1e5)throw new Error("Runaway frames detected")}}function u(e){var t=e.children;if(e.age===d){if(e.emitter&&e.emitter.emitting)throw new Error("circular dependency");e.marks++}else{if(e.age=d,e.marks=1,e.updates=0,t)for(var n=0;n<t.length;n++)u(t[n]);h(u,e.emitter)}}function a(e){if(e.updates++,e.marks==e.updates){var t=e.receiver;m=e,e.cleanup(!1);var n=e.fn();if(n!==k){if(e.value=n,c(a,e.emitter),t){for(var i=0;i<t.edges.length;i++){var r=t.edges[i];r.from&&r.age<d&&r.deactivate()}t.fragmented()&&t.compact()}}else c(o,e.emitter)}}function o(e){if(e.marks--,e.marks===e.updates)if(e.marks>0)a(e);else if(c(o,e.emitter),e.children)for(var t=0;t<e.children.length;t++)o(e.children[t])}function l(e){function t(e){for(var n=e.receiver.edges,i=0;i<n.length;i++){var r=n[i];if(r.marked){var s=r.from.node;s?s.marks===s.updates?a(s):t(s):c(a,r.from)}}}var n=m,i=p;p=!1,t(e),m=n,p=i}function h(e,t){if(t){var n=t.edges;t.emitting=!0;for(var i=0;i<n.length;i++){var r=n[i];r&&(r.marked=!0,e(r.to.node))}t.emitting=!1}}function c(e,t){if(t){var n=t.edges;t.emitting=!0;for(var i=0;i<n.length;i++){var r=n[i];r&&r.marked&&(r.marked=!1,e(r.to.node))}t.emitting=!1}}function f(e,t){var n=null;t.receiver?n=t.receiver.index[e.id]:t.receiver=new C(t),n?n.activate(e):new R(e,t.receiver)}var d=1,g=0,v=[],m=null,p=!1,y=!1,w=[],k={},A=!1,x=function(t){var n,i=m,r=p,s=i?i.trait:null,u=s?s(t):t,a=new S(u,s);return m=a,p=!1,A=!1,n=g?u():e(a,u),n!==k&&(a.value=n),A?A=!1:i&&(i.children||(i.children=[])).push(a),m=i,p=r,function(){return y?g?w.push(a):a.dispose():m&&a.fn&&(a.age===d&&a.marks!==a.updates&&l(a),p||(a.emitter||(a.emitter=new j(a)),f(a.emitter,m))),a.value}};x.on=function q(e,t,r,s){function q(){return e(),u?(u=!1,r):x.sample(t)}var u=!0;return t=arguments.length<=2?t:3===arguments.length?n(r)(t):i(r,s)(t),x(q)},x.data=function(e){var t=new b(e);return function(e){if(arguments.length>0){if(g)if(t.age===d){if(e!==t.pending)throw new Error("conflicting changes: "+e+" !== "+t.pending)}else t.age=d,t.pending=e,v[g++]=t;else t.age=d,t.value=e,t.emitter&&r(t);return e}return m&&!p&&(t.emitter||(t.emitter=new j(null)),f(t.emitter,m)),t.value}},x.sum=function(e){var t=new b(e);return function(n){return arguments.length>0?(g?t.age===d?t.pending=n(t.pending):(t.age=d,t.pending=n(t.value),v[g++]=t):(t.age=d,t.value=n(t.value),t.emitter&&r(t)),e):(m&&!p&&(t.emitter||(t.emitter=new j(null)),f(t.emitter,m)),t.value)}},x.event=function(e){var t;if(g)t=e();else{g=1;try{t=e(),r(null)}finally{g=0}}return t},x.sample=function(e){var t;return m&&!p?(p=!0,t=e(),p=!1):t=e(),t},x.hold=function(){return k},x.trait=function(e){return function(n){var i=!0;return n=e(n),function(){return i&&m&&(m.trait=m.trait?t(m.trait,e):e,i=!1),n()}}},x.toplevel=function(e){return function(){var t=e();return A=!0,t}},x.async=function z(e){function z(e){var t=!0;return function(){return t?(t=!1,e()):x.sample(n)?(n(!1),e()):(n(),i&&i(),x.hold())}}function t(){n(!0)}var n=x.data(!1),i=e(t);return x.trait(z)},x.dispose=function(e){if(y)e();else{y=!0;try{e()}finally{y=!1}}},x.cleanup=function(e){if(!m)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");(m.cleanups||(m.cleanups=[])).push(e)};var E=[],b=function(){function e(e){this.value=e,this.age=0,this.emitter=null}return e}(),S=function(){function e(e,t){this.fn=e,this.trait=t,this.age=d,this.marks=0,this.updates=0,this.emitter=null,this.receiver=null,this.children=null,this.cleanups=null}return e.prototype.dispose=function(){this.fn&&(this.fn=null,this.trait=null,this.age===d&&this.marks!==this.updates&&c(o,this.emitter),this.cleanup(!0),this.receiver&&this.receiver.detach(),this.emitter&&this.emitter.detach())},e.prototype.cleanup=function(e){if(this.children){for(var t=0;t<this.children.length;t++)this.children[t].dispose();this.children=null}if(this.cleanups){for(t=0;t<this.cleanups.length;t++)this.cleanups[t](e);this.cleanups=null}},e}(),j=function(){function e(t){this.node=t,this.id=e.count++,this.emitting=!1,this.edges=[],this.active=0,this.edgesAge=0}return e.prototype.detach=function(){for(var e=0;e<this.edges.length;e++){var t=this.edges[e];t&&t.deactivate()}},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e=[],t=++this.edgesAge,n=0;n<this.edges.length;n++){var i=this.edges[n];i&&(i.slot=e.length,i.slotAge=t,e.push(i))}this.edges=e},e.count=0,e}(),C=function(){function e(e){this.node=e,this.id=j.count++,this.edges=[],this.index=[],this.active=0}return e.prototype.detach=function(){for(var e=0;e<this.edges.length;e++)this.edges[e].deactivate()},e.prototype.fragmented=function(){return this.edges.length>10&&this.edges.length/this.active>4},e.prototype.compact=function(){for(var e=[],t=[],n=0;n<this.edges.length;n++){var i=this.edges[n];i.from&&(e.push(i),t[i.from.id]=i)}this.edges=e,this.index=t},e.count=0,e}(),R=function(){function e(e,t){this.from=e,this.to=t,this.age=d,this.marked=!1,this.slot=e.edges.length,this.slotAge=e.edgesAge,e.edges.push(this),t.edges.push(this),t.index[e.id]=this,e.active++,t.active++}return e.prototype.activate=function(e){this.from||(this.from=e,this.slotAge===e.edgesAge?e.edges[this.slot]=this:(this.slotAge=e.edgesAge,this.slot=e.edges.length,e.edges.push(this)),this.to.active++,e.active++),this.age=d},e.prototype.deactivate=function(){if(this.from){var e=this.from,t=this.to;this.from=null,e.edges[this.slot]=null,e.active--,t.active--}},e}();"object"==typeof module&&"object"==typeof module.exports?module.exports=x:"function"==typeof define?define([],function(){return x}):(eval||function(){})("this").S=x}();