!function(){"use strict";function n(n){return function(){for(var t=0;t<n.length;t++)n[t]()}}function t(n,t){var e=0!==n.freecount?n.freeslots[--n.freecount]:n.count++,o=t.count++;n.nodes[e]=t,n.nodeslots[e]=o,t.sources[o]=n,t.sourceslots[o]=e}function e(n,e){null===n.log&&(n.log=new S),t(n.log,e)}function o(n,e){null===n.log&&(n.log=w()),t(n.log,e)}function c(n,t){if(null===t.preclocks)t.preclocks=new j;else if(t.preclocks.ages[n.id]===t.age)return;t.preclocks.ages[n.id]=t.age,t.preclocks.clocks[t.preclocks.count++]=n}function l(n,t,e){var o=null===t.preclocks?t.preclocks=new x:t.preclocks,c=null===e.preclocks?e.preclocks=new j:e.preclocks;if(c.ages[n.id]!==e.age){c.ages[n.id]=e.age,c.uclocks[c.ucount]=t,c.uclockids[c.ucount++]=n.id;var l=o.clockcounts[n.id];void 0===l?(o.ids[o.count++]=n.id,o.clockcounts[n.id]=1,o.clocks[n.id]=n):0===l?(o.clockcounts[n.id]=1,o.clocks[n.id]=n):o.clockcounts[n.id]++}}function u(){B.subclocks.reset(),B.updates.reset(),B.subtime++;try{s(B)}finally{D=G=F=null}}function r(n){D=B,B.changes.reset(),B.subclocks.reset(),B.updates.reset();try{n.value=n.fn(n.value),(B.changes.count>0||B.subclocks.count>0||B.updates.count>0)&&(B.subtime++,s(B))}finally{D=G=F=null}}function s(n){var t=D,e=0;for(D=n,n.disposes.reset();0!==n.changes.count||0!==n.subclocks.count||0!==n.updates.count||0!==n.disposes.count;)if(e>0&&n.subtime++,n.changes.run(i),n.subclocks.run(h),n.updates.run(d),n.disposes.run(g),e++>1e5)throw new Error("Runaway clock detected");D=t}function i(n){n.value=n.pending,n.pending=z,n.log&&a(n.log)}function a(n){for(var t,e,o=n.nodes,c=n.nodeslots,l=0,u=0;u<n.count;u++){var r=o[u];if(r){var s=r.clock.time();r.age<s&&(p(r.clock),r.age=s,r.state=R,r.clock.updates.add(r),r.owned&&f(r.owned),r.log&&a(r.log)),l&&(t=u-l,e=c[u],o[u]=null,o[t]=r,c[t]=e,r.sourceslots[e]=t)}else l++}n.count-=l,n.freecount=0}function f(n){for(var t=0;t<n.length;t++){var e=n[t];e.age=e.clock.time(),e.state=C,null!==e.owned&&f(e.owned)}}function p(n){var t=0;(null!==n.parent&&n.age<(t=n.parent.time())||n.state===C)&&(null!==n.parent&&(n.age=t,p(n.parent),n.parent.subclocks.add(n)),n.changes.reset(),n.subclocks.reset(),n.updates.reset(),n.state=R)}function h(n){var t=n.parent.time();if(n.age<t||n.state===R){if(n.age<t&&(n.state=C),null!==n.preclocks)for(var e=0;e<n.preclocks.ids.length;e++){var o=n.preclocks.clocks[n.preclocks.ids[e]];o&&h(o)}n.age=t}if(n.state===q)throw new Error("clock circular reference");n.state===R&&(n.state=q,s(n),n.state=C)}function d(n){if(n.state===R){var t=G,e=F,o=D;G=F=n,D=n.clock,n.state=q,k(n,!1),n.value=n.fn(n.value),n.state=C,G=t,F=e,D=o}}function k(n,t){var e,o,c,l=n.sources,u=n.sourceslots,r=n.cleanups,s=n.owned,i=n.preclocks;if(null!==r){for(e=0;e<r.length;e++)r[e](t);n.cleanups=null}if(null!==s){for(e=0;e<s.length;e++)g(s[e]);n.owned=null}for(e=0;e<n.count;e++)o=l[e],c=u[e],o.nodes[c]=null,o.freeslots[o.freecount++]=c,l[e]=null;if(n.count=0,null!==i){for(e=0;e<i.count;e++)i.clocks[e]=null;for(i.count=0,e=0;e<i.ucount;e++){var a=i.uclocks[e].preclocks,f=i.uclockids[e];0===--a.clockcounts[f]&&(a.clocks[f]=null)}i.ucount=0}}function g(n){var t=n.log;if(n.clock=null,n.fn=null,n.preclocks=null,null!==t){n.log=null;for(var e=0;e<t.count;e++)t.nodes[e]=null;I.push(t)}k(n,!0),H.push(n)}function v(n,t,e){var o;return 0===H.length?o=new E(n,t,e):(o=H.pop(),o.age=n.time(),o.state=C,o.clock=n,o.fn=t,o.value=e),o}function w(){var n;return 0===I.length?n=new S:(n=I.pop(),n.count=0,n.freecount=0),n}var m=function(n,t){var e=G,u=null===D?B:D,s=F;if(null===e)throw new Error("all computations must be created under a parent computation or root");var i=v(u,n,t);return G=F=i,null===D?r(i):i.value=i.fn(i.value),e!==J&&(null===e.owned?e.owned=[i]:e.owned.push(i)),G=e,F=s,function(){if(i.fn!==n)return t;if(null!==F){for(var e=D,u=i.clock;e.depth>u.depth+1;)e=e.parent;if(e===u||e.parent===u){if(null!==i.preclocks)for(var r=0;r<i.preclocks.count;r++){var s=i.preclocks.clocks[r];h(s)}if(i.age===i.clock.time()){if(i.state===q)throw new Error("circular dependency");d(i)}if(null!==i.preclocks)for(var r=0;r<i.preclocks.count;r++){var s=i.preclocks.clocks[r];e===u?c(s,F):l(s,e,F)}}else{for(e.depth>u.depth&&(e=e.parent);u.depth>e.depth+1;)u=u.parent;if(u.parent===e)c(u,F);else{for(u.depth>e.depth&&(u=u.parent);e.parent!==u.parent;)e=e.parent,u=u.parent;l(u,e,F)}h(u)}o(i,F)}return t=i.value}};m.root=function K(n){var t=G,K=0===n.length?J:v(D||B,null,null),e=void 0;G=K;try{e=0===n.length?n():n(function(){null!==D?(p(K.clock),K.clock.disposes.add(K)):g(K)})}finally{G=t}return e},m.on=function L(t,e,o,c){function L(n){var o=F;return t(),c?c=!1:(F=null,n=e(n),F=o),n}return Array.isArray(t)&&(t=n(t)),c=!!c,m(L,o)},m.data=function(n){var t=new b(null===D?B:D,n);return function(n){var o=D,r=t.clock;if(null!==D){for(;o.depth>r.depth;)o=o.parent;for(;r.depth>o.depth&&r.parent!==o;)r=r.parent;if(r.parent!==o)for(;o.parent!==r.parent;)o=o.parent,r=r.parent;o!==r&&h(r)}var s=o===r?r:r.parent;if(arguments.length>0){if(null!==D)if(t.pending!==z){if(n!==t.pending)throw new Error("conflicting changes: "+n+" !== "+t.pending)}else p(s),t.pending=n,s.changes.add(t);else null!==t.log?(t.pending=n,B.changes.add(t),u()):t.value=n;return n}return null!==F&&(e(t,F),r.parent===o?c(r,F):r!==o&&l(r,o,F)),t.value}},m.value=function(n,t){var e=m.data(n),o=D||B,c=0;return function l(u){if(0===arguments.length)return e();var r=t?t(n,u):n===u;if(!r){var s=o.time();if(c===s)throw new Error("conflicting values: "+l+" is not the same as "+n);c=s,n=u,e(u)}return u}},m.freeze=function(n){var t=void 0;if(null!==D)t=n();else{D=B,D.changes.reset();try{t=n(),u()}finally{D=null}}return t},m.sample=function(n){var t,e=F;return null!==e?(F=null,t=n(),F=e):t=n(),t},m.cleanup=function(n){if(null===G)throw new Error("S.cleanup() must be called from within an S() computation.  Cannot call it at toplevel.");null===G.cleanups?G.cleanups=[n]:G.cleanups.push(n)},m.subclock=function M(n){function M(n){var e=null,o=D;D=t,t.state=R;try{e=n(),t.subtime++,s(t)}finally{D=o}return e}var t=new y(D||B);return void 0===n?M:M(n)};var y=function(){function n(t){this.parent=t,this.id=n.count++,this.state=C,this.subtime=0,this.preclocks=null,this.changes=new A,this.subclocks=new A,this.updates=new A,this.disposes=new A,null!==t?(this.age=t.time(),this.depth=t.depth+1):(this.age=0,this.depth=0)}return n.prototype.time=function(){for(var n=this.subtime,t=this;null!==(t=t.parent);)n+=t.subtime;return n},n}();y.count=0;var b=function(){function n(n,t){this.clock=n,this.value=t,this.pending=z,this.log=null}return n}(),E=function(){function n(n,t,e){this.clock=n,this.fn=t,this.value=e,this.state=C,this.count=0,this.sources=[],this.sourceslots=[],this.log=null,this.preclocks=null,this.owned=null,this.cleanups=null,this.age=this.clock.time()}return n}(),S=function(){function n(){this.count=0,this.nodes=[],this.nodeslots=[],this.freecount=0,this.freeslots=[]}return n}(),j=function(){function n(){this.count=0,this.clocks=[],this.ages=[],this.ucount=0,this.uclocks=[],this.uclockids=[]}return n}(),x=function(){function n(){this.count=0,this.clockcounts=[],this.clocks=[],this.ids=[]}return n}(),A=function(){function n(){this.items=[],this.count=0}return n.prototype.reset=function(){this.count=0},n.prototype.add=function(n){this.items[this.count++]=n},n.prototype.run=function(n){for(var t=this.items,e=0;e<this.count;e++)n(t[e]),t[e]=null;this.count=0},n}(),z={},C=0,R=1,q=2,B=new y(null),D=null,F=null,G=null,H=[],I=[],J=v(B,null,null);"object"==typeof module&&"object"==typeof module.exports?module.exports=m:"function"==typeof define?define([],function(){return m}):(eval||function(){})("this").S=m}();