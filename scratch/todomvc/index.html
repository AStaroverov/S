<!doctype html>
<html lang="en" data-framework="kjs">
	<head>
		<meta charset="utf-8">
		<title>K.js â€¢ TodoMVC</title>
		<link rel="stylesheet" href="todo.css">
	</head>
	<body>

    <script id="todo" type="text/kjs">
        function ToDo(title, completed) {
            this.title = K(title);
            this.completed = K(completed);
        }

	    var NEWLINE_KEY = 10,
            ENTER_KEY = 13,
	        ESCAPE_KEY = 27;

        function ToDosApp(todos) {
            var todoVMs = todos.K.map(ToDoVM),
                filter = K(null),
                completed = K(function () { return todoVMs().filter(function (t) { return t.completed(); }); }),
                remaining = K(function () { return todoVMs().filter(function (t) { return !t.completed(); }); }),
                filtered = K(function () { return filter() === null ? todoVMs() : filter() ? completed() : remaining(); });

            var app = {
                filter: filter,
                all: todoVMs,
                completed: completed,
                remaining: remaining,
                filtered: filtered,
                selected: K(null),
                completeAll: function (t) { if (t) remaining().forEach(function (t) { t.completed(true); })},
                clearCompleted: function () { todos(todos().filter(function (t) { return !t.completed(); })); },
                create: {
                    title: K(""),
                    keydown: function (e) {
                        if (e.keyCode === ESCAPE_KEY) {
                            app.create.title("");
                        } else if (e.keyCode === NEWLINE_KEY || e.keyCode === ENTER_KEY) {
                            if (app.create.title()) {
                                todos.unshift(new ToDo(app.create.title(), false));
                                app.create.title("");
                            }
                        }
                    }
                }
            };

            return app;

            function ToDoVM(todo) {
                var vm = {
                    completed: todo.completed,
                    title: K(todo.title()),
                    remove: function () { todos.remove(todo); },
                    select: function () { app.selected(vm); },
                    selected: K(function () { return app.selected() === vm; }),
                    deselect: function(commitChanges) {
                        if (commitChanges) {
                            todo.title(vm.title());
                        } else {
                            vm.title(todo.title());
                        }
                        if (vm.selected()) app.selected(null);
                    },
                    keydown: function ($event) {
                        if ($event.keyCode === 10 || $event.keyCode === 13) { // newline or return
                            vm.deselect(true);
                        } else if ($event.keyCode === 27) { // escape
                            vm.deselect(false);
                        }
                    }
                };

                return vm;
            }
        }

        function ToDosView(app) { return (
    		<section id="todoapp">
    			<header id="header">
    				<h1>todos</h1>
    				<input id="new-todo"
                           @value:keydown=app.create.title
                           @onkeydown=app.create.keydown
                           placeholder="What needs to be done?"
                           autofocus />
    			</header>
    			<section id="main" @hidden=(app.all().length === 0)>
    				<input id="toggle-all" type="checkbox" @checked=app.completeAll />
    				<label for="toggle-all">Mark all as complete</label>
    				<ul id="todo-list">
                        @app.filtered().map(function (todo) { return (
        					<li @class:completed=todo.completed()
                                @class:editing=todo.selected()>
        						<div class="view">
        							<input class="toggle"
                                           type="checkbox"
                                           @checked=todo.completed />
        							<label @ondblclick=todo.select>@todo.title()</label>
        							<button class="destroy" @onclick=todo.remove></button>
        						</div>
                                <input class="edit"
                                       @focus=todo.selected()
                                       @onblur=todo.deselect
                                       @onkeydown=todo.keydown
                                       @value:keydown=todo.title />
        					</li>
                        )})
    				</ul>
    			</section>
    			<footer id="footer" @hidden=!app.all().length>
    				<span id="todo-count">
                        <strong>@app.remaining().length</strong>
                        @(app.remaining().length === 1 ? "item" : "items")
                        left
                    </span>
    				<ul id="filters">
    					<li>
                            <a @class:selected=(app.filter() === null) @onclick=_.partial(app.filter, null)>All</a>
    					</li>
    					<li>
                            <a @class:selected=(app.filter() === false) @onclick=_.partial(app.filter, false)>Active</a>
    					</li>
    					<li>
                            <a @class:selected=(app.filter() === true) @onclick=_.partial(app.filter, true)>Completed</a>
    					</li>
    				</ul>
    				<button id="clear-completed" @hidden=!app.completed().length @onclick=app.clearCompleted>
    					Clear completed (@app.completed().length)
    				</button>
    			</footer>
    		</section>
    		<footer id="info">
    			<p>Double-click to edit a todo</p>
    			<p>Written by <a href="https://github.com/curveship">Adam Haile</a></p>
    			<p>Inspired by <a href="http://todomvc.com">TodoMVC</a></p>
    		</footer>
        )}

        function ToDoRouter(app) {
            var hash = window.location.hash,
                f = hash === "#active"    ? true  :
                    hash === "#completed" ? false :
                    null;

            app.filter(f);

            return K(function () {
                var f = app.filter(),
                    hash = f === true ? "active" :
                           f === false ? "completed" :
                           "";

                window.location.hash = hash;
            })
        }

        var todos = K([]),
            app = ToDosApp(todos),
            router = ToDoRouter(app),
            view = ToDosView(app);

        document.body.appendChild(view);
    </script>

    <script type="text/javascript" src="../../js/K.js"></script>
    <script type="text/javascript" src="../../js/K.rproc.js"></script>
    <script type="text/javascript" src="../../js/K.seq.spec.js"></script>
    <script type="text/javascript" src="../../js/K.DOM.js"></script>
    <script type="text/javascript" src="../../js/K.DOM.src.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.0.3/es5-shim.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>

    <script type="text/javascript">
        var todoEl = document.getElementById('todo');
        K.DOM.src.add(todoEl.textContent || todoEl.innerText || todoEl.innerHTML);
    </script>

</body>
</html>
