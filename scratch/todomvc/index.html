<!doctype html>
<html lang="en" data-framework="kjs">
	<head>
		<meta charset="utf-8">
		<title>K.js â€¢ TodoMVC</title>
		<link rel="stylesheet" href="todo.css">
	</head>
	<body>

    <script id="todo" type="text/kjs">
        "use strict";

        function ToDo(title, completed) {
            this.title = K(title);
            this.completed = K(completed);
        }

	    var NEWLINE_KEY = 10,
            ENTER_KEY = 13,
	        ESCAPE_KEY = 27;

        function ToDosApp(todos) {
            var todoVMs = todos.K.map(ToDoVM),
                filter = K(null),
                completed = K(function () { return todoVMs().filter(function (t) { return t.completed(); }); }),
                remaining = K(function () { return todoVMs().filter(function (t) { return !t.completed(); }); }),
                filtered = K(function () { return filter() === null ? todoVMs() : filter() ? completed() : remaining(); });

            var app = {
                filter: filter,
                all: todoVMs,
                completed: completed,
                remaining: remaining,
                filtered: filtered,
                editing: K(null),
                completeAll: function (t) { if (t) remaining().forEach(function (t) { t.completed(true); })},
                clearCompleted: function () { todos(todos().filter(function (t) { return !t.completed(); })); },
                template: {
                    title: K(""),
                    create: function () {
                        var title = app.template.title().trim();
                        if (title) {
                            todos.unshift(new ToDo(title, false));
                            app.template.title("");
                        }
                    }
                }
            };

            return app;

            function ToDoVM(todo) {
                var vm = {
                    completed: todo.completed,
                    title: K(todo.title()),
                    remove: function () { todos.remove(todo); },
                    startEditing: function () { app.editing(vm); },
                    editing: K(function () { return app.editing() === vm; }),
                    endEditing: function(commit) {
                        if (commit) todo.title(vm.title());
                        else vm.title(todo.title());
                        if (vm.editing()) app.editing(null);
                    }
                };

                return vm;
            }
        }

        function ToDosView(app) { return (
    		<section id="todoapp">
    			<header id="header">
    				<h1>todos</h1>
    				<input id = "new-todo"
                           placeholder = "What needs to be done?"
                           autofocus
                           @signal:keydown = app.template.title
                           @key:enter = app.template.create()
                           @key:esc = app.template.title('') />
    			</header>
    			<section id="main" hidden=(app.all().length === 0)>
    				<input id="toggle-all" type="checkbox" onchange=app.completeAll() />
    				<label for="toggle-all">Mark all as complete</label>
    				<ul id="todo-list">
                        @app.filtered().map(function (todo) { return (
        					<li @class:completed=todo.completed()
                                @class:editing=todo.editing()>
        						<div class="view">
        							<input class = "toggle"
                                           type = "checkbox"
                                           @signal = todo.completed />
        							<label ondblclick = todo.startEditing()>@todo.title()</label>
        							<button class="destroy" onclick=todo.remove()></button>
        						</div>
                                <input class = "edit"
                                       onblur = todo.endEditing(true)
                                       @signal:keydown = todo.title
                                       @key:enter = todo.endEditing(true)
                                       @key:esc = todo.endEditing(false)
                                       @focus = todo.editing() />
        					</li>
                        )})
    				</ul>
    			</section>
    			<footer id="footer" hidden=!app.all().length>
    				<span id="todo-count">
                        <strong>@app.remaining().length</strong>
                        @(app.remaining().length === 1 ? "item" : "items")
                        left
                    </span>
    				<ul id="filters">
    					<li>
                            <a @class:selected=(app.filter() === null) onclick=app.filter(null)>All</a>
    					</li>
    					<li>
                            <a @class:selected=(app.filter() === false) onclick=app.filter(false)>Active</a>
    					</li>
    					<li>
                            <a @class:selected=(app.filter() === true) onclick=app.filter(true)>Completed</a>
    					</li>
    				</ul>
    				<button id="clear-completed" hidden=(app.completed().length === 0) onclick=app.clearCompleted()>
    					Clear completed (@app.completed().length)
    				</button>
    			</footer>
    		</section>
    		<footer id="info">
    			<p>Double-click to edit a todo</p>
    			<p>Written by <a href="https://github.com/curveship">Adam Haile</a></p>
    			<p>Inspired by <a href="http://todomvc.com">TodoMVC</a></p>
    		</footer>
        )}

        function ToDoRouter(app) {
            var hash = window.location.hash,
                f = hash === "#active"    ? true  :
                    hash === "#completed" ? false :
                    null;

            app.filter(f);

            return K(function () {
                var f = app.filter(),
                    hash = f === true ? "active" :
                           f === false ? "completed" :
                           "";

                window.location.hash = hash;
            })
        }

        var todos = K([]),
            app = ToDosApp(todos),
            router = ToDoRouter(app),
            view = ToDosView(app);

        document.body.appendChild(view);
    </script>

    <script type="text/javascript" src="../../js/K.js"></script>
    <script type="text/javascript" src="../../js/K.rproc.js"></script>
    <script type="text/javascript" src="../../js/K.seq.spec.js"></script>
    <script type="text/javascript" src="../../js/K.DOM.js"></script>
    <script type="text/javascript" src="../../js/K.DOM.src.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.0.3/es5-shim.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>

    <script type="text/javascript">
        var todoEl = document.getElementById('todo');
        K.DOM.src.add(todoEl.textContent || todoEl.innerText || todoEl.innerHTML);
    </script>

</body>
</html>
