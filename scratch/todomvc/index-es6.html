<!doctype html>
<html lang="en" data-framework="kjs">
	<head>
		<meta charset="utf-8">
		<title>K.js â€¢ TodoMVC</title>
		<link rel="stylesheet" href="todo.css">
	</head>
	<body>

    <script id="todo" type="text/kjs">
        "use strict";

        function ToDo(title, completed) {
            this.title = K(title);
            this.completed = K(completed);
        }

        function ToDosApp(todos) {
            var editing = K(null),
				todoVMs = todos.K.map(ToDoVM),
                filter = K(null),
                completed = K(() => todoVMs().filter(t => t.completed())),
                remaining = K(() => todoVMs().filter(t => !t.completed())),
                filtered = K(() => filter() === null ? todoVMs() : filter() ? completed() : remaining());

            var app = {
                filter: filter,
                all: todoVMs,
                completed: completed,
                remaining: remaining,
                filtered: filtered,
                completeAll: () => remaining().forEach(t => t.completed(true)),
                clearCompleted: () => todos(remaining()),
                template: {
                    title: K(""),
                    create: () => {
                        var title = app.template.title().trim();
                        if (title) {
                            todos.unshift(new ToDo(title, false));
                            app.template.title("");
                        }
                    }
                }
            };

            return app;

            function ToDoVM(todo) {
                var vm = {
                    completed: todo.completed,
                    title: K(K.peek(todo.title)),
                    remove: () => todos.remove(todo),
                    startEditing: () => editing(vm),
                    editing: K(() => editing() === vm),
                    endEditing: (commit) => {
                        if (commit) todo.title(vm.title());
                        else vm.title(todo.title());
                        if (vm.editing()) editing(null);
                    }
                };

                return vm;
            }
        }

        var ToDosView = app =>
    		<section id = "todoapp">
    			<header id = "header">
    				<h1>todos</h1>
    				<input id = "new-todo"
                           placeholder = "What needs to be done?"
                           autofocus
                           @signal:keydown = app.template.title
                           @key:enter = app.template.create()
                           @key:esc = app.template.title('') />
    			</header>
    			<section id = "main" hidden = (app.all().length === 0)>
    				<input id = "toggle-all" type = "checkbox" onchange = app.completeAll() />
    				<label for = "toggle-all">Mark all as complete</label>
    				<ul id = "todo-list">
                        @app.filtered().map(todo =>
        					<li @class:completed = todo.completed()
                                @class:editing = todo.editing()>
        						<div class = "view">
        							<input class = "toggle"
                                           type = "checkbox"
                                           @signal = todo.completed />
        							<label ondblclick = todo.startEditing()>@todo.title()</label>
        							<button class = "destroy" onclick = todo.remove()></button>
        						</div>
                                <input class = "edit"
                                       onblur = todo.endEditing(true)
                                       @signal:keydown = todo.title
                                       @key:enter = todo.endEditing(true)
                                       @key:esc = todo.endEditing(false)
                                       @focus = todo.editing() />
        					</li>
						)
    				</ul>
    			</section>
    			<footer id = "footer" hidden = !app.all().length>
    				<span id = "todo-count">
                        <strong>@app.remaining().length</strong>
                        @(app.remaining().length === 1 ? "item" : "items")
                        left
                    </span>
    				<ul id = "filters">
    					<li>
                            <a @class:selected = (app.filter() === null) onclick = app.filter(null)>All</a>
    					</li>
    					<li>
                            <a @class:selected = (app.filter() === false) onclick = app.filter(false)>Active</a>
    					</li>
    					<li>
                            <a @class:selected = (app.filter() === true) onclick = app.filter(true)>Completed</a>
    					</li>
    				</ul>
    				<button id = "clear-completed" hidden = (app.completed().length === 0) onclick = app.clearCompleted()>
    					Clear completed (@app.completed().length)
    				</button>
    			</footer>
    		</section>
    		<footer id = "info">
    			<p>Double-click to edit a todo</p>
    			<p>Written by <a href = "https://github.com/curveship">Adam Haile</a></p>
    			<p>Inspired by <a href = "http://todomvc.com">TodoMVC</a></p>
    		</footer>

        function ToDosRouter(app) {
            var hash = window.location.hash,
                f = hash === "#completed" ? true  :
                    hash === "#active"    ? false :
                    null;

            app.filter(f);

            return K(() => {
                var f = app.filter(),
                    hash = f === true  ? "completed" :
                           f === false ? "active"    :
                           "";

                window.location.hash = hash;
            })
        }

		/*
		Router({
			"#(?<filter>completed|active|)$" : { when: () => !app.editing(), exec: () => app.editing(null) }
			"#(?<filter>completed|active|)/(?<editing>\d+)$" : { when: () => app.editing() }
		},{
			filter: app.filter,
			editing: app.editing
		});
		*/

		function ToDosRepository() {
			var json = localStorage.getItem('todos'),
				data = json ? JSON.parse(json) : [],
				todos = K(data.map(d => new ToDo(d.title, d.completed)));
			K(()=>
				localStorage.setItem('todos', K.toJSON(todos))
			);
			return todos;
		}

        var todos = ToDosRepository(),
            app = ToDosApp(todos),
            router = ToDosRouter(app),
            view = ToDosView(app);

        document.body.appendChild(view);
    </script>

    <script type="text/javascript" src="../../js/K.js"></script>
    <script type="text/javascript" src="../../js/K.rproc.js"></script>
    <script type="text/javascript" src="../../js/K.seq.spec.js"></script>
    <script type="text/javascript" src="../../js/K.DOM.js"></script>
	<script type="text/javascript" src="../../js/K.DOM.src.js"></script>
	<script type="text/javascript" src="../../js/K.toJSON.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.0.3/es5-shim.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>

    <script type="text/javascript">
        var todoEl = document.getElementById('todo');
        K.DOM.src.add(todoEl.textContent || todoEl.innerText || todoEl.innerHTML);
    </script>

</body>
</html>
