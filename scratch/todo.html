<html>
<head>
    <title>Todo MVC in K.js</title>
    <style>
        ul.todos {
            list-style: none;
            width: 200px;
        }
        li.todo input[type="checkbox"] {
            width: 32px;
            margin: 0px 0px 0px -36px;
            padding: 0px;
        }
        li.todo label {
            display: inline-block;
            width: 180px;
        }
        li.todo a {
            float: 20px;
        }
        li.todo input[type="text"] {
            width: 200px;
        }
        li.todo.unselected input[type="text"] { display: none; }
        li.todo.selected input[type="checkbox"] { display: none; }
        li.todo.selected label { display: none; }
        li.todo a { display: none; }
        li.todo.unselected:hover a { display: inline; }
        li.todo a:hover { font-weight: bold; }
    </style>
</head>
<body>

    <script id="todo" type="text/kjs">
        function ToDo(title, completed) {
            this.title = K(title);
            this.completed = K(completed);
        }

        function ToDosApp(todos) {
            var todoVMs = todos.K.map(ToDoVM);

            var app = {
                filter: K(null),
                filteredTodos: K(function () {
                    return todoVMs().filter(function (t) { return app.filter() === null || t.completed() === app.filter(); });
                }),
                incompleteCount: K(function () {
                    return todos().filter(function (t) { return !t.completed(); }).length;
                }),
                selected: K(null),
                completeAll: function () { todos().forEach(function (t) { t.completed() || t.completed(true); })},
                create: {
                    title: K(""),
                    keydown: function ($event) {
                        if ($event.keyCode === 27) { // escape
                            app.create.title("");
                        } else if ($event.keyCode === 10 || $event.keyCode === 13) { // newline or return
                            if (app.create.title()) {
                                todos.unshift(new ToDo(app.create.title(), false));
                                app.create.title("");
                            }
                        }
                    }
                }
            };

            return app;

            function ToDoVM(todo) {
                var vm = {
                    completed: todo.completed,
                    title: K(todo.title()),
                    remove: function () { todos.remove(todo); },
                    select: function () { app.selected(vm); },
                    selected: K(function () { return app.selected() === vm; }),
                    deselect: function(commitChanges) {
                        if (commitChanges) {
                            todo.title(vm.title());
                        } else {
                            vm.title(todo.title());
                        }
                        if (vm.selected()) app.selected(null);
                    },
                    keydown: function ($event) {
                        if ($event.keyCode === 10 || $event.keyCode === 13) { // newline or return
                            vm.deselect(true);
                        } else if ($event.keyCode === 27) { // escape
                            vm.deselect(false);
                        }
                    }
                };

                return vm;
            }
        }

        function ToDosView(app) { return (
            <ul class="todos">
                <li>
                    <input type="text"
                           placeholder="What needs to be done?"
                           @value:keydown=app.create.title
                           @on:keydown=app.create.keydown />
                </li>
                @app.filteredTodos().map(function (todo) { return (
                    <li class="todo"
                        @class:selected:unselected=todo.selected()
                        @class:completed:incomplete=todo.completed()
                        @on:dblclick=todo.select >
                        <input @checked=todo.completed type="checkbox" />
                        <label>@todo.title()</label>
                        <a @on:click=todo.remove >&times;</a>
                        <input type="text"
                               @hidden=!todo.selected()
                               @focus=todo.selected()
                               @on:blur=todo.deselect
                               @on:keydown=todo.keydown
                               @value:keydown=todo.title />
                    </li>
                )})
            </ul>
            <p>
                @(app.incompleteCount() > 1   ? app.incompleteCount() + " items" :
                  app.incompleteCount() === 1 ? "1 item" :
                  'no items') left
            </p>
            <p>
                  <a @on:click=_.partial(app.filter, null)>All</a>
                | <a @on:click=_.partial(app.filter, false)>Active</a>
                | <a @on:click=_.partial(app.filter, true)>Completed</a>
            </p>
            <p>
                <a @on:click=app.completeAll>Complete All</a>
            </p>
        )}

        function ToDoRouter(app) {
            var hash = window.location.hash,
                f = hash === "#active"    ? true  :
                    hash === "#completed" ? false :
                    null;

            app.filter(f);

            return K(function () {
                var f = app.filter(),
                    hash = f === true ? "active" :
                           f === false ? "completed" :
                           "";

                window.location.hash = hash;
            })
        }

        var todos = K([]),
            app = ToDosApp(todos),
            router = ToDoRouter(app),
            view = ToDosView(app);

        document.body.appendChild(view);
    </script>

    <script type="text/javascript" src="../js/K.js"></script>
    <script type="text/javascript" src="../js/K.rproc.js"></script>
    <script type="text/javascript" src="../js/K.seq.spec.js"></script>
    <script type="text/javascript" src="../js/K.DOM.js"></script>
    <script type="text/javascript" src="../js/K.DOM.src.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.0.3/es5-shim.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>

    <script type="text/javascript">
        var todoEl = document.getElementById('todo');
        K.DOM.src.add(todoEl.textContent || todoEl.innerText || todoEl.innerHTML);
    </script>

</body>
</html>
