<html>
<head>
    <title>Todo MVC in K.js</title>
    <style>
        ul.todos {
            list-style: none;
            width: 200px;
        }
        li.todo input[type="checkbox"] {
            width: 32px;
            margin: 0px 0px 0px -36px;
            padding: 0px;
        }
        li.todo label {
            display: inline-block;
            width: 180px;
        }
        li.todo a {
            float: 20px;
        }
        li.todo input[type="text"] {
            width: 200px;
        }
        li.todo.unselected input[type="text"] { display: none; }
        li.todo.selected input[type="checkbox"] { display: none; }
        li.todo.selected label { display: none; }
        li.todo a { display: none; }
        li.todo.unselected:hover a { display: inline; }
        li.todo a:hover { font-weight: bold; }
    </style>
</head>
<body>

    <script id="todo" type="text/kjs">
        function ToDo(title, completed) {
            this.title = K(title);
            this.completed = K(completed);
        }

        function ToDosApp(todos) {
            var todoVMs = todos.K.map(ToDoVM);

            var app = {
                filter: K(null),
                filteredTodos: K(function () {
                    return todoVMs().filter(function (t) { return app.filter() === null || t.completed() === app.filter(); });
                }),
                incompleteCount: K(function () {
                    return todos().filter(function (t) { return !t.completed(); }).length;
                }),
                selected: K(null),
                completeAll: function () { todos().forEach(function (t) { t.completed() || t.completed(true); })},
                create: {
                    title: K(""),
                    keydown: function ($event) {
                        if ($event.keyCode === 27) { // escape
                            app.create.title("");
                        } else if ($event.keyCode === 10 || $event.keyCode === 13) { // newline or return
                            if (app.create.title()) {
                                todos.unshift(new ToDo(app.create.title(), false));
                                app.create.title("");
                            }
                        }
                    }
                }
            };

            return app;

            function ToDoVM(todo) {
                var vm = {
                    completed: todo.completed,
                    title: K(todo.title()),
                    remove: function () { todos.remove(todo); },
                    select: function () {
                        app.selected(vm);
                        if (vm.$.input()) vm.$.input().focus();
                    },
                    selected: K(function () {
                        return app.selected() === vm;
                    }),
                    deselect: function(commitChanges) {
                        if (commitChanges) {
                            todo.title(vm.title());
                        } else {
                            vm.title(todo.title());
                        }
                        if (vm.selected()) app.selected(null);
                    },
                    keydown: function ($event) {
                        if ($event.keyCode === 10 || $event.keyCode === 13) { // newline or return
                            vm.deselect(true);
                        } else if ($event.keyCode === 27) { // escape
                            vm.deselect(false);
                        }
                    },
                    $: {
                        input: K(null)
                    }
                };

                return vm;
            }
        }

        K.DOM.directives.bind(["keydown"], el, val)
        K.DOM.attribute(["text"], el, val)
        K.DOM.property(["value"], el, val)

        function ToDosView(app) { return (
            <ul class="todos">
                <li>
                    <input type="text"
                           placeholder="What needs to be done?"
                           @bind(app.create.title, 'keydown')
                           onkeydown=app.create.keydown($event)
                           @on('keydown', e => app.create.keydown(e) />
                </li>
                @app.filteredTodos().map(function (todo) { return (
                    <li class="todo"
                        @class("selected", todo.selected())
                        @class("completed", todo.completed())
                        @on("dblclick", e => todo.select() >
                        <input @bind(todo.completed) type="checkbox" />
                        <label>@todo.title</label>
                        <a @on("click", e => todo.remove())>&times;</a>
                        <input type="text"
                           @show(todo.selected())
                           hidden = !todo.selected()
                           @($element.hidden = !todo.selected())
                           @bind(todo.title, 'keydown')
                           @focus(todo.selected())
                           @(todo.selected() && $element.focus())
                           @on('keydown', e => todo.keydown(e))
                           @on('blur', e => todo.deselect(true)) />
                    </li>
                )})
            </ul>
            <p>
                @(app.incompleteCount() > 1   ? app.incompleteCount() + " items" :
                  app.incompleteCount() === 1 ? "1 item" :
                  'no items') left
            </p>
            <p>
                  <a @on('click', e => app.filter(null))>All</a>
                | <a @on('click', function (e) { return app.filter(false) })>Active</a>
                | <a onclick=app.filter(true)>Completed</a>
            </p>
            <p>
                <a onclick="@app.completeAll()">Complete All</a>
            </p>
        )}

        function ToDoRouter(app) {
            var hash = window.location.hash,
                f = hash === "#active"    ? true  :
                    hash === "#completed" ? false :
                    null;

            app.filter(f);

            return K(function () {
                var f = app.filter(),
                    hash = f === true ? "active" :
                           f === false ? "completed" :
                           "";

                window.location.hash = hash;
            })
        }

        var todos = K([]),
            app = ToDosApp(todos),
            router = ToDoRouter(app),
            view = ToDosView(app);

        document.body.appendChild(view);
    </script>

    <script type="text/javascript" src="../js/K.js"></script>
    <script type="text/javascript" src="../js/K.rproc.js"></script>
    <script type="text/javascript" src="../js/K.seq.spec.js"></script>
    <script type="text/javascript" src="../js/K.DOM.js"></script>
    <script type="text/javascript" src="../js/K.DOM.template.js"></script>
    <script type="text/javascript" src="../js/K.DOM.src.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.0.3/es5-shim.min.js"></script>

    <script type="text/javascript">
        var todoEl = document.getElementById('todo');
        K.DOM.src.add(todoEl.textContent || todoEl.innerText || todoEl.innerHTML);
    </script>

</body>
</html>
